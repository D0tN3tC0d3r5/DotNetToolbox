---------------------------------------------------------------------------------------- 
Domain\GlobalUsings.cs 
global using System.ComponentModel.DataAnnotations;

global using DotNetToolbox;
global using DotNetToolbox.AI.Common;
global using DotNetToolbox.Collections.Generic;

global using Sophia.Models.Common;
global using Sophia.Models.Personas;
global using Sophia.Models.Tools;
global using Sophia.Models.Worlds;
 
---------------------------------------------------------------------------------------- 
Domain\Models\Common\FactData.cs 
namespace Sophia.Models.Common;

public class FactData {
    public int Id { get; set; }
    [MaxLength(250)]
    public string? DefaultText { get; set; }
    [Required(AllowEmptyStrings = false)]
    [MaxLength(250)]
    public string ValueTemplate { get; set; } = "{0}";
    public string? Value { get; set; }

    public Fact ToModel()
        => new() {
            Value = Value,
            ValueTemplate = ValueTemplate,
            DefaultText = DefaultText ?? string.Empty,
        };

    public string? Validate() {
        var valuePlaceholderCount = ValueTemplate.Split("{0}").Length - 1;
        return valuePlaceholderCount != 1 ? "The value template must contain exactly one value placeholder (\"{0}\")." : null;
    }

    public override string ToString()
        => Value is null
               ? DefaultText?? string.Empty
               : string.Format(ValueTemplate, Value);
}
 
---------------------------------------------------------------------------------------- 
Domain\Models\Personas\PersonaData.cs 
namespace Sophia.Models.Personas;

public class PersonaData {
    public int Id { get; set; }
    [Required(ErrorMessage = "Name is required.")]
    [MinLength(3, ErrorMessage = "Name must be at least 3 characters long.")]
    [MaxLength(100, ErrorMessage = "Name cannot exceed 100 characters.")]
    public string Name { get; set; } = "Agent";
    [MaxLength(1000, ErrorMessage = "Description cannot exceed 1000 characters.")]
    public string Description { get; set; } = "You are a helpful agent.";
    [MaxLength(1000, ErrorMessage = "Personality cannot exceed 1000 characters.")]
    public string? Personality { get; set; }
    public List<string> Instructions { get; set; } = [];
    public List<FactData> Facts { get; set; } = [];
    public List<ToolData> KnownTools { get; set; } = [];

    public string? ValidateInstructions()
        => Instructions.Any(string.IsNullOrWhiteSpace)
               ? "Instructions cannot contain empty or whitespace strings."
               : Instructions.Count != Instructions.Distinct().Count()
                   ? "Instructions cannot contain duplicated values."
                   : null;
}
 
---------------------------------------------------------------------------------------- 
Domain\Models\Tools\ArgumentData.cs 
namespace Sophia.Models.Tools;

public class ArgumentData {
    [Required(ErrorMessage = "Name is required.")]
    [MinLength(2, ErrorMessage = "Name must be at least 2 characters long.")]
    [MaxLength(100, ErrorMessage = "Name cannot exceed 100 characters.")]
    [RegularExpression(@"^[a-zA-Z0-9_-]+$", ErrorMessage = "Name can only contain letters, numbers, underscores, and hyphens.")]
    public string Name { get; set; } = string.Empty;
    public ArgumentType Type { get; set; }
    [MaxLength(1000, ErrorMessage = "Description cannot exceed 1000 characters.")]
    public string? Description { get; set; }
    public List<string> Choices { get; set; } = [];
    public bool IsRequired { get; set; }

    public Argument ToModel(int index)
        => new() {
            Index = index,
            Name = Name,
            Type = Type,
            Description = Description,
            Options = [.. Choices],
            IsRequired = IsRequired,
        };

    // ReSharper disable ConvertIfStatementToSwitchStatement
    // ReSharper disable ConvertIfStatementToReturnStatement
    [System.Diagnostics.CodeAnalysis.SuppressMessage("Style", "IDE0046:Convert to conditional expression", Justification = "<Pending>")]
    public string? ValidateChoices() {
        if (Type != ArgumentType.Enum) return null;
        if (Choices.Count == 0) return "Choices cannot be empty when the argument type is Enum.";
        if (Choices.Count > 20) return "The maximum number of choices allowed is 20.";
        if (Choices.Count != Choices.Distinct().Count()) return "Choices must be unique within the same tool.";
        if (Choices.Any(string.IsNullOrWhiteSpace)) return "Choices cannot contain empty or whitespace strings.";
        if (Choices.Any(choice => choice.Length > 50)) return "Each choice cannot exceed 50 characters.";
        return null;
    }
    // ReSharper restore ConvertIfStatementToReturnStatement
    // ReSharper restore ConvertIfStatementToSwitchStatement
}
 
---------------------------------------------------------------------------------------- 
Domain\Models\Tools\ToolData.cs 
namespace Sophia.Models.Tools;

public class ToolData {
    public int Id { get; set; }
    [Required(ErrorMessage = "Name is required.")]
    [MinLength(2, ErrorMessage = "Name must be at least 2 characters long.")]
    [MaxLength(100, ErrorMessage = "Name cannot exceed 100 characters.")]
    [RegularExpression(@"^[a-zA-Z0-9][a-zA-Z0-9_-]+$", ErrorMessage = "Name can only start with a letter or a number, and can only contain letters, numbers, underscores, and hyphens.")]
    public string Name { get; set; } = string.Empty;
    [MaxLength(1000, ErrorMessage = "Description cannot exceed 1000 characters.")]
    public string? Description { get; set; }
    public List<ArgumentData> Arguments { get; set; } = [];

    public Tool ToModel()
        => new() {
            Id = Id,
            Name = Name,
            Description = Description,
            Arguments = Arguments.AsIndexed().ToList(x => x.Value.ToModel(x.Index)),

        };

    public string? ValidateSignature(IReadOnlyList<ToolData> existingTools)
        => existingTools.Any(t => t.Matches(this))
               ? "A tool with the same signature already exists."
               : null;

    private bool Matches(ToolData other)
        => Name == other.Name
        && Id != other.Id
        && Arguments.Select(a => a.Type).SequenceEqual(other.Arguments.Select(a => a.Type));
}
 
---------------------------------------------------------------------------------------- 
Domain\Models\Worlds\UserProfileData.cs 
namespace Sophia.Models.Worlds;

public class UserProfileData {
    [MaxLength(250)]
    public string? Name { get; set; }
    [MaxLength(50)]
    public string? Language { get; set; }

    public UserProfile ToModel() => new() {
        Name = Name,
        Language = Language,
    };
}
 
---------------------------------------------------------------------------------------- 
Domain\Models\Worlds\WorldData.cs 
namespace Sophia.Models.Worlds;

public class WorldData() {
    private readonly IDateTimeProvider _dateTime = DateTimeProvider.Default;

    public WorldData(IDateTimeProvider dateTime)
        : this() {
        _dateTime = dateTime;
    }

    public DateTimeOffset DateTime => _dateTime.Now;
    [MaxLength(1000)]
    public string? Location { get; set; }
    public UserProfileData UserProfile { get; set; } = new();
    public List<FactData> Facts { get; set; } = [];
    public List<ToolData> Tools { get; set; } = [];

    public World ToModel(IDateTimeProvider? dateTime) => new(dateTime) {
        Location = Location,
        UserProfile = UserProfile.ToModel(),
        Facts = Facts.ToList(x => x.ToModel()),
        AvailableTools = Tools.ToList(x => x.ToModel()),
    };
}
 
---------------------------------------------------------------------------------------- 
Domain\Services\IPersonasService.cs 
namespace Sophia.Services;

public interface IPersonasRemoteService : IPersonasService;
public interface IPersonasService {
    Task<IReadOnlyList<PersonaData>> GetList(string? filter = null);
    Task<PersonaData?> GetById(int id);
    Task Add(PersonaData persona);
    Task Update(PersonaData persona);
    Task Delete(int id);
}
 
---------------------------------------------------------------------------------------- 
Domain\Services\IToolsService.cs 
namespace Sophia.Services;

public interface IToolsRemoteService : IToolsService;
public interface IToolsService {
    Task<IReadOnlyList<ToolData>> GetList(string? filter = null);
    Task<ToolData?> GetById(int id);
    Task Add(ToolData selectedTool);
    Task Update(ToolData input);
    Task Delete(int id);
}
 
---------------------------------------------------------------------------------------- 
Domain\Services\IWorldService.cs 
namespace Sophia.Services;

public interface IWorldRemoteService : IWorldService;
public interface IWorldService {
    Task<WorldData> GetWorld();
    Task UpdateWorld(WorldData world);
}
 
---------------------------------------------------------------------------------------- 
WebApp\GlobalUsings.cs 
global using System.ComponentModel.DataAnnotations;
global using System.ComponentModel.DataAnnotations.Schema;
global using System.Diagnostics.CodeAnalysis;
global using System.Security.Claims;
global using System.Text.Json;

global using DotNetToolbox.AI.Anthropic;
global using DotNetToolbox.AI.Common;
global using DotNetToolbox.Collections.Generic;

global using Microsoft.AspNetCore.Authentication;
global using Microsoft.AspNetCore.Components;
global using Microsoft.AspNetCore.Components.Authorization;
global using Microsoft.AspNetCore.Components.Routing;
global using Microsoft.AspNetCore.Components.Server;
global using Microsoft.AspNetCore.Http.Extensions;
global using Microsoft.AspNetCore.Identity;
global using Microsoft.AspNetCore.Identity.EntityFrameworkCore;
global using Microsoft.AspNetCore.Identity.UI.Services;
global using Microsoft.AspNetCore.Mvc;
global using Microsoft.EntityFrameworkCore;
global using Microsoft.EntityFrameworkCore.ChangeTracking;
global using Microsoft.EntityFrameworkCore.Infrastructure;
global using Microsoft.EntityFrameworkCore.Metadata.Builders;
global using Microsoft.EntityFrameworkCore.Migrations;
global using Microsoft.Extensions.Options;
global using Microsoft.Extensions.Primitives;

global using Sophia.Models.Common;
global using Sophia.Models.Personas;
global using Sophia.Models.Tools;
global using Sophia.Models.Worlds;
global using Sophia.Services;
global using Sophia.WebApp.Components;
global using Sophia.WebApp.Components.Account;
global using Sophia.WebApp.Components.Account.Pages;
global using Sophia.WebApp.Components.Account.Pages.Manage;
global using Sophia.WebApp.Data;
global using Sophia.WebApp.Data.Common;
global using Sophia.WebApp.Data.Helpers;
global using Sophia.WebApp.Data.Personas;
global using Sophia.WebApp.Data.Tools;
global using Sophia.WebApp.Data.World;
global using Sophia.WebApp.Endpoints;
global using Sophia.WebApp.Services;
global using Sophia.WebClient.Services;

 
---------------------------------------------------------------------------------------- 
WebApp\Program.cs 
var builder = WebApplication.CreateBuilder(args);

// Add services to the container.
builder.Services.AddRazorComponents()
                .AddInteractiveServerComponents()
                .AddInteractiveWebAssemblyComponents();

builder.Services.AddCascadingAuthenticationState();
builder.Services.AddScoped<UserAccessor>();
builder.Services.AddScoped<Redirect>();
builder.Services.AddScoped<AuthenticationStateProvider, IdentityRevalidatingAuthenticationStateProvider>();

builder.Services.AddAuthorization();
builder.Services.AddAuthentication(options => {
    options.DefaultScheme = IdentityConstants.ApplicationScheme;
    options.DefaultSignInScheme = IdentityConstants.ExternalScheme;
}).AddIdentityCookies();

var connectionString = builder.Configuration.GetConnectionString("DefaultConnection")
                    ?? throw new InvalidOperationException("Connection string 'DefaultConnection' not found.");
builder.Services.AddDbContext<ApplicationDbContext>(options => {
    options.UseSqlServer(connectionString);
    options.EnableSensitiveDataLogging(builder.Environment.IsDevelopment());
    options.EnableDetailedErrors(builder.Environment.IsDevelopment());
    options.LogTo(Console.WriteLine, LogLevel.Information);
});
builder.Services.AddDatabaseDeveloperPageExceptionFilter();

builder.Services.AddIdentityCore<ApplicationUser>(options => options.SignIn.RequireConfirmedAccount = true)
    .AddEntityFrameworkStores<ApplicationDbContext>()
    .AddSignInManager()
    .AddDefaultTokenProviders();

builder.Services.AddSingleton<IEmailSender<ApplicationUser>, IdentityNoOpEmailSender>();

builder.Services.AddAnthropic(builder.Configuration);

builder.Services.AddScoped<IWorldService, WorldService>();
builder.Services.AddScoped<IToolsService, ToolsService>();
builder.Services.AddScoped<IPersonasService, PersonasService>();
builder.Services.AddScoped<IWorldRemoteService, WorldRemoteService>();
builder.Services.AddScoped<IToolsRemoteService, ToolsRemoteService>();
builder.Services.AddScoped<IPersonasRemoteService, PersonasRemoteService>();
builder.Services.AddScoped(sp => new HttpClient {
    BaseAddress = new(builder.Configuration["FrontendUrl"] ?? "https://localhost:7100"),
});

var app = builder.Build();

// Configure the HTTP request pipeline.
if (app.Environment.IsDevelopment()) {
    app.UseWebAssemblyDebugging();
    app.UseMigrationsEndPoint();
}
else {
    app.UseExceptionHandler("/Error", createScopeForErrors: true);
    // The default HSTS value is 30 days. You may want to change this for production scenarios, see https://aka.ms/aspnetcore-hsts.
    app.UseHsts();
}

app.UseHttpsRedirection();

await ApplicationDbContext.Seed(app.Services);

app.UseStaticFiles();
app.UseAntiforgery();

app.MapRazorComponents<App>()
   .AddInteractiveServerRenderMode()
   .AddInteractiveWebAssemblyRenderMode()
   .AddAdditionalAssemblies(typeof(Sophia.WebClient._Imports).Assembly); ;

app.MapIdentityEndpoints();
app.MapWorldEndpoints();
app.MapToolsEndpoints();
app.MapPersonasEndpoints();

await app.RunAsync();
 
---------------------------------------------------------------------------------------- 
WebApp\appsettings.Development.json 
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  }
}
 
---------------------------------------------------------------------------------------- 
WebApp\appsettings.json 
{
  "ConnectionStrings": {
    "DefaultConnection": "Server=(localdb)\\mssqllocaldb;Database=aspnet-Sophia.WebApp-549445d7-00f7-497f-ba23-21e8129c29db;Trusted_Connection=True;MultipleActiveResultSets=true"
  },
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*"
}
 
---------------------------------------------------------------------------------------- 
WebApp\libman.json 
{
  "version": "1.0",
  "defaultProvider": "cdnjs",
  "libraries": [
    {
      "library": "font-awesome@6.5.1",
      "destination": "wwwroot/lib/font-awesome/"
    },
    {
      "library": "bootstrap@5.3.3",
      "destination": "wwwroot/lib/bootstrap/"
    },
    {
      "library": "bootstrap-icons@1.11.3",
      "destination": "wwwroot/lib/bootstrap-icons/"
    }
  ]
} 
---------------------------------------------------------------------------------------- 
WebApp\Components\NavMenu.razor.cs 
namespace Sophia.WebApp.Components;

public partial class NavMenu : IDisposable {
    private string? _currentUrl;
    private bool _collapseNavMenu = false;

    private string? CollapseCssClass => _collapseNavMenu ? "collapsed" : null;
    //private string? NavMenuHeaderCssClass => _collapseNavMenu ? "collapse-header" : "collapse-header show";
    //private string? NavMenuItemsCssClass => _collapseNavMenu ? "collapse" : "collapse show";
    //private string? NavMenuItemCssClass => _collapseNavMenu ? "collapse-item" : "collapse-item show";

    [Inject]
    public required NavigationManager NavigationManager { get; set; }

    protected override void OnInitialized() {
        _currentUrl = NavigationManager.ToBaseRelativePath(NavigationManager.Uri);
        NavigationManager.LocationChanged += OnLocationChanged;
    }

    private void ToggleNavMenu() => _collapseNavMenu = !_collapseNavMenu;

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e) {
        _currentUrl = NavigationManager.ToBaseRelativePath(e.Location);
        StateHasChanged();
    }

    public void Dispose()
        => NavigationManager.LocationChanged -= OnLocationChanged;
}
 
---------------------------------------------------------------------------------------- 
WebApp\Components\App.razor 
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <base href="/" />
  <link rel="stylesheet" href="lib/font-awesome/css/all.min.css" async />
  <link rel="stylesheet" href="lib/bootstrap/css/bootstrap.min.css" async />
  <link rel="stylesheet" href="lib/bootstrap-icons/font/bootstrap-icons.min.css" async /> 
  <link rel="stylesheet" href="app.css" />
  <link rel="stylesheet" href="Sophia.WebApp.styles.css" />
  <link rel="icon" type="image/png" href="favicon.png" />
  <HeadOutlet />
</head>

<body>
  <Routes />
  <script src="lib/bootstrap/js/bootstrap.min.js"></script>
  <script src="_framework/blazor.web.js"></script>
</body>

</html>
 
---------------------------------------------------------------------------------------- 
WebApp\Components\NavMenu.razor 
@rendermode InteractiveServer

<div class="sidebar @CollapseCssClass">
  <div class="top-row navbar navbar-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="">
        <i class="bi bi-app" aria-hidden="true"></i>
        <span>Sophia</span>
      </a>
      <button class="navbar-toggler" @onclick="ToggleNavMenu" title="Navigation menu">
        <i class="bi bi-list"></i>
      </button>
    </div>
  </div>

  <nav class="flex-column">
    <div class="nav-item">
      <NavLink class="nav-link" href="" Match="NavLinkMatch.All">
        <i class="bi bi-house-door-fill" aria-hidden="true"></i>
        <span>Home</span>
      </NavLink>
    </div>
    <div class="nav-item">
      <NavLink class="nav-link" href="Personas">
        <i class="bi bi-people" aria-hidden="true"></i>
        <span>Personas</span>
      </NavLink>
    </div>
    <div class="nav-item">
      <NavLink class="nav-link" href="Settings">
        <i class="bi bi-gear-fill" aria-hidden="true"></i>
        <span>Settings</span>
      </NavLink>
    </div>

    <AuthorizeView>
      <Authorized>
        <div class="nav-item">
          <NavLink class="nav-link" href="Account/Manage">
            <i class="bi bi-person-fill" aria-hidden="true"></i>
            <span>@context.User.Identity?.Name</span>
          </NavLink>
        </div>
        <div class="nav-item">
          <form action="Account/Logout" method="post">
            <AntiforgeryToken />
            <input type="hidden" name="ReturnUrl" value="@_currentUrl" />
            <button type="submit" class="nav-link">
              <i class="bi bi-arrow-bar-left" aria-hidden="true"></i>
              <span>Logout</span>
            </button>
          </form>
        </div>
      </Authorized>
      <NotAuthorized>
        <div class="nav-item">
          <NavLink class="nav-link" href="Account/Register">
            <i class="bi bi-person" aria-hidden="true"></i>
            <span>Register</span>
          </NavLink>
        </div>
        <div class="nav-item">
          <NavLink class="nav-link" href="Account/Login">
            <i class="bi bi-person-badge" aria-hidden="true"></i>
            <span>Login</span>
          </NavLink>
        </div>
      </NotAuthorized>
    </AuthorizeView>
  </nav>
</div>
 
---------------------------------------------------------------------------------------- 
WebApp\Components\Routes.razor 
<Router AppAssembly="typeof(Program).Assembly" AdditionalAssemblies="new[] { typeof(WebClient._Imports).Assembly }">
    <Found Context="routeData">
        <AuthorizeRouteView RouteData="routeData" DefaultLayout="typeof(Layout.MainLayout)">
            <NotAuthorized>
                <RedirectToLogin />
            </NotAuthorized>
        </AuthorizeRouteView>
        <FocusOnNavigate RouteData="routeData" Selector="h1" />
    </Found>
</Router>
 
---------------------------------------------------------------------------------------- 
WebApp\Components\_Imports.razor 
@using System.Text
@using System.ComponentModel.DataAnnotations
@using System.Diagnostics
@using System.Globalization
@using System.Net.Http
@using System.Net.Http.Json
@using System.Security.Claims
@using System.Text.Encodings.Web

@using Microsoft.AspNetCore.Authentication
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Routing
@using Microsoft.AspNetCore.Components.Web
@using static Microsoft.AspNetCore.Components.Web.RenderMode
@using Microsoft.AspNetCore.Components.Web.Virtualization
@using Microsoft.AspNetCore.Http.Features
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.WebUtilities
@using Microsoft.JSInterop

@using Sophia.WebApp
@using Sophia.WebApp.Components
@using Sophia.WebApp.Components.Account.Shared
@using Sophia.WebApp.Data
 
---------------------------------------------------------------------------------------- 
WebApp\Components\NavMenu.razor.css 
.sidebar {
  background-image: linear-gradient(180deg, rgb(5, 39, 103) 0%, #3a0647 70%);
}

.navbar-toggler {
  width: 3.5rem;
  padding: 4px;
  border: none;
}

.top-row {
  height: 3.5rem;
  background-color: rgba(0, 0, 0, 0.4);
}

.navbar-brand {
  align-items: center;
  font-size: 1.1rem;
}

.bi {
  width: 32px;
  height: 32px;
  padding: 6px;
  font-size: 1.25rem;
  color: white;
  display: inline-flex;
}

.collapsed nav {
  display: none;
}

.nav-item {
  font-size: 0.9rem;
  padding-top: 0.5rem;
  padding-bottom: 0.5rem;
}

  .nav-item:first-of-type {
    padding-top: 1rem;
  }

  .nav-item:last-of-type {
    padding-bottom: 1rem;
  }

  .nav-item ::deep .nav-link {
    color: #d7d7d7;
    background: none;
    padding: 4px;
    border: none;
    height: 3rem;
    display: flex;
    align-items: center;
    line-height: 3rem;
    width: 100%;
  }

  .nav-item ::deep span {
    margin-left: 0.75rem;
  }

  .nav-item ::deep a.active {
    background-color: rgba(255, 255, 255, 0.37);
    color: white;
  }

  .nav-item ::deep .nav-link:hover {
    background-color: rgba(255, 255, 255, 0.1);
    color: white;
  }

@media (min-width: 641px) {
  .sidebar {
    width: 250px;
    height: 100vh;
    position: sticky;
    top: 0;
  }

  .collapsed {
    width: 4rem;
  }

    .collapsed .top-row {
      justify-content: center;
      padding: 0;
    }

    .collapsed .container-fluid {
      padding: 0;
    }

    .collapsed .navbar-brand {
      display: none;
    }

    .collapsed ::deep .bi {
      margin: 0 auto;
    }

    .collapsed ::deep span {
      display: none;
    }

    .collapsed nav {
      display: block;
      width: 4rem;
      overflow-y: auto;
      transition: width 0.3s ease-in-out;
    }

      .collapsed nav .nav-item ::deep .nav-link {
        justify-content: center;
        width: 3.5rem;
      }
}
 
---------------------------------------------------------------------------------------- 
WebApp\Components\Account\EndpointRouteBuilderExtensions.cs 
namespace Sophia.WebApp.Components.Account;
internal static class EndpointRouteBuilderExtensions {
    // These endpoints are required by the Identity Razor components defined in the /Components/Account/Pages directory of this project.
    public static IEndpointConventionBuilder MapIdentityEndpoints(this IEndpointRouteBuilder endpoints) {
        ArgumentNullException.ThrowIfNull(endpoints);

        var accountGroup = endpoints.MapGroup("/Account");

        accountGroup.MapPost("/PerformExternalLogin", (
            HttpContext context,
            [FromServices] SignInManager<ApplicationUser> signInManager,
            [FromForm] string provider,
            [FromForm] string returnUrl) => {
                IEnumerable<KeyValuePair<string, StringValues>> query = [
                    new("ReturnUrl", returnUrl),
                new("PageAction", ExternalLogin._loginCallbackAction)];

                var redirectUrl = UriHelper.BuildRelative(
                    context.Request.PathBase,
                    "/Account/ExternalLogin",
                    QueryString.Create(query));

                var properties = signInManager.ConfigureExternalAuthenticationProperties(provider, redirectUrl);
                return TypedResults.Challenge(properties, [provider]);
            });

        accountGroup.MapPost("/Logout", async (
            ClaimsPrincipal user,
            SignInManager<ApplicationUser> signInManager,
            [FromForm] string returnUrl) => {
                await signInManager.SignOutAsync();
                return TypedResults.LocalRedirect($"~/{returnUrl}");
            });

        var manageGroup = accountGroup.MapGroup("/Manage").RequireAuthorization();

        manageGroup.MapPost("/LinkExternalLogin", async (
            HttpContext context,
            [FromServices] SignInManager<ApplicationUser> signInManager,
            [FromForm] string provider) => {
                // Clear the existing external cookie to ensure a clean login process
                await context.SignOutAsync(IdentityConstants.ExternalScheme);

                var redirectUrl = UriHelper.BuildRelative(
                    context.Request.PathBase,
                    "/Account/Manage/ExternalLogins",
                    QueryString.Create("PageAction", ExternalLogins._linkLoginCallbackAction));

                var properties = signInManager.ConfigureExternalAuthenticationProperties(provider, redirectUrl, signInManager.UserManager.GetUserId(context.User));
                return TypedResults.Challenge(properties, [provider]);
            });

        var loggerFactory = endpoints.ServiceProvider.GetRequiredService<ILoggerFactory>();
        var downloadLogger = loggerFactory.CreateLogger("DownloadPersonalData");

        manageGroup.MapPost("/DownloadPersonalData", async (
            HttpContext context,
            [FromServices] UserManager<ApplicationUser> userManager,
            [FromServices] AuthenticationStateProvider authenticationStateProvider) => {
                var user = await userManager.GetUserAsync(context.User);
                if (user is null) {
                    return Results.NotFound($"Unable to load user with ID '{userManager.GetUserId(context.User)}'.");
                }

                var userId = await userManager.GetUserIdAsync(user);
                downloadLogger.LogInformation("User with ID '{UserId}' asked for their personal data.", userId);

                // Only include personal data for download
                var personalData = new Dictionary<string, string>();
                var personalDataProps = typeof(ApplicationUser).GetProperties().Where(
                    prop => Attribute.IsDefined(prop, typeof(PersonalDataAttribute)));
                foreach (var p in personalDataProps) {
                    personalData.Add(p.Name, p.GetValue(user)?.ToString() ?? "null");
                }

                var logins = await userManager.GetLoginsAsync(user);
                foreach (var l in logins) {
                    personalData.Add($"{l.LoginProvider} external login provider key", l.ProviderKey);
                }

                personalData.Add("Authenticator Key", (await userManager.GetAuthenticatorKeyAsync(user))!);
                var fileBytes = JsonSerializer.SerializeToUtf8Bytes(personalData);

                context.Response.Headers.TryAdd("Content-Disposition", "attachment; filename=PersonalData.json");
                return TypedResults.File(fileBytes, contentType: "application/json", fileDownloadName: "PersonalData.json");
            });

        return accountGroup;
    }
}
 
---------------------------------------------------------------------------------------- 
WebApp\Components\Account\IdentityNoOpEmailSender.cs 
namespace Sophia.WebApp.Components.Account;
// Remove the "else if (EmailSender is IdentityNoOpEmailSender)" block from RegisterConfirmation.razor after updating with a real implementation.
internal sealed class IdentityNoOpEmailSender : IEmailSender<ApplicationUser> {
    [SuppressMessage("Performance", "CA1859:Use concrete types when possible for improved performance", Justification = "<Pending>")]
    private readonly IEmailSender _emailSender = new NoOpEmailSender();

    public Task SendConfirmationLinkAsync(ApplicationUser user, string email, string confirmationLink)
        => _emailSender.SendEmailAsync(email, "Confirm your email", $"Please confirm your account by <a href='{confirmationLink}'>clicking here</a>.");

    public Task SendPasswordResetLinkAsync(ApplicationUser user, string email, string resetLink)
        => _emailSender.SendEmailAsync(email, "Reset your password", $"Please reset your password by <a href='{resetLink}'>clicking here</a>.");

    public Task SendPasswordResetCodeAsync(ApplicationUser user, string email, string resetCode)
        => _emailSender.SendEmailAsync(email, "Reset your password", $"Please reset your password using the following code: {resetCode}");
}
 
---------------------------------------------------------------------------------------- 
WebApp\Components\Account\IdentityRevalidatingAuthenticationStateProvider.cs 
namespace Sophia.WebApp.Components.Account;
// This is a server-side AuthenticationStateProvider that revalidates the security stamp for the connected user
// every 30 minutes an interactive circuit is connected.
internal sealed class IdentityRevalidatingAuthenticationStateProvider(
        ILoggerFactory loggerFactory,
        IServiceScopeFactory scopeFactory,
        IOptions<IdentityOptions> options)
    : RevalidatingServerAuthenticationStateProvider(loggerFactory) {
    protected override TimeSpan RevalidationInterval => TimeSpan.FromMinutes(30);

    protected override async Task<bool> ValidateAuthenticationStateAsync(
        AuthenticationState authenticationState, CancellationToken cancellationToken) {
        // GetList the user manager from a new scope to ensure it fetches fresh data
        await using var scope = scopeFactory.CreateAsyncScope();
        var userManager = scope.ServiceProvider.GetRequiredService<UserManager<ApplicationUser>>();
        return await ValidateSecurityStampAsync(userManager, authenticationState.User);
    }

    private async Task<bool> ValidateSecurityStampAsync(UserManager<ApplicationUser> userManager, ClaimsPrincipal principal) {
        var user = await userManager.GetUserAsync(principal);
        if (user is null) {
            return false;
        }
        else if (!userManager.SupportsUserSecurityStamp) {
            return true;
        }
        else {
            var principalStamp = principal.FindFirstValue(options.Value.ClaimsIdentity.SecurityStampClaimType);
            var userStamp = await userManager.GetSecurityStampAsync(user);
            return principalStamp == userStamp;
        }
    }
}
 
---------------------------------------------------------------------------------------- 
WebApp\Components\Account\Redirect.cs 
namespace Sophia.WebApp.Components.Account;
internal sealed class Redirect(NavigationManager navigationManager) {
    public const string StatusCookieName = "Identity.StatusMessage";

    private static readonly CookieBuilder _statusCookieBuilder = new() {
        SameSite = SameSiteMode.Strict,
        HttpOnly = true,
        IsEssential = true,
        MaxAge = TimeSpan.FromSeconds(5),
    };

    [DoesNotReturn]
    public void To(string? uri) {
        uri ??= "";

        // Prevent open redirects.
        if (!Uri.IsWellFormedUriString(uri, UriKind.Relative)) {
            uri = navigationManager.ToBaseRelativePath(uri);
        }

        // During static rendering, NavigateTo throws a NavigationException which is handled by the framework as a redirect.
        // So as long as this is called from a statically rendered Identity component, the InvalidOperationException is never thrown.
        navigationManager.NavigateTo(uri);
        throw new InvalidOperationException($"{nameof(Redirect)} can only be used during static rendering.");
    }

    [DoesNotReturn]
    public void To(string uri, Dictionary<string, object?> queryParameters) {
        var uriWithoutQuery = navigationManager.ToAbsoluteUri(uri).GetLeftPart(UriPartial.Path);
        var newUri = navigationManager.GetUriWithQueryParameters(uriWithoutQuery, queryParameters);
        To(newUri);
    }

    [DoesNotReturn]
    public void ToWithStatus(string uri, string message, HttpContext context) {
        context.Response.Cookies.Append(StatusCookieName, message, _statusCookieBuilder.Build(context));
        To(uri);
    }

    private string CurrentPath => navigationManager.ToAbsoluteUri(navigationManager.Uri).GetLeftPart(UriPartial.Path);

    [DoesNotReturn]
    public void ToCurrentPage() => To(CurrentPath);

    [DoesNotReturn]
    public void ToCurrentPageWithStatus(string message, HttpContext context)
        => ToWithStatus(CurrentPath, message, context);
}
 
---------------------------------------------------------------------------------------- 
WebApp\Components\Account\UserAccessor.cs 
namespace Sophia.WebApp.Components.Account;
internal sealed class UserAccessor(UserManager<ApplicationUser> userManager, Redirect redirect) {
    public async Task<ApplicationUser> GetRequiredUserAsync(HttpContext context) {
        var user = await userManager.GetUserAsync(context.User);

        if (user is null) {
            redirect.ToWithStatus("Account/InvalidUser", $"Error: Unable to load user with ID '{userManager.GetUserId(context.User)}'.", context);
        }

        return user;
    }
}
 
---------------------------------------------------------------------------------------- 
WebApp\Components\Account\Pages\AccessDenied.razor 
@page "/Account/AccessDenied"

<header>
    <h1 class="text-danger">Access denied</h1>
    <p class="text-danger">You do not have access to this resource.</p>
</header>
 
---------------------------------------------------------------------------------------- 
WebApp\Components\Account\Pages\ConfirmEmail.razor 
@page "/Account/ConfirmEmail"

@inject UserManager<ApplicationUser> UserManager
@inject Redirect Redirect

<h1>Confirm email</h1>
<StatusMessage Message="@_statusMessage" />

@code {
    private string? _statusMessage;

    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    [SupplyParameterFromQuery]
    private string? UserId { get; set; }

    [SupplyParameterFromQuery]
    private string? Code { get; set; }

    protected override async Task OnInitializedAsync()
    {
        if (UserId is null || Code is null)
        {
            Redirect.To("");
        }

        var user = await UserManager.FindByIdAsync(UserId);
        if (user is null)
        {
            HttpContext.Response.StatusCode = StatusCodes.Status404NotFound;
            _statusMessage = $"Error loading user with ID {UserId}";
        }
        else
        {
            var code = Encoding.UTF8.GetString(WebEncoders.Base64UrlDecode(Code));
            var result = await UserManager.ConfirmEmailAsync(user, code);
            _statusMessage = result.Succeeded ? "Thank you for confirming your email." : "Error confirming your email.";
        }
    }
}
 
---------------------------------------------------------------------------------------- 
WebApp\Components\Account\Pages\ConfirmEmailChange.razor 
@page "/Account/ConfirmEmailChange"

@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager
@inject Redirect Redirect

<h1>Confirm email change</h1>

<StatusMessage Message="@_message" />

@code {
    private string? _message;

    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    [SupplyParameterFromQuery]
    private string? UserId { get; set; }

    [SupplyParameterFromQuery]
    private string? Email { get; set; }

    [SupplyParameterFromQuery]
    private string? Code { get; set; }

    protected override async Task OnInitializedAsync()
    {
        if (UserId is null || Email is null || Code is null)
        {
            Redirect.ToWithStatus(
                "Account/Login", "Error: Invalid email change confirmation link.", HttpContext);
        }

        var user = await UserManager.FindByIdAsync(UserId);
        if (user is null)
        {
            _message = "Unable to find user with Id '{userId}'";
            return;
        }

        var code = Encoding.UTF8.GetString(WebEncoders.Base64UrlDecode(Code));
        var result = await UserManager.ChangeEmailAsync(user, Email, code);
        if (!result.Succeeded)
        {
            _message = "Error changing email.";
            return;
        }

        // In our UI email and user name are one and the same, so when we update the email
        // we need to update the user name.
        var setUserNameResult = await UserManager.SetUserNameAsync(user, Email);
        if (!setUserNameResult.Succeeded)
        {
            _message = "Error changing user name.";
            return;
        }

        await SignInManager.RefreshSignInAsync(user);
        _message = "Thank you for confirming your email change.";
    }
}
 
---------------------------------------------------------------------------------------- 
WebApp\Components\Account\Pages\ExternalLogin.razor 
@page "/Account/ExternalLogin"

@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager
@inject IUserStore<ApplicationUser> UserStore
@inject IEmailSender<ApplicationUser> EmailSender
@inject NavigationManager NavigationManager
@inject Redirect Redirect
@inject ILogger<ExternalLogin> Logger

<StatusMessage Message="@_message" />
<h1>Register</h1>
<h2>Associate your @ProviderDisplayName account.</h2>
<hr />

<div  class="alert alert-info">
    You've successfully authenticated with <strong>@ProviderDisplayName</strong>.
    Please enter an email address for this site below and click the Register button to finish
    logging in.
</div>

<div class="row">
    <div class="col-md-4">
        <EditForm Model="Input" OnValidSubmit="OnValidSubmitAsync" FormName="confirmation" method="post">
            <DataAnnotationsValidator />
            <ValidationSummary class="text-danger" role="alert" />
            <div class="form-floating mb-3">
                <InputText @bind-Value="Input.Email" class="form-control" autocomplete="email" placeholder="Please enter your email." />
                <label for="email" class="form-label">Email</label>
                <ValidationMessage For="() => Input.Email" />
            </div>
            <button type="submit" class="w-100 btn btn-lg btn-primary">Register</button>
        </EditForm>
    </div>
</div>

@code {
    public const string _loginCallbackAction = "LoginCallback";

    private string? _message;
    private ExternalLoginInfo _externalLoginInfo = default!;

    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    [SupplyParameterFromForm]
    private InputModel Input { get; set; } = new();

    [SupplyParameterFromQuery]
    private string? RemoteError { get; set; }

    [SupplyParameterFromQuery]
    private string? ReturnUrl { get; set; }

    [SupplyParameterFromQuery]
    private string? Action { get; set; }

    private string? ProviderDisplayName => _externalLoginInfo.ProviderDisplayName;

    protected override async Task OnInitializedAsync()
    {
        if (RemoteError is not null)
        {
            Redirect.ToWithStatus("Account/Login", $"Error from external provider: {RemoteError}", HttpContext);
        }

        var info = await SignInManager.GetExternalLoginInfoAsync();
        if (info is null)
        {
            Redirect.ToWithStatus("Account/Login", "Error loading external login information.", HttpContext);
        }

        _externalLoginInfo = info;

        if (HttpMethods.IsGet(HttpContext.Request.Method))
        {
            if (Action == _loginCallbackAction)
            {
                await OnLoginCallbackAsync();
                return;
            }

            // We should only reach this page via the login callback, so redirect back to
            // the login page if we get here some other way.
            Redirect.To("Account/Login");
        }
    }

    private async Task OnLoginCallbackAsync()
    {
        // Sign in the user with this external login provider if the user already has a login.
        var result = await SignInManager.ExternalLoginSignInAsync(
            _externalLoginInfo.LoginProvider,
            _externalLoginInfo.ProviderKey,
            isPersistent: false,
            bypassTwoFactor: true);

        if (result.Succeeded)
        {
            Logger.LogInformation(
                "{Name} logged in with {LoginProvider} provider.",
                _externalLoginInfo.Principal.Identity?.Name,
                _externalLoginInfo.LoginProvider);
            Redirect.To(ReturnUrl);
        }
        else if (result.IsLockedOut)
        {
            Redirect.To("Account/Lockout");
        }

        // If the user does not have an account, then ask the user to create an account.
        if (_externalLoginInfo.Principal.HasClaim(c => c.Type == ClaimTypes.Email))
        {
            Input.Email = _externalLoginInfo.Principal.FindFirstValue(ClaimTypes.Email) ?? "";
        }
    }

    private async Task OnValidSubmitAsync()
    {
        var emailStore = GetEmailStore();
        var user = CreateUser();

        await UserStore.SetUserNameAsync(user, Input.Email, CancellationToken.None);
        await emailStore.SetEmailAsync(user, Input.Email, CancellationToken.None);

        var result = await UserManager.CreateAsync(user);
        if (result.Succeeded)
        {
            result = await UserManager.AddLoginAsync(user, _externalLoginInfo);
            if (result.Succeeded)
            {
                Logger.LogInformation("User created an account using {Name} provider.", _externalLoginInfo.LoginProvider);

                var userId = await UserManager.GetUserIdAsync(user);
                var code = await UserManager.GenerateEmailConfirmationTokenAsync(user);
                code = WebEncoders.Base64UrlEncode(Encoding.UTF8.GetBytes(code));

                var callbackUrl = NavigationManager.GetUriWithQueryParameters(
                    NavigationManager.ToAbsoluteUri("Account/ConfirmEmail").AbsoluteUri,
                    new Dictionary<string, object?> { ["userId"] = userId, ["code"] = code });
                await EmailSender.SendConfirmationLinkAsync(user, Input.Email, HtmlEncoder.Default.Encode(callbackUrl));

                // If account confirmation is required, we need to show the link if we don't have a real email sender
                if (UserManager.Options.SignIn.RequireConfirmedAccount)
                {
                    Redirect.To("Account/RegisterConfirmation", new() { ["email"] = Input.Email });
                }

                await SignInManager.SignInAsync(user, isPersistent: false, _externalLoginInfo.LoginProvider);
                Redirect.To(ReturnUrl);
            }
        }

        _message = $"Error: {string.Join(",", result.Errors.Select(error => error.Description))}";
    }

    private ApplicationUser CreateUser()
    {
        try
        {
            return Activator.CreateInstance<ApplicationUser>();
        }
        catch
        {
            throw new InvalidOperationException($"Can't create an instance of '{nameof(ApplicationUser)}'. " +
                $"Ensure that '{nameof(ApplicationUser)}' is not an abstract class and has a parameterless constructor");
        }
    }

    private IUserEmailStore<ApplicationUser> GetEmailStore()
    {
        if (!UserManager.SupportsUserEmail)
        {
            throw new NotSupportedException("The default UI requires a user store with email support.");
        }
        return (IUserEmailStore<ApplicationUser>)UserStore;
    }

    private sealed class InputModel
    {
        [Required]
        [EmailAddress]
        public string Email { get; set; } = "";
    }
}
 
---------------------------------------------------------------------------------------- 
WebApp\Components\Account\Pages\ForgotPassword.razor 
@page "/Account/ForgotPassword"

@inject UserManager<ApplicationUser> UserManager
@inject IEmailSender<ApplicationUser> EmailSender
@inject NavigationManager NavigationManager
@inject Redirect Redirect

<h1>Forgot your password?</h1>
<h2>Enter your email.</h2>
<hr />
<div class="row">
    <div class="col-md-4">
        <EditForm Model="Input" FormName="forgot-password" OnValidSubmit="OnValidSubmitAsync" method="post">
            <DataAnnotationsValidator />
            <ValidationSummary class="text-danger" role="alert" />

            <div class="form-floating mb-3">
                <InputText @bind-Value="Input.Email" class="form-control" autocomplete="username" aria-required="true" placeholder="name@example.com" />
                <label for="email" class="form-label">Email</label>
                <ValidationMessage For="() => Input.Email" class="text-danger" />
            </div>
            <button type="submit" class="w-100 btn btn-lg btn-primary">Reset password</button>
        </EditForm>
     </div>
</div>

@code {
    [SupplyParameterFromForm]
    private InputModel Input { get; set; } = new();

    private async Task OnValidSubmitAsync()
    {
        var user = await UserManager.FindByEmailAsync(Input.Email);
        if (user is null || !(await UserManager.IsEmailConfirmedAsync(user)))
        {
            // Don't reveal that the user does not exist or is not confirmed
            Redirect.To("Account/ForgotPasswordConfirmation");
        }

        // For more information on how to enable account confirmation and password reset please
        // visit https://go.microsoft.com/fwlink/?LinkID=532713
        var code = await UserManager.GeneratePasswordResetTokenAsync(user);
        code = WebEncoders.Base64UrlEncode(Encoding.UTF8.GetBytes(code));
        var callbackUrl = NavigationManager.GetUriWithQueryParameters(
            NavigationManager.ToAbsoluteUri("Account/ResetPassword").AbsoluteUri,
            new Dictionary<string, object?> { ["code"] = code });

        await EmailSender.SendPasswordResetLinkAsync(user, Input.Email, HtmlEncoder.Default.Encode(callbackUrl));

        Redirect.To("Account/ForgotPasswordConfirmation");
    }

    private sealed class InputModel
    {
        [Required]
        [EmailAddress]
        public string Email { get; set; } = "";
    }
}
 
---------------------------------------------------------------------------------------- 
WebApp\Components\Account\Pages\ForgotPasswordConfirmation.razor 
@page "/Account/ForgotPasswordConfirmation"

<h1>Forgot password confirmation</h1>
<p>
    Please check your email to reset your password.
</p>
 
---------------------------------------------------------------------------------------- 
WebApp\Components\Account\Pages\InvalidPasswordReset.razor 
@page "/Account/InvalidPasswordReset"

<h1>Invalid password reset</h1>
<p>
    The password reset link is invalid.
</p>
 
---------------------------------------------------------------------------------------- 
WebApp\Components\Account\Pages\InvalidUser.razor 
@page "/Account/InvalidUser"

<h3>Invalid user</h3>

<StatusMessage />
 
---------------------------------------------------------------------------------------- 
WebApp\Components\Account\Pages\Lockout.razor 
@page "/Account/Lockout"

<header>
    <h1 class="text-danger">Locked out</h1>
    <p class="text-danger">This account has been locked out, please try again later.</p>
</header>
 
---------------------------------------------------------------------------------------- 
WebApp\Components\Account\Pages\Login.razor 
@page "/Account/Login"

@inject SignInManager<ApplicationUser> SignInManager
@inject ILogger<Login> Logger
@inject NavigationManager NavigationManager
@inject Redirect Redirect

<h1>Log in</h1>
<div class="row">
    <div class="col-md-4">
        <section>
            <StatusMessage Message="@_errorMessage" />
            <EditForm Model="Input" method="post" OnValidSubmit="LoginUser" FormName="login">
                <DataAnnotationsValidator />
                <h2>Use a local account to log in.</h2>
                <hr />
                <ValidationSummary class="text-danger" role="alert" />
                <div class="form-floating mb-3">
                    <InputText @bind-Value="Input.Email" class="form-control" autocomplete="username" aria-required="true" placeholder="name@example.com" />
                    <label for="email" class="form-label">Email</label>
                    <ValidationMessage For="() => Input.Email" class="text-danger" />
                </div>
                <div class="form-floating mb-3">
                    <InputText type="password" @bind-Value="Input.Password" class="form-control" autocomplete="current-password" aria-required="true" placeholder="password" />
                    <label for="password" class="form-label">Password</label>
                    <ValidationMessage For="() => Input.Password" class="text-danger" />
                </div>
                <div class="checkbox mb-3">
                    <label class="form-label">
                        <InputCheckbox @bind-Value="Input.RememberMe" class="darker-border-checkbox form-check-input" />
                        Remember me
                    </label>
                </div>
                <div>
                    <button type="submit" class="w-100 btn btn-lg btn-primary">Log in</button>
                </div>
                <div>
                    <p>
                        <a href="Account/ForgotPassword">Forgot your password?</a>
                    </p>
                    <p>
                        <a href="@(NavigationManager.GetUriWithQueryParameters("Account/Register", new Dictionary<string, object?> { ["ReturnUrl"] = ReturnUrl }))">Register as a new user</a>
                    </p>
                    <p>
                        <a href="Account/ResendEmailConfirmation">Resend email confirmation</a>
                    </p>
                </div>
            </EditForm>
        </section>
    </div>
    <div class="col-md-6 col-md-offset-2">
        <section>
            <h3>Use another service to log in.</h3>
            <hr />
            <ExternalLoginPicker />
        </section>
    </div>
</div>

@code {
    private string? _errorMessage;

    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    [SupplyParameterFromForm]
    private InputModel Input { get; set; } = new();

    [SupplyParameterFromQuery]
    private string? ReturnUrl { get; set; }

    protected override async Task OnInitializedAsync()
    {
        if (HttpMethods.IsGet(HttpContext.Request.Method))
        {
            // Clear the existing external cookie to ensure a clean login process
            await HttpContext.SignOutAsync(IdentityConstants.ExternalScheme);
        }
    }

    public async Task LoginUser()
    {
        // This doesn't count login failures towards account lockout
        // To enable password failures to trigger account lockout, set lockoutOnFailure: true
        var result = await SignInManager.PasswordSignInAsync(Input.Email, Input.Password, Input.RememberMe, lockoutOnFailure: false);
        if (result.Succeeded)
        {
            Logger.LogInformation("User logged in.");
            Redirect.To(ReturnUrl);
        }
        else if (result.RequiresTwoFactor)
        {
            Redirect.To(
                "Account/LoginWith2fa",
                new() { ["returnUrl"] = ReturnUrl, ["rememberMe"] = Input.RememberMe });
        }
        else if (result.IsLockedOut)
        {
            Logger.LogWarning("User account locked out.");
            Redirect.To("Account/Lockout");
        }
        else
        {
            _errorMessage = "Error: Invalid login attempt.";
        }
    }

    private sealed class InputModel
    {
        [Required]
        [EmailAddress]
        public string Email { get; set; } = "";

        [Required]
        [DataType(DataType.Password)]
        public string Password { get; set; } = "";

        [Display(Name = "Remember me?")]
        public bool RememberMe { get; set; }
    }
}
 
---------------------------------------------------------------------------------------- 
WebApp\Components\Account\Pages\LoginWith2fa.razor 
@page "/Account/LoginWith2fa"

@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager
@inject Redirect Redirect
@inject ILogger<LoginWith2fa> Logger

<h1>Two-factor authentication</h1>
<hr />
<StatusMessage Message="@_message" />
<p>Your login is protected with an authenticator app. Enter your authenticator code below.</p>
<div class="row">
    <div class="col-md-4">
        <EditForm Model="Input" FormName="login-with-2fa" OnValidSubmit="OnValidSubmitAsync" method="post">
            <input type="hidden" name="ReturnUrl" value="@ReturnUrl" />
            <input type="hidden" name="RememberMe" value="@RememberMe" />
            <DataAnnotationsValidator />
            <ValidationSummary class="text-danger" role="alert" />
            <div class="form-floating mb-3">
                <InputText @bind-Value="Input.TwoFactorCode" class="form-control" autocomplete="off" />
                <label for="two-factor-code" class="form-label">Authenticator code</label>
                <ValidationMessage For="() => Input.TwoFactorCode" class="text-danger" />
            </div>
            <div class="checkbox mb-3">
                <label for="remember-machine" class="form-label">
                    <InputCheckbox @bind-Value="Input.RememberMachine" />
                    Remember this machine
                </label>
            </div>
            <div>
                <button type="submit" class="w-100 btn btn-lg btn-primary">Log in</button>
            </div>
        </EditForm>
    </div>
</div>
<p>
    Don't have access to your authenticator device? You can
    <a href="Account/LoginWithRecoveryCode?ReturnUrl=@ReturnUrl">log in with a recovery code</a>.
</p>

@code {
    private string? _message;
    private ApplicationUser _user = default!;

    [SupplyParameterFromForm]
    private InputModel Input { get; set; } = new();

    [SupplyParameterFromQuery]
    private string? ReturnUrl { get; set; }

    [SupplyParameterFromQuery]
    private bool RememberMe { get; set; }

    protected override async Task OnInitializedAsync()
    {
        // Ensure the user has gone through the username & password screen first
        _user = await SignInManager.GetTwoFactorAuthenticationUserAsync() ??
            throw new InvalidOperationException("Unable to load two-factor authentication user.");
    }

    private async Task OnValidSubmitAsync()
    {
        var authenticatorCode = Input.TwoFactorCode!.Replace(" ", string.Empty).Replace("-", string.Empty);
        var result = await SignInManager.TwoFactorAuthenticatorSignInAsync(authenticatorCode, RememberMe, Input.RememberMachine);
        var userId = await UserManager.GetUserIdAsync(_user);

        if (result.Succeeded)
        {
            Logger.LogInformation("User with ID '{UserId}' logged in with 2fa.", userId);
            Redirect.To(ReturnUrl);
        }
        else if (result.IsLockedOut)
        {
            Logger.LogWarning("User with ID '{UserId}' account locked out.", userId);
            Redirect.To("Account/Lockout");
        }
        else
        {
            Logger.LogWarning("Invalid authenticator code entered for user with ID '{UserId}'.", userId);
            _message = "Error: Invalid authenticator code.";
        }
    }

    private sealed class InputModel
    {
        [Required]
        [StringLength(7, ErrorMessage = "The {0} must be at least {2} and at max {1} characters long.", MinimumLength = 6)]
        [DataType(DataType.Text)]
        [Display(Name = "Authenticator code")]
        public string? TwoFactorCode { get; set; }

        [Display(Name = "Remember this machine")]
        public bool RememberMachine { get; set; }
    }
}
 
---------------------------------------------------------------------------------------- 
WebApp\Components\Account\Pages\LoginWithRecoveryCode.razor 
@page "/Account/LoginWithRecoveryCode"

@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager
@inject Redirect Redirect
@inject ILogger<LoginWithRecoveryCode> Logger

<h1>Recovery code verification</h1>
<hr />
<StatusMessage Message="@_message" />
<p>
    You have requested to log in with a recovery code. This login will not be remembered until you provide
    an authenticator app code at log in or disable 2FA and log in again.
</p>
<div class="row">
    <div class="col-md-4">
        <EditForm Model="Input" FormName="login-with-recovery-code" OnValidSubmit="OnValidSubmitAsync" method="post">
            <DataAnnotationsValidator />
            <ValidationSummary class="text-danger" role="alert" />
            <div class="form-floating mb-3">
                <InputText @bind-Value="Input.RecoveryCode" class="form-control" autocomplete="off" placeholder="RecoveryCode" />
                <label for="recovery-code" class="form-label">Recovery Code</label>
                <ValidationMessage For="() => Input.RecoveryCode" class="text-danger" />
            </div>
            <button type="submit" class="w-100 btn btn-lg btn-primary">Log in</button>
        </EditForm>
    </div>
</div>

@code {
    private string? _message;
    private ApplicationUser _user = default!;

    [SupplyParameterFromForm]
    private InputModel Input { get; set; } = new();

    [SupplyParameterFromQuery]
    private string? ReturnUrl { get; set; }

    protected override async Task OnInitializedAsync()
    {
        // Ensure the user has gone through the username & password screen first
        _user = await SignInManager.GetTwoFactorAuthenticationUserAsync() ??
            throw new InvalidOperationException("Unable to load two-factor authentication user.");
    }

    private async Task OnValidSubmitAsync()
    {
        var recoveryCode = Input.RecoveryCode.Replace(" ", string.Empty);

        var result = await SignInManager.TwoFactorRecoveryCodeSignInAsync(recoveryCode);

        var userId = await UserManager.GetUserIdAsync(_user);

        if (result.Succeeded)
        {
            Logger.LogInformation("User with ID '{UserId}' logged in with a recovery code.", userId);
            Redirect.To(ReturnUrl);
        }
        else if (result.IsLockedOut)
        {
            Logger.LogWarning("User account locked out.");
            Redirect.To("Account/Lockout");
        }
        else
        {
            Logger.LogWarning("Invalid recovery code entered for user with ID '{UserId}' ", userId);
            _message = "Error: Invalid recovery code entered.";
        }
    }

    private sealed class InputModel
    {
        [Required]
        [DataType(DataType.Text)]
        [Display(Name = "Recovery Code")]
        public string RecoveryCode { get; set; } = "";
    }
}
 
---------------------------------------------------------------------------------------- 
WebApp\Components\Account\Pages\Register.razor 
@page "/Account/Register"

@inject UserManager<ApplicationUser> UserManager
@inject IUserStore<ApplicationUser> UserStore
@inject SignInManager<ApplicationUser> SignInManager
@inject IEmailSender<ApplicationUser> EmailSender
@inject ILogger<Register> Logger
@inject NavigationManager NavigationManager
@inject Redirect Redirect

<h1>Register</h1>

<div class="row">
    <div class="col-md-4">
        <StatusMessage Message="@Message" />
        <EditForm Model="Input" asp-route-returnUrl="@ReturnUrl" method="post" OnValidSubmit="RegisterUser" FormName="register">
            <DataAnnotationsValidator />
            <h2>Create a new account.</h2>
            <hr />
            <ValidationSummary class="text-danger" role="alert" />
            <div class="form-floating mb-3">
                <InputText @bind-Value="Input.Email" class="form-control" autocomplete="username" aria-required="true" placeholder="name@example.com" />
                <label for="email">Email</label>
                <ValidationMessage For="() => Input.Email" class="text-danger" />
            </div>
            <div class="form-floating mb-3">
                <InputText type="password" @bind-Value="Input.Password" class="form-control" autocomplete="new-password" aria-required="true" placeholder="password" />
                <label for="password">Password</label>
                <ValidationMessage For="() => Input.Password" class="text-danger" />
            </div>
            <div class="form-floating mb-3">
                <InputText type="password" @bind-Value="Input.ConfirmPassword" class="form-control" autocomplete="new-password" aria-required="true" placeholder="password" />
                <label for="confirm-password">Confirm Password</label>
                <ValidationMessage For="() => Input.ConfirmPassword" class="text-danger" />
            </div>
            <button type="submit" class="w-100 btn btn-lg btn-primary">Register</button>
        </EditForm>
    </div>
    <div class="col-md-6 col-md-offset-2">
        <section>
            <h3>Use another service to register.</h3>
            <hr />
            <ExternalLoginPicker />
        </section>
    </div>
</div>

@code {
    private IEnumerable<IdentityError>? _identityErrors;

    [SupplyParameterFromForm]
    private InputModel Input { get; set; } = new();

    [SupplyParameterFromQuery]
    private string? ReturnUrl { get; set; }

    private string? Message => _identityErrors is null ? null : $"Error: {string.Join(", ", _identityErrors.Select(error => error.Description))}";

    public async Task RegisterUser(EditContext editContext)
    {
        var user = CreateUser();

        await UserStore.SetUserNameAsync(user, Input.Email, CancellationToken.None);
        var emailStore = GetEmailStore();
        await emailStore.SetEmailAsync(user, Input.Email, CancellationToken.None);
        var result = await UserManager.CreateAsync(user, Input.Password);

        if (!result.Succeeded)
        {
            _identityErrors = result.Errors;
            return;
        }

        Logger.LogInformation("User created a new account with password.");

        var userId = await UserManager.GetUserIdAsync(user);
        var code = await UserManager.GenerateEmailConfirmationTokenAsync(user);
        code = WebEncoders.Base64UrlEncode(Encoding.UTF8.GetBytes(code));
        var callbackUrl = NavigationManager.GetUriWithQueryParameters(
            NavigationManager.ToAbsoluteUri("Account/ConfirmEmail").AbsoluteUri,
            new Dictionary<string, object?> { ["userId"] = userId, ["code"] = code, ["returnUrl"] = ReturnUrl });

        await EmailSender.SendConfirmationLinkAsync(user, Input.Email, HtmlEncoder.Default.Encode(callbackUrl));

        if (UserManager.Options.SignIn.RequireConfirmedAccount)
        {
            Redirect.To(
                "Account/RegisterConfirmation",
                new() { ["email"] = Input.Email, ["returnUrl"] = ReturnUrl });
        }

        await SignInManager.SignInAsync(user, isPersistent: false);
        Redirect.To(ReturnUrl);
    }

    private ApplicationUser CreateUser()
    {
        try
        {
            return Activator.CreateInstance<ApplicationUser>();
        }
        catch
        {
            throw new InvalidOperationException($"Can't create an instance of '{nameof(ApplicationUser)}'. " +
                $"Ensure that '{nameof(ApplicationUser)}' is not an abstract class and has a parameterless constructor.");
        }
    }

    private IUserEmailStore<ApplicationUser> GetEmailStore()
    {
        if (!UserManager.SupportsUserEmail)
        {
            throw new NotSupportedException("The default UI requires a user store with email support.");
        }
        return (IUserEmailStore<ApplicationUser>)UserStore;
    }

    private sealed class InputModel
    {
        [Required]
        [EmailAddress]
        [Display(Name = "Email")]
        public string Email { get; set; } = "";

        [Required]
        [StringLength(100, ErrorMessage = "The {0} must be at least {2} and at max {1} characters long.", MinimumLength = 6)]
        [DataType(DataType.Password)]
        [Display(Name = "Password")]
        public string Password { get; set; } = "";

        [DataType(DataType.Password)]
        [Display(Name = "Confirm password")]
        [Compare("Password", ErrorMessage = "The password and confirmation password do not match.")]
        public string ConfirmPassword { get; set; } = "";
    }
}
 
---------------------------------------------------------------------------------------- 
WebApp\Components\Account\Pages\RegisterConfirmation.razor 
@page "/Account/RegisterConfirmation"

@inject UserManager<ApplicationUser> UserManager
@inject IEmailSender<ApplicationUser> EmailSender
@inject NavigationManager NavigationManager
@inject Redirect Redirect

<h1>Register confirmation</h1>

<StatusMessage Message="@_statusMessage" />

@if (_emailConfirmationLink is not null)
{
    <p>
        This app does not currently have a real email sender registered, see <a href="https://aka.ms/aspaccountconf">these docs</a> for how to configure a real email sender.
        Normally this would be emailed: <a href="@_emailConfirmationLink">Click here to confirm your account</a>
    </p>
}
else
{
    <p>Please check your email to confirm your account.</p>
}

@code {
    private string? _emailConfirmationLink;
    private string? _statusMessage;

    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    [SupplyParameterFromQuery]
    private string? Email { get; set; }

    [SupplyParameterFromQuery]
    private string? ReturnUrl { get; set; }

    protected override async Task OnInitializedAsync()
    {
        if (Email is null)
        {
            Redirect.To("");
        }

        var user = await UserManager.FindByEmailAsync(Email);
        if (user is null)
        {
            HttpContext.Response.StatusCode = StatusCodes.Status404NotFound;
            _statusMessage = "Error finding user for unspecified email";
        }
        else if (EmailSender is IdentityNoOpEmailSender)
        {
            // Once you add a real email sender, you should remove this code that lets you confirm the account
            var userId = await UserManager.GetUserIdAsync(user);
            var code = await UserManager.GenerateEmailConfirmationTokenAsync(user);
            code = WebEncoders.Base64UrlEncode(Encoding.UTF8.GetBytes(code));
            _emailConfirmationLink = NavigationManager.GetUriWithQueryParameters(
                NavigationManager.ToAbsoluteUri("Account/ConfirmEmail").AbsoluteUri,
                new Dictionary<string, object?> { ["userId"] = userId, ["code"] = code, ["returnUrl"] = ReturnUrl });
        }
    }
}
 
---------------------------------------------------------------------------------------- 
WebApp\Components\Account\Pages\ResendEmailConfirmation.razor 
@page "/Account/ResendEmailConfirmation"

@inject UserManager<ApplicationUser> UserManager
@inject IEmailSender<ApplicationUser> EmailSender
@inject NavigationManager NavigationManager
@inject Redirect Redirect

<h1>Resend email confirmation</h1>
<h2>Enter your email.</h2>
<hr />
<StatusMessage Message="@_message" />
<div class="row">
    <div class="col-md-4">
        <EditForm Model="Input" FormName="resend-email-confirmation" OnValidSubmit="OnValidSubmitAsync" method="post">
            <DataAnnotationsValidator />
            <ValidationSummary class="text-danger" role="alert" />
            <div class="form-floating mb-3">
                <InputText @bind-Value="Input.Email" class="form-control" aria-required="true" placeholder="name@example.com" />
                <label for="email" class="form-label">Email</label>
                <ValidationMessage For="() => Input.Email" class="text-danger" />
            </div>
            <button type="submit" class="w-100 btn btn-lg btn-primary">Resend</button>
        </EditForm>
    </div>
</div>

@code {
    private string? _message;

    [SupplyParameterFromForm]
    private InputModel Input { get; set; } = new();

    private async Task OnValidSubmitAsync()
    {
        var user = await UserManager.FindByEmailAsync(Input.Email!);
        if (user is null)
        {
            _message = "Verification email sent. Please check your email.";
            return;
        }

        var userId = await UserManager.GetUserIdAsync(user);
        var code = await UserManager.GenerateEmailConfirmationTokenAsync(user);
        code = WebEncoders.Base64UrlEncode(Encoding.UTF8.GetBytes(code));
        var callbackUrl = NavigationManager.GetUriWithQueryParameters(
            NavigationManager.ToAbsoluteUri("Account/ConfirmEmail").AbsoluteUri,
            new Dictionary<string, object?> { ["userId"] = userId, ["code"] = code });
        await EmailSender.SendConfirmationLinkAsync(user, Input.Email, HtmlEncoder.Default.Encode(callbackUrl));

        _message = "Verification email sent. Please check your email.";
    }

    private sealed class InputModel
    {
        [Required]
        [EmailAddress]
        public string Email { get; set; } = "";
    }
}
 
---------------------------------------------------------------------------------------- 
WebApp\Components\Account\Pages\ResetPassword.razor 
@page "/Account/ResetPassword"

@inject Redirect Redirect
@inject UserManager<ApplicationUser> UserManager

<h1>Reset password</h1>
<h2>Reset your password.</h2>
<hr />
<div class="row">
    <div class="col-md-4">
        <StatusMessage Message="@Message" />
        <EditForm Model="Input" FormName="reset-password" OnValidSubmit="OnValidSubmitAsync" method="post">
            <DataAnnotationsValidator />
            <ValidationSummary class="text-danger" role="alert" />

            <input type="hidden" name="Input.Code" value="@Input.Code" />
            <div class="form-floating mb-3">
                <InputText @bind-Value="Input.Email" class="form-control" autocomplete="username" aria-required="true" placeholder="name@example.com" />
                <label for="email" class="form-label">Email</label>
                <ValidationMessage For="() => Input.Email" class="text-danger" />
            </div>
            <div class="form-floating mb-3">
                <InputText type="password" @bind-Value="Input.Password" class="form-control" autocomplete="new-password" aria-required="true" placeholder="Please enter your password." />
                <label for="password" class="form-label">Password</label>
                <ValidationMessage For="() => Input.Password" class="text-danger" />
            </div>
            <div class="form-floating mb-3">
                <InputText type="password" @bind-Value="Input.ConfirmPassword" class="form-control" autocomplete="new-password" aria-required="true" placeholder="Please confirm your password." />
                <label for="confirm-password" class="form-label">Confirm password</label>
                <ValidationMessage For="() => Input.ConfirmPassword" class="text-danger" />
            </div>
            <button type="submit" class="w-100 btn btn-lg btn-primary">Reset</button>
        </EditForm>
    </div>
</div>

@code {
    private IEnumerable<IdentityError>? _identityErrors;

    [SupplyParameterFromForm]
    private InputModel Input { get; set; } = new();

    [SupplyParameterFromQuery]
    private string? Code { get; set; }

    private string? Message => _identityErrors is null ? null : $"Error: {string.Join(", ", _identityErrors.Select(error => error.Description))}";

    protected override void OnInitialized()
    {
        if (Code is null)
        {
            Redirect.To("Account/InvalidPasswordReset");
        }

        Input.Code = Encoding.UTF8.GetString(WebEncoders.Base64UrlDecode(Code));
    }

    private async Task OnValidSubmitAsync()
    {
        var user = await UserManager.FindByEmailAsync(Input.Email);
        if (user is null)
        {
            // Don't reveal that the user does not exist
            Redirect.To("Account/ResetPasswordConfirmation");
        }

        var result = await UserManager.ResetPasswordAsync(user, Input.Code, Input.Password);
        if (result.Succeeded)
        {
            Redirect.To("Account/ResetPasswordConfirmation");
        }

        _identityErrors = result.Errors;
    }

    private sealed class InputModel
    {
        [Required]
        [EmailAddress]
        public string Email { get; set; } = "";

        [Required]
        [StringLength(100, ErrorMessage = "The {0} must be at least {2} and at max {1} characters long.", MinimumLength = 6)]
        [DataType(DataType.Password)]
        public string Password { get; set; } = "";

        [DataType(DataType.Password)]
        [Display(Name = "Confirm password")]
        [Compare("Password", ErrorMessage = "The password and confirmation password do not match.")]
        public string ConfirmPassword { get; set; } = "";

        [Required]
        public string Code { get; set; } = "";
    }
}
 
---------------------------------------------------------------------------------------- 
WebApp\Components\Account\Pages\ResetPasswordConfirmation.razor 
@page "/Account/ResetPasswordConfirmation"

<h1>Reset password confirmation</h1>
<p>
    Your password has been reset. Please <a href="Account/Login">click here to log in</a>.
</p>
 
---------------------------------------------------------------------------------------- 
WebApp\Components\Account\Pages\_Imports.razor 
@layout AccountLayout
 
---------------------------------------------------------------------------------------- 
WebApp\Components\Account\Pages\Manage\ChangePassword.razor 
@page "/Account/Manage/ChangePassword"

@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager
@inject UserAccessor UserAccessor
@inject Redirect Redirect
@inject ILogger<ChangePassword> Logger

<h3>Change password</h3>
<StatusMessage Message="@_message" />
<div class="row">
    <div class="col-md-6">
        <EditForm Model="Input" FormName="change-password" OnValidSubmit="OnValidSubmitAsync" method="post">
            <DataAnnotationsValidator />
            <ValidationSummary class="text-danger" role="alert" />
            <div class="form-floating mb-3">
                <InputText type="password" @bind-Value="Input.OldPassword" class="form-control" autocomplete="current-password" aria-required="true" placeholder="Please enter your old password." />
                <label for="old-password" class="form-label">Old password</label>
                <ValidationMessage For="() => Input.OldPassword" class="text-danger" />
            </div>
            <div class="form-floating mb-3">
                <InputText type="password" @bind-Value="Input.NewPassword" class="form-control" autocomplete="new-password" aria-required="true" placeholder="Please enter your new password." />
                <label for="new-password" class="form-label">New password</label>
                <ValidationMessage For="() => Input.NewPassword" class="text-danger" />
            </div>
            <div class="form-floating mb-3">
                <InputText type="password" @bind-Value="Input.ConfirmPassword" class="form-control" autocomplete="new-password" aria-required="true" placeholder="Please confirm your new password." />
                <label for="confirm-password" class="form-label">Confirm password</label>
                <ValidationMessage For="() => Input.ConfirmPassword" class="text-danger" />
            </div>
            <button type="submit" class="w-100 btn btn-lg btn-primary">Update password</button>
        </EditForm>
    </div>
</div>

@code {
    private string? _message;
    private ApplicationUser _user = default!;
    private bool _hasPassword;

    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    [SupplyParameterFromForm]
    private InputModel Input { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        _user = await UserAccessor.GetRequiredUserAsync(HttpContext);
        _hasPassword = await UserManager.HasPasswordAsync(_user);
        if (!_hasPassword)
        {
            Redirect.To("Account/Manage/SetPassword");
        }
    }

    private async Task OnValidSubmitAsync()
    {
        var changePasswordResult = await UserManager.ChangePasswordAsync(_user, Input.OldPassword, Input.NewPassword);
        if (!changePasswordResult.Succeeded)
        {
            _message = $"Error: {string.Join(",", changePasswordResult.Errors.Select(error => error.Description))}";
            return;
        }

        await SignInManager.RefreshSignInAsync(_user);
        Logger.LogInformation("User changed their password successfully.");

        Redirect.ToCurrentPageWithStatus("Your password has been changed", HttpContext);
    }

    private sealed class InputModel
    {
        [Required]
        [DataType(DataType.Password)]
        [Display(Name = "Current password")]
        public string OldPassword { get; set; } = "";

        [Required]
        [StringLength(100, ErrorMessage = "The {0} must be at least {2} and at max {1} characters long.", MinimumLength = 6)]
        [DataType(DataType.Password)]
        [Display(Name = "New password")]
        public string NewPassword { get; set; } = "";

        [DataType(DataType.Password)]
        [Display(Name = "Confirm new password")]
        [Compare("NewPassword", ErrorMessage = "The new password and confirmation password do not match.")]
        public string ConfirmPassword { get; set; } = "";
    }
}
 
---------------------------------------------------------------------------------------- 
WebApp\Components\Account\Pages\Manage\DeletePersonalData.razor 
@page "/Account/Manage/DeletePersonalData"

@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager
@inject UserAccessor UserAccessor
@inject Redirect Redirect
@inject ILogger<DeletePersonalData> Logger

<StatusMessage Message="@_message" />

<h3>Delete Personal Data</h3>

<div class="alert alert-warning" role="alert">
    <p>
        <strong>Deleting this data will permanently remove your account, and this cannot be recovered.</strong>
    </p>
</div>

<div>
    <EditForm Model="Input" FormName="delete-user" OnValidSubmit="OnValidSubmitAsync" method="post">
        <DataAnnotationsValidator />
        <ValidationSummary class="text-danger" role="alert" />
        @if (_requirePassword)
        {
            <div class="form-floating mb-3">
                <InputText type="password" @bind-Value="Input.Password" class="form-control" autocomplete="current-password" aria-required="true" placeholder="Please enter your password." />
                <label for="password" class="form-label">Password</label>
                <ValidationMessage For="() => Input.Password" class="text-danger" />
            </div>
        }
        <button class="w-100 btn btn-lg btn-danger" type="submit">Delete data and close my account</button>
    </EditForm>
</div>

@code {
    private string? _message;
    private ApplicationUser _user = default!;
    private bool _requirePassword;

    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    [SupplyParameterFromForm]
    private InputModel Input { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        Input ??= new();
        _user = await UserAccessor.GetRequiredUserAsync(HttpContext);
        _requirePassword = await UserManager.HasPasswordAsync(_user);
    }

    private async Task OnValidSubmitAsync()
    {
        if (_requirePassword && !await UserManager.CheckPasswordAsync(_user, Input.Password))
        {
            _message = "Error: Incorrect password.";
            return;
        }

        var result = await UserManager.DeleteAsync(_user);
        if (!result.Succeeded)
        {
            throw new InvalidOperationException("Unexpected error occurred deleting user.");
        }

        await SignInManager.SignOutAsync();

        var userId = await UserManager.GetUserIdAsync(_user);
        Logger.LogInformation("User with ID '{UserId}' deleted themselves.", userId);

        Redirect.ToCurrentPage();
    }

    private sealed class InputModel
    {
        [DataType(DataType.Password)]
        public string Password { get; set; } = "";
    }
}
 
---------------------------------------------------------------------------------------- 
WebApp\Components\Account\Pages\Manage\Disable2fa.razor 
@page "/Account/Manage/Disable2fa"

@inject UserManager<ApplicationUser> UserManager
@inject UserAccessor UserAccessor
@inject Redirect Redirect
@inject ILogger<Disable2fa> Logger

<StatusMessage />
<h3>Disable two-factor authentication (2FA)</h3>

<div class="alert alert-warning" role="alert">
    <p>
        <strong>This action only disables 2FA.</strong>
    </p>
    <p>
        Disabling 2FA does not change the keys used in authenticator apps. If you wish to change the key
        used in an authenticator app you should <a href="Account/Manage/ResetAuthenticator">reset your authenticator keys.</a>
    </p>
</div>

<div>
    <form @formname="disable-2fa" @onsubmit="OnSubmitAsync" method="post">
        <AntiforgeryToken />
        <button class="btn btn-danger" type="submit">Disable 2FA</button>
    </form>
</div>

@code {
    private ApplicationUser _user = default!;

    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        _user = await UserAccessor.GetRequiredUserAsync(HttpContext);

        if (HttpMethods.IsGet(HttpContext.Request.Method) && !await UserManager.GetTwoFactorEnabledAsync(_user))
        {
            throw new InvalidOperationException("Cannot disable 2FA for user as it's not currently enabled.");
        }
    }

    private async Task OnSubmitAsync()
    {
        var disable2FaResult = await UserManager.SetTwoFactorEnabledAsync(_user, false);
        if (!disable2FaResult.Succeeded)
        {
            throw new InvalidOperationException("Unexpected error occurred disabling 2FA.");
        }

        var userId = await UserManager.GetUserIdAsync(_user);
        Logger.LogInformation("User with ID '{UserId}' has disabled 2fa.", userId);
        Redirect.ToWithStatus(
            "Account/Manage/TwoFactorAuthentication",
            "2fa has been disabled. You can reenable 2fa when you setup an authenticator app",
            HttpContext);
    }
}
 
---------------------------------------------------------------------------------------- 
WebApp\Components\Account\Pages\Manage\Email.razor 
@page "/Account/Manage/Email"

@inject UserManager<ApplicationUser> UserManager
@inject IEmailSender<ApplicationUser> EmailSender
@inject UserAccessor UserAccessor
@inject NavigationManager NavigationManager

<h3>Manage email</h3>

<StatusMessage Message="@_message"/>
<div class="row">
    <div class="col-md-6">
        <form @onsubmit="OnSendEmailVerificationAsync" @formname="send-verification" id="send-verification-form" method="post">
            <AntiforgeryToken />
        </form>
        <EditForm Model="Input" FormName="change-email" OnValidSubmit="OnValidSubmitAsync" method="post">
            <DataAnnotationsValidator />
            <ValidationSummary class="text-danger" role="alert" />
            @if (_isEmailConfirmed)
            {
                <div class="form-floating mb-3 input-group">
                    <input type="text" value="@_email" class="form-control" placeholder="Please enter your email." disabled />
                    <div class="input-group-append">
                        <span class="h-100 input-group-text text-success font-weight-bold"></span>
                    </div>
                    <label for="email" class="form-label">Email</label>
                </div>
            }
            else
            {
                <div class="form-floating mb-3">
                    <input type="text" value="@_email" class="form-control" placeholder="Please enter your email." disabled />
                    <label for="email" class="form-label">Email</label>
                    <button type="submit" class="btn btn-link" form="send-verification-form">Send verification email</button>
                </div>
            }
            <div class="form-floating mb-3">
                <InputText @bind-Value="Input.NewEmail" class="form-control" autocomplete="email" aria-required="true" placeholder="Please enter new email." />
                <label for="new-email" class="form-label">New email</label>
                <ValidationMessage For="() => Input.NewEmail" class="text-danger" />
            </div>
            <button type="submit" class="w-100 btn btn-lg btn-primary">Change email</button>
        </EditForm>
    </div>
</div>

@code {
    private string? _message;
    private ApplicationUser _user = default!;
    private string? _email;
    private bool _isEmailConfirmed;

    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    [SupplyParameterFromForm(FormName = "change-email")]
    private InputModel Input { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        _user = await UserAccessor.GetRequiredUserAsync(HttpContext);
        _email = await UserManager.GetEmailAsync(_user);
        _isEmailConfirmed = await UserManager.IsEmailConfirmedAsync(_user);

        Input.NewEmail ??= _email;
    }

    private async Task OnValidSubmitAsync()
    {
        if (Input.NewEmail is null || Input.NewEmail == _email)
        {
            _message = "Your email is unchanged.";
            return;
        }

        var userId = await UserManager.GetUserIdAsync(_user);
        var code = await UserManager.GenerateChangeEmailTokenAsync(_user, Input.NewEmail);
        code = WebEncoders.Base64UrlEncode(Encoding.UTF8.GetBytes(code));
        var callbackUrl = NavigationManager.GetUriWithQueryParameters(
            NavigationManager.ToAbsoluteUri("Account/ConfirmEmailChange").AbsoluteUri,
            new Dictionary<string, object?> { ["userId"] = userId, ["email"] = Input.NewEmail, ["code"] = code });

        await EmailSender.SendConfirmationLinkAsync(_user, Input.NewEmail, HtmlEncoder.Default.Encode(callbackUrl));

        _message = "Confirmation link to change email sent. Please check your email.";
    }

    private async Task OnSendEmailVerificationAsync()
    {
        if (_email is null)
        {
            return;
        }

        var userId = await UserManager.GetUserIdAsync(_user);
        var code = await UserManager.GenerateEmailConfirmationTokenAsync(_user);
        code = WebEncoders.Base64UrlEncode(Encoding.UTF8.GetBytes(code));
        var callbackUrl = NavigationManager.GetUriWithQueryParameters(
            NavigationManager.ToAbsoluteUri("Account/ConfirmEmail").AbsoluteUri,
            new Dictionary<string, object?> { ["userId"] = userId, ["code"] = code });

        await EmailSender.SendConfirmationLinkAsync(_user, _email, HtmlEncoder.Default.Encode(callbackUrl));

        _message = "Verification email sent. Please check your email.";
    }

    private sealed class InputModel
    {
        [Required]
        [EmailAddress]
        [Display(Name = "New email")]
        public string? NewEmail { get; set; }
    }
}
 
---------------------------------------------------------------------------------------- 
WebApp\Components\Account\Pages\Manage\EnableAuthenticator.razor 
@page "/Account/Manage/EnableAuthenticator"

@inject UserManager<ApplicationUser> UserManager
@inject UserAccessor UserAccessor
@inject UrlEncoder UrlEncoder
@inject Redirect Redirect
@inject ILogger<EnableAuthenticator> Logger

@if (_recoveryCodes is not null)
{
    <ShowRecoveryCodes RecoveryCodes="_recoveryCodes.ToArray()" StatusMessage="@_message" />
}
else
{
    <StatusMessage Message="@_message" />
    <h3>Configure authenticator app</h3>
    <div>
        <p>To use an authenticator app go through the following steps:</p>
        <ol class="list">
            <li>
                <p>
                    Download a two-factor authenticator app like Microsoft Authenticator for
                    <a href="https://go.microsoft.com/fwlink/?Linkid=825072">Android</a> and
                    <a href="https://go.microsoft.com/fwlink/?Linkid=825073">iOS</a> or
                    Google Authenticator for
                    <a href="https://play.google.com/store/apps/details?id=com.google.android.apps.authenticator2&amp;hl=en">Android</a> and
                    <a href="https://itunes.apple.com/us/app/google-authenticator/id388497605?mt=8">iOS</a>.
                </p>
            </li>
            <li>
                <p>Scan the QR Code or enter this key <kbd>@_sharedKey</kbd> into your two factor authenticator app. Spaces and casing do not matter.</p>
                <div class="alert alert-info">Learn how to <a href="https://go.microsoft.com/fwlink/?Linkid=852423">enable QR code generation</a>.</div>
                <div></div>
                <div data-url="@_authenticatorUri"></div>
            </li>
            <li>
                <p>
                    Once you have scanned the QR code or input the key above, your two factor authentication app will provide you
                    with a unique code. Enter the code in the confirmation box below.
                </p>
                <div class="row">
                    <div class="col-md-6">
                        <EditForm Model="Input" FormName="send-code" OnValidSubmit="OnValidSubmitAsync" method="post">
                            <DataAnnotationsValidator />
                            <div class="form-floating mb-3">
                                <InputText @bind-Value="Input.Code" class="form-control" autocomplete="off" placeholder="Please enter the code." />
                                <label for="code" class="control-label form-label">Verification Code</label>
                                <ValidationMessage For="() => Input.Code" class="text-danger" />
                            </div>
                            <button type="submit" class="w-100 btn btn-lg btn-primary">Verify</button>
                            <ValidationSummary class="text-danger" role="alert" />
                        </EditForm>
                    </div>
                </div>
            </li>
        </ol>
    </div>
}

@code {
    private const string AuthenticatorUriFormat = "otpauth://totp/{0}:{1}?secret={2}&issuer={0}&digits=6";

    private string? _message;
    private ApplicationUser _user = default!;
    private string? _sharedKey;
    private string? _authenticatorUri;
    private IEnumerable<string>? _recoveryCodes;

    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    [SupplyParameterFromForm]
    private InputModel Input { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        _user = await UserAccessor.GetRequiredUserAsync(HttpContext);

        await LoadSharedKeyAndQrCodeUriAsync(_user);
    }

    private async Task OnValidSubmitAsync()
    {
        // Strip spaces and hyphens
        var verificationCode = Input.Code.Replace(" ", string.Empty).Replace("-", string.Empty);

        var is2FaTokenValid = await UserManager.VerifyTwoFactorTokenAsync(
            _user, UserManager.Options.Tokens.AuthenticatorTokenProvider, verificationCode);

        if (!is2FaTokenValid)
        {
            _message = "Error: Verification code is invalid.";
            return;
        }

        await UserManager.SetTwoFactorEnabledAsync(_user, true);
        var userId = await UserManager.GetUserIdAsync(_user);
        Logger.LogInformation("User with ID '{UserId}' has enabled 2FA with an authenticator app.", userId);

        _message = "Your authenticator app has been verified.";

        if (await UserManager.CountRecoveryCodesAsync(_user) == 0)
        {
            _recoveryCodes = await UserManager.GenerateNewTwoFactorRecoveryCodesAsync(_user, 10);
        }
        else
        {
            Redirect.ToWithStatus("Account/Manage/TwoFactorAuthentication", _message, HttpContext);
        }
    }

    private async ValueTask LoadSharedKeyAndQrCodeUriAsync(ApplicationUser user)
    {
        // Load the authenticator key & QR code URI to display on the form
        var unformattedKey = await UserManager.GetAuthenticatorKeyAsync(user);
        if (string.IsNullOrEmpty(unformattedKey))
        {
            await UserManager.ResetAuthenticatorKeyAsync(user);
            unformattedKey = await UserManager.GetAuthenticatorKeyAsync(user);
        }

        _sharedKey = FormatKey(unformattedKey!);

        var email = await UserManager.GetEmailAsync(user);
        _authenticatorUri = GenerateQrCodeUri(email!, unformattedKey!);
    }

    private string FormatKey(string unformattedKey)
    {
        var result = new StringBuilder();
        int currentPosition = 0;
        while (currentPosition + 4 < unformattedKey.Length)
        {
            result.Append(unformattedKey.AsSpan(currentPosition, 4)).Append(' ');
            currentPosition += 4;
        }
        if (currentPosition < unformattedKey.Length)
        {
            result.Append(unformattedKey.AsSpan(currentPosition));
        }

        return result.ToString().ToLowerInvariant();
    }

    private string GenerateQrCodeUri(string email, string unformattedKey)
    {
        return string.Format(
            CultureInfo.InvariantCulture,
            AuthenticatorUriFormat,
            UrlEncoder.Encode("Microsoft.AspNetCore.Identity.UI"),
            UrlEncoder.Encode(email),
            unformattedKey);
    }

    private sealed class InputModel
    {
        [Required]
        [StringLength(7, ErrorMessage = "The {0} must be at least {2} and at max {1} characters long.", MinimumLength = 6)]
        [DataType(DataType.Text)]
        [Display(Name = "Verification Code")]
        public string Code { get; set; } = "";
    }
}
 
---------------------------------------------------------------------------------------- 
WebApp\Components\Account\Pages\Manage\ExternalLogins.razor 
@page "/Account/Manage/ExternalLogins"

@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager
@inject UserAccessor UserAccessor
@inject IUserStore<ApplicationUser> UserStore
@inject Redirect Redirect

<StatusMessage />
@if (_currentLogins?.Count > 0)
{
    <h3>Registered Logins</h3>
    <table class="table">
        <tbody>
            @foreach (var login in _currentLogins)
            {
                <tr>
                    <td>@login.ProviderDisplayName</td>
                    <td>
                        @if (_showRemoveButton)
                        {
                            <form @formname="@($"remove-login-{login.LoginProvider}")" @onsubmit="OnSubmitAsync" method="post">
                                <AntiforgeryToken />
                                <div>
                                    <input type="hidden" name="@nameof(LoginProvider)" value="@login.LoginProvider" />
                                    <input type="hidden" name="@nameof(ProviderKey)" value="@login.ProviderKey" />
                                    <button type="submit" class="btn btn-primary" title="Remove this @login.ProviderDisplayName login from your account">Remove</button>
                                </div>
                            </form>
                        }
                        else
                        {
                            @: &nbsp;
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
}
@if (_otherLogins?.Count > 0)
{
    <h4>Add another service to log in.</h4>
    <hr />
    <form class="form-horizontal" action="Account/Manage/LinkExternalLogin" method="post">
        <AntiforgeryToken />
        <div>
            <p>
                @foreach (var provider in _otherLogins)
                {
                    <button type="submit" class="btn btn-primary" name="Provider" value="@provider.Name" title="Log in using your @provider.DisplayName account">
                        @provider.DisplayName
                    </button>
                }
            </p>
        </div>
    </form>
}

@code {
    public const string _linkLoginCallbackAction = "LinkLoginCallback";

    private ApplicationUser _user = default!;
    private IList<UserLoginInfo>? _currentLogins;
    private IList<AuthenticationScheme>? _otherLogins;
    private bool _showRemoveButton;

    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    [SupplyParameterFromForm]
    private string? LoginProvider { get; set; }

    [SupplyParameterFromForm]
    private string? ProviderKey { get; set; }

    [SupplyParameterFromQuery]
    private string? Action { get; set; }

    protected override async Task OnInitializedAsync()
    {
        _user = await UserAccessor.GetRequiredUserAsync(HttpContext);
        _currentLogins = await UserManager.GetLoginsAsync(_user);
        _otherLogins = (await SignInManager.GetExternalAuthenticationSchemesAsync())
            .Where(auth => _currentLogins.All(ul => auth.Name != ul.LoginProvider))
            .ToList();

        string? passwordHash = null;
        if (UserStore is IUserPasswordStore<ApplicationUser> userPasswordStore)
        {
            passwordHash = await userPasswordStore.GetPasswordHashAsync(_user, HttpContext.RequestAborted);
        }

        _showRemoveButton = passwordHash is not null || _currentLogins.Count > 1;

        if (HttpMethods.IsGet(HttpContext.Request.Method) && Action == _linkLoginCallbackAction)
        {
            await OnGetLinkLoginCallbackAsync();
        }
    }

    private async Task OnSubmitAsync()
    {
        var result = await UserManager.RemoveLoginAsync(_user, LoginProvider!, ProviderKey!);
        if (!result.Succeeded)
        {
            Redirect.ToCurrentPageWithStatus("Error: The external login was not removed.", HttpContext);
        }

        await SignInManager.RefreshSignInAsync(_user);
        Redirect.ToCurrentPageWithStatus("The external login was removed.", HttpContext);
    }

    private async Task OnGetLinkLoginCallbackAsync()
    {
        var userId = await UserManager.GetUserIdAsync(_user);
        var info = await SignInManager.GetExternalLoginInfoAsync(userId);
        if (info is null)
        {
            Redirect.ToCurrentPageWithStatus("Error: Could not load external login info.", HttpContext);
        }

        var result = await UserManager.AddLoginAsync(_user, info);
        if (!result.Succeeded)
        {
            Redirect.ToCurrentPageWithStatus("Error: The external login was not added. External logins can only be associated with one account.", HttpContext);
        }

        // Clear the existing external cookie to ensure a clean login process
        await HttpContext.SignOutAsync(IdentityConstants.ExternalScheme);

        Redirect.ToCurrentPageWithStatus("The external login was added.", HttpContext);
    }
}
 
---------------------------------------------------------------------------------------- 
WebApp\Components\Account\Pages\Manage\GenerateRecoveryCodes.razor 
@page "/Account/Manage/GenerateRecoveryCodes"

@inject UserManager<ApplicationUser> UserManager
@inject UserAccessor UserAccessor
@inject Redirect Redirect
@inject ILogger<GenerateRecoveryCodes> Logger

@if (_recoveryCodes is not null)
{
    <ShowRecoveryCodes RecoveryCodes="_recoveryCodes.ToArray()" StatusMessage="@_message" />
}
else
{
    <h3>Generate two-factor authentication (2FA) recovery codes</h3>
    <div class="alert alert-warning" role="alert">
        <p>
            <span class="glyphicon glyphicon-warning-sign"></span>
            <strong>Put these codes in a safe place.</strong>
        </p>
        <p>
            If you lose your device and don't have the recovery codes you will lose access to your account.
        </p>
        <p>
            Generating new recovery codes does not change the keys used in authenticator apps. If you wish to change the key
            used in an authenticator app you should <a href="Account/Manage/ResetAuthenticator">reset your authenticator keys.</a>
        </p>
    </div>
    <div>
        <form @formname="generate-recovery-codes" @onsubmit="OnSubmitAsync" method="post">
            <AntiforgeryToken />
            <button class="btn btn-danger" type="submit">Generate Recovery Codes</button>
        </form>
    </div>
}

@code {
    private string? _message;
    private ApplicationUser _user = default!;
    private IEnumerable<string>? _recoveryCodes;

    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        _user = await UserAccessor.GetRequiredUserAsync(HttpContext);

        var isTwoFactorEnabled = await UserManager.GetTwoFactorEnabledAsync(_user);
        if (!isTwoFactorEnabled)
        {
            throw new InvalidOperationException("Cannot generate recovery codes for user because they do not have 2FA enabled.");
        }
    }

    private async Task OnSubmitAsync()
    {
        var userId = await UserManager.GetUserIdAsync(_user);
        _recoveryCodes = await UserManager.GenerateNewTwoFactorRecoveryCodesAsync(_user, 10);
        _message = "You have generated new recovery codes.";

        Logger.LogInformation("User with ID '{UserId}' has generated new 2FA recovery codes.", userId);
    }
}
 
---------------------------------------------------------------------------------------- 
WebApp\Components\Account\Pages\Manage\Index.razor 
@page "/Account/Manage"

@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager
@inject UserAccessor UserAccessor
@inject Redirect Redirect

<h3>Profile</h3>
<StatusMessage />

<div class="row">
    <div class="col-md-6">
        <EditForm Model="Input" FormName="profile" OnValidSubmit="OnValidSubmitAsync" method="post">
            <DataAnnotationsValidator />
            <ValidationSummary class="text-danger" role="alert" />
            <div class="form-floating mb-3">
                <input type="text" value="@_username" class="form-control" placeholder="Please choose your username." disabled />
                <label for="username" class="form-label">Username</label>
            </div>
            <div class="form-floating mb-3">
                <InputText @bind-Value="Input.PhoneNumber" class="form-control" placeholder="Please enter your phone number." />
                <label for="phone-number" class="form-label">Phone number</label>
                <ValidationMessage For="() => Input.PhoneNumber" class="text-danger" />
            </div>
            <button type="submit" class="w-100 btn btn-lg btn-primary">Save</button>
        </EditForm>
    </div>
</div>

@code {
    private ApplicationUser _user = default!;
    private string? _username;
    private string? _phoneNumber;

    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    [SupplyParameterFromForm]
    private InputModel Input { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        _user = await UserAccessor.GetRequiredUserAsync(HttpContext);
        _username = await UserManager.GetUserNameAsync(_user);
        _phoneNumber = await UserManager.GetPhoneNumberAsync(_user);

        Input.PhoneNumber ??= _phoneNumber;
    }

    private async Task OnValidSubmitAsync()
    {
        if (Input.PhoneNumber != _phoneNumber)
        {
            var setPhoneResult = await UserManager.SetPhoneNumberAsync(_user, Input.PhoneNumber);
            if (!setPhoneResult.Succeeded)
            {
                Redirect.ToCurrentPageWithStatus("Error: Failed to set phone number.", HttpContext);
            }
        }

        await SignInManager.RefreshSignInAsync(_user);
        Redirect.ToCurrentPageWithStatus("Your profile has been updated", HttpContext);
    }

    private sealed class InputModel
    {
        [Phone]
        [Display(Name = "Phone number")]
        public string? PhoneNumber { get; set; }
    }
}
 
---------------------------------------------------------------------------------------- 
WebApp\Components\Account\Pages\Manage\PersonalData.razor 
@page "/Account/Manage/PersonalData"

@inject UserAccessor UserAccessor

<StatusMessage />
<h3>Personal Data</h3>

<div class="row">
    <div class="col-md-6">
        <p>Your account contains personal data that you have given us. This page allows you to download or delete that data.</p>
        <p>
            <strong>Deleting this data will permanently remove your account, and this cannot be recovered.</strong>
        </p>
        <form action="Account/Manage/DownloadPersonalData" method="post">
            <AntiforgeryToken />
            <button class="btn btn-primary" type="submit">Download</button>
        </form>
        <p>
            <a href="Account/Manage/DeletePersonalData" class="btn btn-danger">Delete</a>
        </p>
    </div>
</div>

@code {
    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        _ = await UserAccessor.GetRequiredUserAsync(HttpContext);
    }
}
 
---------------------------------------------------------------------------------------- 
WebApp\Components\Account\Pages\Manage\ResetAuthenticator.razor 
@page "/Account/Manage/ResetAuthenticator"

@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager
@inject UserAccessor UserAccessor
@inject Redirect Redirect
@inject ILogger<ResetAuthenticator> Logger

<StatusMessage />
<h3>Reset authenticator key</h3>
<div class="alert alert-warning" role="alert">
    <p>
        <span class="glyphicon glyphicon-warning-sign"></span>
        <strong>If you reset your authenticator key your authenticator app will not work until you reconfigure it.</strong>
    </p>
    <p>
        This process disables 2FA until you verify your authenticator app.
        If you do not complete your authenticator app configuration you may lose access to your account.
    </p>
</div>
<div>
    <form @formname="reset-authenticator" @onsubmit="OnSubmitAsync" method="post">
        <AntiforgeryToken />
        <button class="btn btn-danger" type="submit">Reset authenticator key</button>
    </form>
</div>

@code {
    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    private async Task OnSubmitAsync()
    {
        var user = await UserAccessor.GetRequiredUserAsync(HttpContext);
        await UserManager.SetTwoFactorEnabledAsync(user, false);
        await UserManager.ResetAuthenticatorKeyAsync(user);
        var userId = await UserManager.GetUserIdAsync(user);
        Logger.LogInformation("User with ID '{UserId}' has reset their authentication app key.", userId);

        await SignInManager.RefreshSignInAsync(user);

        Redirect.ToWithStatus(
            "Account/Manage/EnableAuthenticator",
            "Your authenticator app key has been reset, you will need to configure your authenticator app using the new key.",
            HttpContext);
    }
}
 
---------------------------------------------------------------------------------------- 
WebApp\Components\Account\Pages\Manage\SetPassword.razor 
@page "/Account/Manage/SetPassword"

@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager
@inject UserAccessor UserAccessor
@inject Redirect Redirect

<h3>Set your password</h3>
<StatusMessage Message="@_message" />
<p class="text-info">
    You do not have a local username/password for this site. Add a local
    account so you can log in without an external login.
</p>
<div class="row">
    <div class="col-md-6">
        <EditForm Model="Input" FormName="set-password" OnValidSubmit="OnValidSubmitAsync" method="post">
            <DataAnnotationsValidator />
            <ValidationSummary class="text-danger" role="alert" />
            <div class="form-floating mb-3">
                <InputText type="password" @bind-Value="Input.NewPassword" class="form-control" autocomplete="new-password" placeholder="Please enter your new password." />
                <label for="new-password" class="form-label">New password</label>
                <ValidationMessage For="() => Input.NewPassword" class="text-danger" />
            </div>
            <div class="form-floating mb-3">
                <InputText type="password" @bind-Value="Input.ConfirmPassword" class="form-control" autocomplete="new-password" placeholder="Please confirm your new password." />
                <label for="confirm-password" class="form-label">Confirm password</label>
                <ValidationMessage For="() => Input.ConfirmPassword" class="text-danger" />
            </div>
            <button type="submit" class="w-100 btn btn-lg btn-primary">Set password</button>
        </EditForm>
     </div>
</div>

@code {
    private string? _message;
    private ApplicationUser _user = default!;

    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    [SupplyParameterFromForm]
    private InputModel Input { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        _user = await UserAccessor.GetRequiredUserAsync(HttpContext);

        var hasPassword = await UserManager.HasPasswordAsync(_user);
        if (hasPassword)
        {
            Redirect.To("Account/Manage/ChangePassword");
        }
    }

    private async Task OnValidSubmitAsync()
    {
        var addPasswordResult = await UserManager.AddPasswordAsync(_user, Input.NewPassword!);
        if (!addPasswordResult.Succeeded)
        {
            _message = $"Error: {string.Join(",", addPasswordResult.Errors.Select(error => error.Description))}";
            return;
        }

        await SignInManager.RefreshSignInAsync(_user);
        Redirect.ToCurrentPageWithStatus("Your password has been set.", HttpContext);
    }

    private sealed class InputModel
    {
        [Required]
        [StringLength(100, ErrorMessage = "The {0} must be at least {2} and at max {1} characters long.", MinimumLength = 6)]
        [DataType(DataType.Password)]
        [Display(Name = "New password")]
        public string? NewPassword { get; set; }

        [DataType(DataType.Password)]
        [Display(Name = "Confirm new password")]
        [Compare("NewPassword", ErrorMessage = "The new password and confirmation password do not match.")]
        public string? ConfirmPassword { get; set; }
    }
}
 
---------------------------------------------------------------------------------------- 
WebApp\Components\Account\Pages\Manage\TwoFactorAuthentication.razor 
@page "/Account/Manage/TwoFactorAuthentication"

@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager
@inject UserAccessor UserAccessor
@inject Redirect Redirect

<StatusMessage />
<h3>Two-factor authentication (2FA)</h3>
@if (_canTrack)
{
    if (_is2FaEnabled)
    {
        if (_recoveryCodesLeft == 0)
        {
            <div class="alert alert-danger">
                <strong>You have no recovery codes left.</strong>
                <p>You must <a href="Account/Manage/GenerateRecoveryCodes">generate a new set of recovery codes</a> before you can log in with a recovery code.</p>
            </div>
        }
        else if (_recoveryCodesLeft == 1)
        {
            <div class="alert alert-danger">
                <strong>You have 1 recovery code left.</strong>
                <p>You can <a href="Account/Manage/GenerateRecoveryCodes">generate a new set of recovery codes</a>.</p>
            </div>
        }
        else if (_recoveryCodesLeft <= 3)
        {
            <div class="alert alert-warning">
                <strong>You have @_recoveryCodesLeft recovery codes left.</strong>
                <p>You should <a href="Account/Manage/GenerateRecoveryCodes">generate a new set of recovery codes</a>.</p>
            </div>
        }

        if (_isMachineRemembered)
        {
            <form style="display: inline-block" @formname="forget-browser" @onsubmit="OnSubmitForgetBrowserAsync" method="post">
                <AntiforgeryToken />
                <button type="submit" class="btn btn-primary">Forget this browser</button>
            </form>
        }

        <a href="Account/Manage/Disable2fa" class="btn btn-primary">Disable 2FA</a>
        <a href="Account/Manage/GenerateRecoveryCodes" class="btn btn-primary">Reset recovery codes</a>
    }

    <h4>Authenticator app</h4>
    @if (!_hasAuthenticator)
    {
        <a href="Account/Manage/EnableAuthenticator" class="btn btn-primary">Add authenticator app</a>
    }
    else
    {
        <a href="Account/Manage/EnableAuthenticator" class="btn btn-primary">Set up authenticator app</a>
        <a href="Account/Manage/ResetAuthenticator" class="btn btn-primary">Reset authenticator app</a>
    }
}
else
{
    <div class="alert alert-danger">
        <strong>Privacy and cookie policy have not been accepted.</strong>
        <p>You must accept the policy before you can enable two factor authentication.</p>
    </div>
}

@code {
    private bool _canTrack;
    private bool _hasAuthenticator;
    private int _recoveryCodesLeft;
    private bool _is2FaEnabled;
    private bool _isMachineRemembered;

    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        var user = await UserAccessor.GetRequiredUserAsync(HttpContext);
        _canTrack = HttpContext.Features.Get<ITrackingConsentFeature>()?.CanTrack ?? true;
        _hasAuthenticator = await UserManager.GetAuthenticatorKeyAsync(user) is not null;
        _is2FaEnabled = await UserManager.GetTwoFactorEnabledAsync(user);
        _isMachineRemembered = await SignInManager.IsTwoFactorClientRememberedAsync(user);
        _recoveryCodesLeft = await UserManager.CountRecoveryCodesAsync(user);
    }

    private async Task OnSubmitForgetBrowserAsync()
    {
        await SignInManager.ForgetTwoFactorClientAsync();

        Redirect.ToCurrentPageWithStatus(
            "The current browser has been forgotten. When you login again from this browser you will be prompted for your 2fa code.",
            HttpContext);
    }
}
 
---------------------------------------------------------------------------------------- 
WebApp\Components\Account\Pages\Manage\_Imports.razor 
@layout ManageLayout
@attribute [Microsoft.AspNetCore.Authorization.Authorize]
 
---------------------------------------------------------------------------------------- 
WebApp\Components\Account\Shared\AccountLayout.razor 
@inherits LayoutComponentBase
@layout Layout.MainLayout
@inject NavigationManager NavigationManager

@if (HttpContext is null)
{
    <p>Loading...</p>
}
else
{
    @Body
}

@code {
    [CascadingParameter]
    private HttpContext? HttpContext { get; set; }

    protected override void OnParametersSet()
    {
        if (HttpContext is null)
        {
            // If this code runs, we're currently rendering in interactive mode, so there is no HttpContext.
            // The identity pages need to set cookies, so they require an HttpContext. To achieve this we
            // must transition back from interactive mode to a server-rendered page.
            NavigationManager.Refresh(forceReload: true);
        }
    }
}
 
---------------------------------------------------------------------------------------- 
WebApp\Components\Account\Shared\ExternalLoginPicker.razor 
@inject SignInManager<ApplicationUser> SignInManager
@inject Redirect Redirect

@if (_externalLogins.Length == 0)
{
    <div>
        <p>
            There are no external authentication services configured. See this <a href="https://go.microsoft.com/fwlink/?LinkID=532715">article
            about setting up this ASP.NET application to support logging in via external services</a>.
        </p>
    </div>
}
else
{
    <form class="form-horizontal" action="Account/PerformExternalLogin" method="post">
        <div>
            <AntiforgeryToken />
            <input type="hidden" name="ReturnUrl" value="@ReturnUrl" />
            <p>
                @foreach (var provider in _externalLogins)
                {
                    <button type="submit" class="btn btn-primary" name="provider" value="@provider.Name" title="Log in using your @provider.DisplayName account">@provider.DisplayName</button>
                }
            </p>
        </div>
    </form>
}

@code {
    private AuthenticationScheme[] _externalLogins = [];

    [SupplyParameterFromQuery]
    private string? ReturnUrl { get; set; }

    protected override async Task OnInitializedAsync()
    {
        _externalLogins = (await SignInManager.GetExternalAuthenticationSchemesAsync()).ToArray();
    }
}
 
---------------------------------------------------------------------------------------- 
WebApp\Components\Account\Shared\ManageLayout.razor 
@inherits LayoutComponentBase
@layout AccountLayout

<h1>Manage your account</h1>

<div>
    <h2>Change your account settings</h2>
    <hr />
    <div class="row">
        <div class="col-md-3">
            <ManageNavMenu />
        </div>
        <div class="col-md-9">
            @Body
        </div>
    </div>
</div>
 
---------------------------------------------------------------------------------------- 
WebApp\Components\Account\Shared\ManageNavMenu.razor 
@inject SignInManager<ApplicationUser> SignInManager

<ul class="nav nav-pills flex-column">
    <li class="nav-item">
        <NavLink class="nav-link" href="Account/Manage" Match="NavLinkMatch.All">Profile</NavLink>
    </li>
    <li class="nav-item">
        <NavLink class="nav-link" href="Account/Manage/Email">Email</NavLink>
    </li>
    <li class="nav-item">
        <NavLink class="nav-link" href="Account/Manage/ChangePassword">Password</NavLink>
    </li>
    @if (_hasExternalLogins)
    {
        <li class="nav-item">
            <NavLink class="nav-link" href="Account/Manage/ExternalLogins">External logins</NavLink>
        </li>
    }
    <li class="nav-item">
        <NavLink class="nav-link" href="Account/Manage/TwoFactorAuthentication">Two-factor authentication</NavLink>
    </li>
    <li class="nav-item">
        <NavLink class="nav-link" href="Account/Manage/PersonalData">Personal data</NavLink>
    </li>
</ul>

@code {
    private bool _hasExternalLogins;

    protected override async Task OnInitializedAsync()
    {
        _hasExternalLogins = (await SignInManager.GetExternalAuthenticationSchemesAsync()).Any();
    }
}
 
---------------------------------------------------------------------------------------- 
WebApp\Components\Account\Shared\RedirectToLogin.razor 
@inject NavigationManager NavigationManager

@code {
    protected override void OnInitialized()
    {
        NavigationManager.NavigateTo($"Account/Login?returnUrl={Uri.EscapeDataString(NavigationManager.Uri)}", forceLoad: true);
    }
}
 
---------------------------------------------------------------------------------------- 
WebApp\Components\Account\Shared\ShowRecoveryCodes.razor 
<StatusMessage Message="@StatusMessage" />
<h3>Recovery codes</h3>
<div class="alert alert-warning" role="alert">
    <p>
        <strong>Put these codes in a safe place.</strong>
    </p>
    <p>
        If you lose your device and don't have the recovery codes you will lose access to your account.
    </p>
</div>
<div class="row">
    <div class="col-md-12">
        @foreach (var recoveryCode in RecoveryCodes)
        {
            <div>
                <code class="recovery-code">@recoveryCode</code>
            </div>
        }
    </div>
</div>

@code {
    [Parameter]
    public string[] RecoveryCodes { get; set; } = [];

    [Parameter]
    public string? StatusMessage { get; set; }
}
 
---------------------------------------------------------------------------------------- 
WebApp\Components\Account\Shared\StatusMessage.razor 
@if (!string.IsNullOrEmpty(DisplayMessage))
{
    var statusMessageClass = DisplayMessage.StartsWith("Error") ? "danger" : "success";
    <div class="alert alert-@statusMessageClass" role="alert">
        @DisplayMessage
    </div>
}

@code {
    private string? _messageFromCookie;

    [Parameter]
    public string? Message { get; set; }

    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    private string? DisplayMessage => Message ?? _messageFromCookie;

    protected override void OnInitialized()
    {
        _messageFromCookie = HttpContext.Request.Cookies[Redirect.StatusCookieName];

        if (_messageFromCookie is not null)
        {
            HttpContext.Response.Cookies.Delete(Redirect.StatusCookieName);
        }
    }
}
 
---------------------------------------------------------------------------------------- 
WebApp\Components\Layout\MainLayout.razor 
@inherits LayoutComponentBase

<PageTitle>Sophia</PageTitle>

<div class="page">
    <NavMenu />
    <main>
        <article class="content px-4">
            @Body
        </article>
    </main>
</div>

<div id="blazor-error-ui">
    An unhandled error has occurred.
    <a href="" class="reload">Reload</a>
    <a class="dismiss"></a>
</div>
 
---------------------------------------------------------------------------------------- 
WebApp\Components\Layout\MainLayout.razor.css 
.page {
    position: relative;
    display: flex;
    flex-direction: column;
}

main {
    flex: 1;
}

.top-row {
    background-color: #f7f7f7;
    border-bottom: 1px solid #d6d5d5;
    justify-content: flex-end;
    height: 3.5rem;
    display: flex;
    align-items: center;
}

    .top-row ::deep a, .top-row ::deep .btn-link {
        white-space: nowrap;
        margin-left: 1.5rem;
        text-decoration: none;
    }

    .top-row ::deep a:hover, .top-row ::deep .btn-link:hover {
        text-decoration: underline;
    }

    .top-row ::deep a:first-child {
        overflow: hidden;
        text-overflow: ellipsis;
    }

@media (max-width: 640.98px) {
    .top-row {
        justify-content: space-between;
    }

    .top-row ::deep a, .top-row ::deep .btn-link {
        margin-left: 0;
    }
}

@media (min-width: 641px) {
    .page {
        flex-direction: row;
    }

    .top-row {
        position: sticky;
        top: 0;
        z-index: 1;
    }

    .top-row.auth ::deep a:first-child {
        flex: 1;
        text-align: right;
        width: 0;
    }

    .top-row, article {
        padding-left: 2rem !important;
        padding-right: 1.5rem !important;
    }
}

#blazor-error-ui {
    background: lightyellow;
    bottom: 0;
    box-shadow: 0 -1px 2px rgba(0, 0, 0, 0.2);
    display: none;
    left: 0;
    padding: 0.6rem 1.25rem 0.7rem 1.25rem;
    position: fixed;
    width: 100%;
    z-index: 1000;
}

    #blazor-error-ui .dismiss {
        cursor: pointer;
        position: absolute;
        right: 0.75rem;
        top: 0.5rem;
    }
 
---------------------------------------------------------------------------------------- 
WebApp\Data\ApplicationDbContext.cs 
namespace Sophia.WebApp.Data;
public class ApplicationDbContext(DbContextOptions<ApplicationDbContext> options)
    : IdentityDbContext<ApplicationUser>(options) {

    public required DbSet<WorldEntity> Worlds { get; set; }
    public required DbSet<ToolEntity> Tools { get; set; }
    public required DbSet<PersonaEntity> Personas { get; set; }

    protected override void OnModelCreating(ModelBuilder builder) {
        base.OnModelCreating(builder);
        builder.Entity<WorldEntity>();
        builder.Entity<ToolEntity>();
        builder.Entity<PersonaEntity>();
    }

    public static async Task Seed(IServiceProvider services) {
        await using var scope = services.CreateAsyncScope();
        var dbContext = scope.ServiceProvider.GetRequiredService<ApplicationDbContext>();
        await dbContext.Database.EnsureCreatedAsync();
        await dbContext.Database.MigrateAsync();
        await WorldEntity.Seed(dbContext);
        await dbContext.SaveChangesAsync();
    }
}
 
---------------------------------------------------------------------------------------- 
WebApp\Data\ApplicationUser.cs 
namespace Sophia.WebApp.Data;

public class ApplicationUser : IdentityUser;

 
---------------------------------------------------------------------------------------- 
WebApp\Data\Mapper.cs 
namespace Sophia.WebApp.Data;

public static class Mapper {
    public static WorldEntity ToEntity(this WorldData input)
        => new() {
            Location = input.Location,
            UserProfile = input.UserProfile.ToEntity(),
            Facts = input.Facts.ToList(i => i.ToEntity()),
            Tools = input.Tools.ToList(i => i.ToEntity()),
        };
    public static void UpdateFrom(this WorldEntity target, WorldData input) {
        target.Location = input.Location;
        target.UserProfile = input.UserProfile.ToEntity();
        target.Facts = input.Facts.ToList(i => i.ToEntity());
        target.Tools = input.Tools.ToList(i => i.AddOrUpdate(target.Tools));
    }

    public static FactEntity ToEntity(this FactData input)
        => new() {
                     DefaultText = input.DefaultText,
                     Value = input.Value,
                     ValueTemplate = input.ValueTemplate,
                 };

    public static UserProfileEntity ToEntity(this UserProfileData input)
        => new() {
            Name = input.Name,
            Language = input.Language,
        };

    public static ToolEntity ToEntity(this ToolData input)
        => new() {
            Name = input.Name,
            Description = input.Description,
            Arguments = input.Arguments.AsIndexed().ToList(i => i.Value.ToEntity(i.Index)),
        };

    public static void UpdateFrom(this ToolEntity target, ToolData input) {
        target.Name = input.Name;
        target.Description = input.Description;
        target.Arguments = input.Arguments.AsIndexed().ToList(i => i.Value.ToEntity(i.Index));
    }

    public static ToolEntity AddOrUpdate(this ToolData input, IReadOnlyList<ToolEntity> originalItems) {
        var originalItem = originalItems.FirstOrDefault(i => i.Id == input.Id);
        if (originalItem is null) return input.ToEntity();
        originalItem.UpdateFrom(input);
        return originalItem;
    }

    public static ArgumentEntity ToEntity(this ArgumentData input, int index)
        => new() {
            Index = index,
            Name = input.Name,
            Description = input.Description,
            Type = input.Type,
            Choices = input.Type != ArgumentType.Enum ? [] : [.. input.Choices],
            IsRequired = input.IsRequired,
        };

    public static PersonaEntity ToEntity(this PersonaData input)
        => new() {
            Name = input.Name,
            Description = input.Description,
            Personality = input.Personality,
            Instructions = [..input.Instructions],
            Facts = input.Facts.ToList(i => i.ToEntity()),
            KnownTools = input.KnownTools.ToList(i => i.ToEntity()),

        };

    public static void UpdateFrom(this PersonaEntity target, PersonaData input) {
        target.Name = input.Name;
        target.Description = input.Description;
        target.Personality = input.Personality;
        target.Instructions = [..input.Instructions];
        target.Facts = input.Facts.ToList(i => i.ToEntity());
        target.KnownTools = input.KnownTools.ToList(i => i.ToEntity());
    }
}
 
---------------------------------------------------------------------------------------- 
WebApp\Data\Common\FactEntity.cs 
namespace Sophia.WebApp.Data.Common;

[Table("Facts")]
[EntityTypeConfiguration(typeof(FactEntity))]
public class FactEntity
    : IEntityTypeConfiguration<FactEntity> {
    [Key]
    [DatabaseGenerated(DatabaseGeneratedOption.Identity)]
    public int Id { get; set; }

    [MaxLength(1000)]
    public string? DefaultText { get; set; }

    [MaxLength(100)]
    public string? Value { get; set; }

    [MaxLength(1000)]
    [Required(AllowEmptyStrings = false)]
    public string ValueTemplate { get; set; } = "{0}";

    public void Configure(EntityTypeBuilder<FactEntity> builder)
        => builder.Property(f => f.ValueTemplate)
                  .HasDefaultValue("{0}");

    public FactData ToDto()
        => new() {
            DefaultText = DefaultText,
            Value = Value,
            ValueTemplate = ValueTemplate,
        };
}
 
---------------------------------------------------------------------------------------- 
WebApp\Data\Helpers\StringArrayComparer.cs 
namespace Sophia.WebApp.Data.Helpers;

internal class StringArrayComparer()
    : ValueComparer<string[]>((a, b) => a != null && b != null && a.SequenceEqual(b, new StringArrayItemComparer()),
                              s => s.Aggregate(0, HashCode.Combine));
 
---------------------------------------------------------------------------------------- 
WebApp\Data\Helpers\StringArrayConversion.cs 
namespace Sophia.WebApp.Data.Helpers;

public class StringArrayConversion {
    internal static string[] ConvertToArray(string? s)
        => s == null ? [] : s.Split('|');

    internal static string? ConvertToString(string[] choices)
        => choices.Length == 0 ? null : string.Join('|', choices);
}
 
---------------------------------------------------------------------------------------- 
WebApp\Data\Helpers\StringArrayItemComparer.cs 
namespace Sophia.WebApp.Data.Helpers;

internal class StringArrayItemComparer()
    : ValueComparer<string>((a, b) => a != null && a.Equals(b, StringComparison.InvariantCultureIgnoreCase),
                            s => s.GetHashCode()); 
---------------------------------------------------------------------------------------- 
WebApp\Data\Migrations\00000000000000_CreateIdentitySchema.cs 
#nullable disable

namespace Sophia.WebApp.Migrations;
/// <inheritdoc />
public partial class CreateIdentitySchema : Migration {
    /// <inheritdoc />
    protected override void Up(MigrationBuilder migrationBuilder) {
        migrationBuilder.CreateTable(
            name: "AspNetRoles",
            columns: table => new {
                Id = table.Column<string>(type: "nvarchar(450)", nullable: false),
                Name = table.Column<string>(type: "nvarchar(256)", maxLength: 256, nullable: true),
                NormalizedName = table.Column<string>(type: "nvarchar(256)", maxLength: 256, nullable: true),
                ConcurrencyStamp = table.Column<string>(type: "nvarchar(max)", nullable: true)
            },
            constraints: table => table.PrimaryKey("PK_AspNetRoles", x => x.Id));

        migrationBuilder.CreateTable(
            name: "AspNetUsers",
            columns: table => new {
                Id = table.Column<string>(type: "nvarchar(450)", nullable: false),
                UserName = table.Column<string>(type: "nvarchar(256)", maxLength: 256, nullable: true),
                NormalizedUserName = table.Column<string>(type: "nvarchar(256)", maxLength: 256, nullable: true),
                Email = table.Column<string>(type: "nvarchar(256)", maxLength: 256, nullable: true),
                NormalizedEmail = table.Column<string>(type: "nvarchar(256)", maxLength: 256, nullable: true),
                EmailConfirmed = table.Column<bool>(type: "bit", nullable: false),
                PasswordHash = table.Column<string>(type: "nvarchar(max)", nullable: true),
                SecurityStamp = table.Column<string>(type: "nvarchar(max)", nullable: true),
                ConcurrencyStamp = table.Column<string>(type: "nvarchar(max)", nullable: true),
                PhoneNumber = table.Column<string>(type: "nvarchar(max)", nullable: true),
                PhoneNumberConfirmed = table.Column<bool>(type: "bit", nullable: false),
                TwoFactorEnabled = table.Column<bool>(type: "bit", nullable: false),
                LockoutEnd = table.Column<DateTimeOffset>(type: "datetimeoffset", nullable: true),
                LockoutEnabled = table.Column<bool>(type: "bit", nullable: false),
                AccessFailedCount = table.Column<int>(type: "int", nullable: false)
            },
            constraints: table => table.PrimaryKey("PK_AspNetUsers", x => x.Id));

        migrationBuilder.CreateTable(
            name: "AspNetRoleClaims",
            columns: table => new {
                Id = table.Column<int>(type: "int", nullable: false)
                    .Annotation("SqlServer:Identity", "1, 1"),
                RoleId = table.Column<string>(type: "nvarchar(450)", nullable: false),
                ClaimType = table.Column<string>(type: "nvarchar(max)", nullable: true),
                ClaimValue = table.Column<string>(type: "nvarchar(max)", nullable: true)
            },
            constraints: table => {
                table.PrimaryKey("PK_AspNetRoleClaims", x => x.Id);
                table.ForeignKey(
                    name: "FK_AspNetRoleClaims_AspNetRoles_RoleId",
                    column: x => x.RoleId,
                    principalTable: "AspNetRoles",
                    principalColumn: "Id",
                    onDelete: ReferentialAction.Cascade);
            });

        migrationBuilder.CreateTable(
            name: "AspNetUserClaims",
            columns: table => new {
                Id = table.Column<int>(type: "int", nullable: false)
                    .Annotation("SqlServer:Identity", "1, 1"),
                UserId = table.Column<string>(type: "nvarchar(450)", nullable: false),
                ClaimType = table.Column<string>(type: "nvarchar(max)", nullable: true),
                ClaimValue = table.Column<string>(type: "nvarchar(max)", nullable: true)
            },
            constraints: table => {
                table.PrimaryKey("PK_AspNetUserClaims", x => x.Id);
                table.ForeignKey(
                    name: "FK_AspNetUserClaims_AspNetUsers_UserId",
                    column: x => x.UserId,
                    principalTable: "AspNetUsers",
                    principalColumn: "Id",
                    onDelete: ReferentialAction.Cascade);
            });

        migrationBuilder.CreateTable(
            name: "AspNetUserLogins",
            columns: table => new {
                LoginProvider = table.Column<string>(type: "nvarchar(450)", nullable: false),
                ProviderKey = table.Column<string>(type: "nvarchar(450)", nullable: false),
                ProviderDisplayName = table.Column<string>(type: "nvarchar(max)", nullable: true),
                UserId = table.Column<string>(type: "nvarchar(450)", nullable: false)
            },
            constraints: table => {
                table.PrimaryKey("PK_AspNetUserLogins", x => new { x.LoginProvider, x.ProviderKey });
                table.ForeignKey(
                    name: "FK_AspNetUserLogins_AspNetUsers_UserId",
                    column: x => x.UserId,
                    principalTable: "AspNetUsers",
                    principalColumn: "Id",
                    onDelete: ReferentialAction.Cascade);
            });

        migrationBuilder.CreateTable(
            name: "AspNetUserRoles",
            columns: table => new {
                UserId = table.Column<string>(type: "nvarchar(450)", nullable: false),
                RoleId = table.Column<string>(type: "nvarchar(450)", nullable: false)
            },
            constraints: table => {
                table.PrimaryKey("PK_AspNetUserRoles", x => new { x.UserId, x.RoleId });
                table.ForeignKey(
                    name: "FK_AspNetUserRoles_AspNetRoles_RoleId",
                    column: x => x.RoleId,
                    principalTable: "AspNetRoles",
                    principalColumn: "Id",
                    onDelete: ReferentialAction.Cascade);
                table.ForeignKey(
                    name: "FK_AspNetUserRoles_AspNetUsers_UserId",
                    column: x => x.UserId,
                    principalTable: "AspNetUsers",
                    principalColumn: "Id",
                    onDelete: ReferentialAction.Cascade);
            });

        migrationBuilder.CreateTable(
            name: "AspNetUserTokens",
            columns: table => new {
                UserId = table.Column<string>(type: "nvarchar(450)", nullable: false),
                LoginProvider = table.Column<string>(type: "nvarchar(450)", nullable: false),
                Name = table.Column<string>(type: "nvarchar(450)", nullable: false),
                Value = table.Column<string>(type: "nvarchar(max)", nullable: true)
            },
            constraints: table => {
                table.PrimaryKey("PK_AspNetUserTokens", x => new { x.UserId, x.LoginProvider, x.Name });
                table.ForeignKey(
                    name: "FK_AspNetUserTokens_AspNetUsers_UserId",
                    column: x => x.UserId,
                    principalTable: "AspNetUsers",
                    principalColumn: "Id",
                    onDelete: ReferentialAction.Cascade);
            });

        migrationBuilder.CreateIndex(
            name: "IX_AspNetRoleClaims_RoleId",
            table: "AspNetRoleClaims",
            column: "RoleId");

        migrationBuilder.CreateIndex(
            name: "RoleNameIndex",
            table: "AspNetRoles",
            column: "NormalizedName",
            unique: true,
            filter: "[NormalizedName] IS NOT NULL");

        migrationBuilder.CreateIndex(
            name: "IX_AspNetUserClaims_UserId",
            table: "AspNetUserClaims",
            column: "UserId");

        migrationBuilder.CreateIndex(
            name: "IX_AspNetUserLogins_UserId",
            table: "AspNetUserLogins",
            column: "UserId");

        migrationBuilder.CreateIndex(
            name: "IX_AspNetUserRoles_RoleId",
            table: "AspNetUserRoles",
            column: "RoleId");

        migrationBuilder.CreateIndex(
            name: "EmailIndex",
            table: "AspNetUsers",
            column: "NormalizedEmail");

        migrationBuilder.CreateIndex(
            name: "UserNameIndex",
            table: "AspNetUsers",
            column: "NormalizedUserName",
            unique: true,
            filter: "[NormalizedUserName] IS NOT NULL");
    }

    /// <inheritdoc />
    protected override void Down(MigrationBuilder migrationBuilder) {
        migrationBuilder.DropTable(
            name: "AspNetRoleClaims");

        migrationBuilder.DropTable(
            name: "AspNetUserClaims");

        migrationBuilder.DropTable(
            name: "AspNetUserLogins");

        migrationBuilder.DropTable(
            name: "AspNetUserRoles");

        migrationBuilder.DropTable(
            name: "AspNetUserTokens");

        migrationBuilder.DropTable(
            name: "AspNetRoles");

        migrationBuilder.DropTable(
            name: "AspNetUsers");
    }
}
 
---------------------------------------------------------------------------------------- 
WebApp\Data\Migrations\00000000000000_CreateIdentitySchema.Designer.cs 
// <auto-generated />
#nullable disable

using Sophia.WebApp.Data;

namespace Sophia.WebApp.Migrations;
[DbContext(typeof(ApplicationDbContext))]
[Migration("00000000000000_CreateIdentitySchema")]
partial class CreateIdentitySchema {
    /// <inheritdoc />
    protected override void BuildTargetModel(ModelBuilder modelBuilder) {
#pragma warning disable 612, 618
        modelBuilder
            .HasAnnotation("ProductVersion", "8.0.0")
            .HasAnnotation("Relational:MaxIdentifierLength", 128);

        SqlServerModelBuilderExtensions.UseIdentityColumns(modelBuilder);

        modelBuilder.Entity("Sophia.WebApp.Data.ApplicationUser", b => {
            b.Property<string>("Id")
                .HasColumnType("nvarchar(450)");

            b.Property<int>("AccessFailedCount")
                .HasColumnType("int");

            b.Property<string>("ConcurrencyStamp")
                .IsConcurrencyToken()
                .HasColumnType("nvarchar(max)");

            b.Property<string>("Email")
                .HasMaxLength(256)
                .HasColumnType("nvarchar(256)");

            b.Property<bool>("EmailConfirmed")
                .HasColumnType("bit");

            b.Property<bool>("LockoutEnabled")
                .HasColumnType("bit");

            b.Property<DateTimeOffset?>("LockoutEnd")
                .HasColumnType("datetimeoffset");

            b.Property<string>("NormalizedEmail")
                .HasMaxLength(256)
                .HasColumnType("nvarchar(256)");

            b.Property<string>("NormalizedUserName")
                .HasMaxLength(256)
                .HasColumnType("nvarchar(256)");

            b.Property<string>("PasswordHash")
                .HasColumnType("nvarchar(max)");

            b.Property<string>("PhoneNumber")
                .HasColumnType("nvarchar(max)");

            b.Property<bool>("PhoneNumberConfirmed")
                .HasColumnType("bit");

            b.Property<string>("SecurityStamp")
                .HasColumnType("nvarchar(max)");

            b.Property<bool>("TwoFactorEnabled")
                .HasColumnType("bit");

            b.Property<string>("UserName")
                .HasMaxLength(256)
                .HasColumnType("nvarchar(256)");

            b.HasKey("Id");

            b.HasIndex("NormalizedEmail")
                .HasDatabaseName("EmailIndex");

            b.HasIndex("NormalizedUserName")
                .IsUnique()
                .HasDatabaseName("UserNameIndex")
                .HasFilter("[NormalizedUserName] IS NOT NULL");

            b.ToTable("AspNetUsers", (string)null);
        });

        modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityRole", b => {
            b.Property<string>("Id")
                .HasColumnType("nvarchar(450)");

            b.Property<string>("ConcurrencyStamp")
                .IsConcurrencyToken()
                .HasColumnType("nvarchar(max)");

            b.Property<string>("Name")
                .HasMaxLength(256)
                .HasColumnType("nvarchar(256)");

            b.Property<string>("NormalizedName")
                .HasMaxLength(256)
                .HasColumnType("nvarchar(256)");

            b.HasKey("Id");

            b.HasIndex("NormalizedName")
                .IsUnique()
                .HasDatabaseName("RoleNameIndex")
                .HasFilter("[NormalizedName] IS NOT NULL");

            b.ToTable("AspNetRoles", (string)null);
        });

        modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityRoleClaim<string>", b => {
            b.Property<int>("Id")
                .ValueGeneratedOnAdd()
                .HasColumnType("int");

            SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>("Id"));

            b.Property<string>("ClaimType")
                .HasColumnType("nvarchar(max)");

            b.Property<string>("ClaimValue")
                .HasColumnType("nvarchar(max)");

            b.Property<string>("RoleId")
                .IsRequired()
                .HasColumnType("nvarchar(450)");

            b.HasKey("Id");

            b.HasIndex("RoleId");

            b.ToTable("AspNetRoleClaims", (string)null);
        });

        modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserClaim<string>", b => {
            b.Property<int>("Id")
                .ValueGeneratedOnAdd()
                .HasColumnType("int");

            SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>("Id"));

            b.Property<string>("ClaimType")
                .HasColumnType("nvarchar(max)");

            b.Property<string>("ClaimValue")
                .HasColumnType("nvarchar(max)");

            b.Property<string>("UserId")
                .IsRequired()
                .HasColumnType("nvarchar(450)");

            b.HasKey("Id");

            b.HasIndex("UserId");

            b.ToTable("AspNetUserClaims", (string)null);
        });

        modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserLogin<string>", b => {
            b.Property<string>("LoginProvider")
                .HasColumnType("nvarchar(450)");

            b.Property<string>("ProviderKey")
                .HasColumnType("nvarchar(450)");

            b.Property<string>("ProviderDisplayName")
                .HasColumnType("nvarchar(max)");

            b.Property<string>("UserId")
                .IsRequired()
                .HasColumnType("nvarchar(450)");

            b.HasKey("LoginProvider", "ProviderKey");

            b.HasIndex("UserId");

            b.ToTable("AspNetUserLogins", (string)null);
        });

        modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserRole<string>", b => {
            b.Property<string>("UserId")
                .HasColumnType("nvarchar(450)");

            b.Property<string>("RoleId")
                .HasColumnType("nvarchar(450)");

            b.HasKey("UserId", "RoleId");

            b.HasIndex("RoleId");

            b.ToTable("AspNetUserRoles", (string)null);
        });

        modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserToken<string>", b => {
            b.Property<string>("UserId")
                .HasColumnType("nvarchar(450)");

            b.Property<string>("LoginProvider")
                .HasColumnType("nvarchar(450)");

            b.Property<string>("Name")
                .HasColumnType("nvarchar(450)");

            b.Property<string>("Value")
                .HasColumnType("nvarchar(max)");

            b.HasKey("UserId", "LoginProvider", "Name");

            b.ToTable("AspNetUserTokens", (string)null);
        });

        modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityRoleClaim<string>", b => {
            b.HasOne("Microsoft.AspNetCore.Identity.IdentityRole", null)
                .WithMany()
                .HasForeignKey("RoleId")
                .OnDelete(DeleteBehavior.Cascade)
                .IsRequired();
        });

        modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserClaim<string>", b => {
            b.HasOne("Sophia.WebApp.Data.ApplicationUser", null)
                .WithMany()
                .HasForeignKey("UserId")
                .OnDelete(DeleteBehavior.Cascade)
                .IsRequired();
        });

        modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserLogin<string>", b => {
            b.HasOne("Sophia.WebApp.Data.ApplicationUser", null)
                .WithMany()
                .HasForeignKey("UserId")
                .OnDelete(DeleteBehavior.Cascade)
                .IsRequired();
        });

        modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserRole<string>", b => {
            b.HasOne("Microsoft.AspNetCore.Identity.IdentityRole", null)
                .WithMany()
                .HasForeignKey("RoleId")
                .OnDelete(DeleteBehavior.Cascade)
                .IsRequired();

            b.HasOne("Sophia.WebApp.Data.ApplicationUser", null)
                .WithMany()
                .HasForeignKey("UserId")
                .OnDelete(DeleteBehavior.Cascade)
                .IsRequired();
        });

        modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserToken<string>", b => {
            b.HasOne("Sophia.WebApp.Data.ApplicationUser", null)
                .WithMany()
                .HasForeignKey("UserId")
                .OnDelete(DeleteBehavior.Cascade)
                .IsRequired();
        });
#pragma warning restore 612, 618
    }
}
 
---------------------------------------------------------------------------------------- 
WebApp\Data\Migrations\20240320171542_CreateInitialSchema.cs 
using System;
using Microsoft.EntityFrameworkCore.Migrations;

#nullable disable

namespace Sophia.WebApp.Migrations
{
    /// <inheritdoc />
    public partial class CreateInitialSchema : Migration
    {
        /// <inheritdoc />
        protected override void Up(MigrationBuilder migrationBuilder)
        {
            migrationBuilder.CreateTable(
                name: "Facts",
                columns: table => new
                {
                    Id = table.Column<int>(type: "int", nullable: false)
                        .Annotation("SqlServer:Identity", "1, 1"),
                    DefaultText = table.Column<string>(type: "nvarchar(1000)", maxLength: 1000, nullable: true),
                    Value = table.Column<string>(type: "nvarchar(100)", maxLength: 100, nullable: true),
                    ValueTemplate = table.Column<string>(type: "nvarchar(1000)", maxLength: 1000, nullable: false, defaultValue: "{0}")
                },
                constraints: table =>
                {
                    table.PrimaryKey("PK_Facts", x => x.Id);
                });

            migrationBuilder.CreateTable(
                name: "Personas",
                columns: table => new
                {
                    Id = table.Column<int>(type: "int", nullable: false)
                        .Annotation("SqlServer:Identity", "1, 1"),
                    Name = table.Column<string>(type: "nvarchar(100)", maxLength: 100, nullable: false),
                    Description = table.Column<string>(type: "nvarchar(1000)", maxLength: 1000, nullable: false),
                    Personality = table.Column<string>(type: "nvarchar(1000)", maxLength: 1000, nullable: true),
                    Instructions = table.Column<string>(type: "nvarchar(max)", nullable: false)
                },
                constraints: table =>
                {
                    table.PrimaryKey("PK_Personas", x => x.Id);
                });

            migrationBuilder.CreateTable(
                name: "Tools",
                columns: table => new
                {
                    Id = table.Column<int>(type: "int", nullable: false)
                        .Annotation("SqlServer:Identity", "1, 1"),
                    Name = table.Column<string>(type: "nvarchar(100)", maxLength: 100, nullable: false),
                    Description = table.Column<string>(type: "nvarchar(1000)", maxLength: 1000, nullable: true)
                },
                constraints: table =>
                {
                    table.PrimaryKey("PK_Tools", x => x.Id);
                });

            migrationBuilder.CreateTable(
                name: "Worlds",
                columns: table => new
                {
                    Id = table.Column<Guid>(type: "uniqueidentifier", nullable: false),
                    Location = table.Column<string>(type: "nvarchar(1000)", maxLength: 1000, nullable: true),
                    UserProfile_Language = table.Column<string>(type: "nvarchar(50)", maxLength: 50, nullable: true),
                    UserProfile_Name = table.Column<string>(type: "nvarchar(250)", maxLength: 250, nullable: true)
                },
                constraints: table =>
                {
                    table.PrimaryKey("PK_Worlds", x => x.Id);
                });

            migrationBuilder.CreateTable(
                name: "PersonaFacts",
                columns: table => new
                {
                    PersonaId = table.Column<int>(type: "int", nullable: false),
                    FactId = table.Column<int>(type: "int", nullable: false)
                },
                constraints: table =>
                {
                    table.PrimaryKey("PK_PersonaFacts", x => new { x.FactId, x.PersonaId });
                    table.ForeignKey(
                        name: "FK_PersonaFacts_Facts_FactId",
                        column: x => x.FactId,
                        principalTable: "Facts",
                        principalColumn: "Id",
                        onDelete: ReferentialAction.Cascade);
                    table.ForeignKey(
                        name: "FK_PersonaFacts_Personas_PersonaId",
                        column: x => x.PersonaId,
                        principalTable: "Personas",
                        principalColumn: "Id",
                        onDelete: ReferentialAction.Cascade);
                });

            migrationBuilder.CreateTable(
                name: "Arguments",
                columns: table => new
                {
                    ToolId = table.Column<int>(type: "int", nullable: false),
                    Index = table.Column<int>(type: "int", nullable: false),
                    IsRequired = table.Column<bool>(type: "bit", nullable: false),
                    Name = table.Column<string>(type: "nvarchar(100)", maxLength: 100, nullable: false),
                    Type = table.Column<int>(type: "int", maxLength: 20, nullable: false),
                    Choices = table.Column<string>(type: "nvarchar(1024)", maxLength: 1024, nullable: false),
                    Description = table.Column<string>(type: "nvarchar(2000)", maxLength: 2000, nullable: true)
                },
                constraints: table =>
                {
                    table.PrimaryKey("PK_Arguments", x => new { x.ToolId, x.Index });
                    table.ForeignKey(
                        name: "FK_Arguments_Tools_ToolId",
                        column: x => x.ToolId,
                        principalTable: "Tools",
                        principalColumn: "Id",
                        onDelete: ReferentialAction.Cascade);
                });

            migrationBuilder.CreateTable(
                name: "PersonaTools",
                columns: table => new
                {
                    PersonaId = table.Column<int>(type: "int", nullable: false),
                    ToolId = table.Column<int>(type: "int", nullable: false)
                },
                constraints: table =>
                {
                    table.PrimaryKey("PK_PersonaTools", x => new { x.PersonaId, x.ToolId });
                    table.ForeignKey(
                        name: "FK_PersonaTools_Personas_PersonaId",
                        column: x => x.PersonaId,
                        principalTable: "Personas",
                        principalColumn: "Id",
                        onDelete: ReferentialAction.Cascade);
                    table.ForeignKey(
                        name: "FK_PersonaTools_Tools_ToolId",
                        column: x => x.ToolId,
                        principalTable: "Tools",
                        principalColumn: "Id",
                        onDelete: ReferentialAction.Cascade);
                });

            migrationBuilder.CreateTable(
                name: "WorldFacts",
                columns: table => new
                {
                    WorldId = table.Column<Guid>(type: "uniqueidentifier", nullable: false),
                    FactId = table.Column<int>(type: "int", nullable: false)
                },
                constraints: table =>
                {
                    table.PrimaryKey("PK_WorldFacts", x => new { x.FactId, x.WorldId });
                    table.ForeignKey(
                        name: "FK_WorldFacts_Facts_FactId",
                        column: x => x.FactId,
                        principalTable: "Facts",
                        principalColumn: "Id",
                        onDelete: ReferentialAction.Cascade);
                    table.ForeignKey(
                        name: "FK_WorldFacts_Worlds_WorldId",
                        column: x => x.WorldId,
                        principalTable: "Worlds",
                        principalColumn: "Id",
                        onDelete: ReferentialAction.Cascade);
                });

            migrationBuilder.CreateTable(
                name: "WorldTools",
                columns: table => new
                {
                    WorldId = table.Column<Guid>(type: "uniqueidentifier", nullable: false),
                    ToolId = table.Column<int>(type: "int", nullable: false)
                },
                constraints: table =>
                {
                    table.PrimaryKey("PK_WorldTools", x => new { x.ToolId, x.WorldId });
                    table.ForeignKey(
                        name: "FK_WorldTools_Tools_ToolId",
                        column: x => x.ToolId,
                        principalTable: "Tools",
                        principalColumn: "Id",
                        onDelete: ReferentialAction.Cascade);
                    table.ForeignKey(
                        name: "FK_WorldTools_Worlds_WorldId",
                        column: x => x.WorldId,
                        principalTable: "Worlds",
                        principalColumn: "Id",
                        onDelete: ReferentialAction.Cascade);
                });

            migrationBuilder.CreateIndex(
                name: "IX_PersonaFacts_PersonaId",
                table: "PersonaFacts",
                column: "PersonaId");

            migrationBuilder.CreateIndex(
                name: "IX_PersonaTools_ToolId",
                table: "PersonaTools",
                column: "ToolId");

            migrationBuilder.CreateIndex(
                name: "IX_WorldFacts_WorldId",
                table: "WorldFacts",
                column: "WorldId");

            migrationBuilder.CreateIndex(
                name: "IX_WorldTools_WorldId",
                table: "WorldTools",
                column: "WorldId");
        }

        /// <inheritdoc />
        protected override void Down(MigrationBuilder migrationBuilder)
        {
            migrationBuilder.DropTable(
                name: "Arguments");

            migrationBuilder.DropTable(
                name: "PersonaFacts");

            migrationBuilder.DropTable(
                name: "PersonaTools");

            migrationBuilder.DropTable(
                name: "WorldFacts");

            migrationBuilder.DropTable(
                name: "WorldTools");

            migrationBuilder.DropTable(
                name: "Personas");

            migrationBuilder.DropTable(
                name: "Facts");

            migrationBuilder.DropTable(
                name: "Tools");

            migrationBuilder.DropTable(
                name: "Worlds");
        }
    }
}
 
---------------------------------------------------------------------------------------- 
WebApp\Data\Migrations\20240320171542_CreateInitialSchema.Designer.cs 
// <auto-generated />
using System;
using System.Collections.Generic;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Infrastructure;
using Microsoft.EntityFrameworkCore.Metadata;
using Microsoft.EntityFrameworkCore.Migrations;
using Microsoft.EntityFrameworkCore.Storage.ValueConversion;
using Sophia.WebApp.Data;

#nullable disable

namespace Sophia.WebApp.Migrations
{
    [DbContext(typeof(ApplicationDbContext))]
    [Migration("20240320171542_CreateInitialSchema")]
    partial class CreateInitialSchema
    {
        /// <inheritdoc />
        protected override void BuildTargetModel(ModelBuilder modelBuilder)
        {
#pragma warning disable 612, 618
            modelBuilder
                .HasAnnotation("ProductVersion", "8.0.3")
                .HasAnnotation("Relational:MaxIdentifierLength", 128);

            SqlServerModelBuilderExtensions.UseIdentityColumns(modelBuilder);

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityRole", b =>
                {
                    b.Property<string>("Id")
                        .HasColumnType("nvarchar(450)");

                    b.Property<string>("ConcurrencyStamp")
                        .IsConcurrencyToken()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("Name")
                        .HasMaxLength(256)
                        .HasColumnType("nvarchar(256)");

                    b.Property<string>("NormalizedName")
                        .HasMaxLength(256)
                        .HasColumnType("nvarchar(256)");

                    b.HasKey("Id");

                    b.HasIndex("NormalizedName")
                        .IsUnique()
                        .HasDatabaseName("RoleNameIndex")
                        .HasFilter("[NormalizedName] IS NOT NULL");

                    b.ToTable("AspNetRoles", (string)null);
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityRoleClaim<string>", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("int");

                    SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>("Id"));

                    b.Property<string>("ClaimType")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("ClaimValue")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("RoleId")
                        .IsRequired()
                        .HasColumnType("nvarchar(450)");

                    b.HasKey("Id");

                    b.HasIndex("RoleId");

                    b.ToTable("AspNetRoleClaims", (string)null);
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserClaim<string>", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("int");

                    SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>("Id"));

                    b.Property<string>("ClaimType")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("ClaimValue")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("UserId")
                        .IsRequired()
                        .HasColumnType("nvarchar(450)");

                    b.HasKey("Id");

                    b.HasIndex("UserId");

                    b.ToTable("AspNetUserClaims", (string)null);
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserLogin<string>", b =>
                {
                    b.Property<string>("LoginProvider")
                        .HasColumnType("nvarchar(450)");

                    b.Property<string>("ProviderKey")
                        .HasColumnType("nvarchar(450)");

                    b.Property<string>("ProviderDisplayName")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("UserId")
                        .IsRequired()
                        .HasColumnType("nvarchar(450)");

                    b.HasKey("LoginProvider", "ProviderKey");

                    b.HasIndex("UserId");

                    b.ToTable("AspNetUserLogins", (string)null);
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserRole<string>", b =>
                {
                    b.Property<string>("UserId")
                        .HasColumnType("nvarchar(450)");

                    b.Property<string>("RoleId")
                        .HasColumnType("nvarchar(450)");

                    b.HasKey("UserId", "RoleId");

                    b.HasIndex("RoleId");

                    b.ToTable("AspNetUserRoles", (string)null);
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserToken<string>", b =>
                {
                    b.Property<string>("UserId")
                        .HasColumnType("nvarchar(450)");

                    b.Property<string>("LoginProvider")
                        .HasColumnType("nvarchar(450)");

                    b.Property<string>("Name")
                        .HasColumnType("nvarchar(450)");

                    b.Property<string>("Value")
                        .HasColumnType("nvarchar(max)");

                    b.HasKey("UserId", "LoginProvider", "Name");

                    b.ToTable("AspNetUserTokens", (string)null);
                });

            modelBuilder.Entity("Sophia.WebApp.Data.ApplicationUser", b =>
                {
                    b.Property<string>("Id")
                        .HasColumnType("nvarchar(450)");

                    b.Property<int>("AccessFailedCount")
                        .HasColumnType("int");

                    b.Property<string>("ConcurrencyStamp")
                        .IsConcurrencyToken()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("Email")
                        .HasMaxLength(256)
                        .HasColumnType("nvarchar(256)");

                    b.Property<bool>("EmailConfirmed")
                        .HasColumnType("bit");

                    b.Property<bool>("LockoutEnabled")
                        .HasColumnType("bit");

                    b.Property<DateTimeOffset?>("LockoutEnd")
                        .HasColumnType("datetimeoffset");

                    b.Property<string>("NormalizedEmail")
                        .HasMaxLength(256)
                        .HasColumnType("nvarchar(256)");

                    b.Property<string>("NormalizedUserName")
                        .HasMaxLength(256)
                        .HasColumnType("nvarchar(256)");

                    b.Property<string>("PasswordHash")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("PhoneNumber")
                        .HasColumnType("nvarchar(max)");

                    b.Property<bool>("PhoneNumberConfirmed")
                        .HasColumnType("bit");

                    b.Property<string>("SecurityStamp")
                        .HasColumnType("nvarchar(max)");

                    b.Property<bool>("TwoFactorEnabled")
                        .HasColumnType("bit");

                    b.Property<string>("UserName")
                        .HasMaxLength(256)
                        .HasColumnType("nvarchar(256)");

                    b.HasKey("Id");

                    b.HasIndex("NormalizedEmail")
                        .HasDatabaseName("EmailIndex");

                    b.HasIndex("NormalizedUserName")
                        .IsUnique()
                        .HasDatabaseName("UserNameIndex")
                        .HasFilter("[NormalizedUserName] IS NOT NULL");

                    b.ToTable("AspNetUsers", (string)null);
                });

            modelBuilder.Entity("Sophia.WebApp.Data.Common.FactEntity", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("int");

                    SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>("Id"));

                    b.Property<string>("DefaultText")
                        .HasMaxLength(1000)
                        .HasColumnType("nvarchar(1000)");

                    b.Property<string>("Value")
                        .HasMaxLength(100)
                        .HasColumnType("nvarchar(100)");

                    b.Property<string>("ValueTemplate")
                        .IsRequired()
                        .ValueGeneratedOnAdd()
                        .HasMaxLength(1000)
                        .HasColumnType("nvarchar(1000)")
                        .HasDefaultValue("{0}");

                    b.HasKey("Id");

                    b.ToTable("Facts");
                });

            modelBuilder.Entity("Sophia.WebApp.Data.Personas.PersonaEntity", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("int");

                    SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>("Id"));

                    b.Property<string>("Description")
                        .IsRequired()
                        .HasMaxLength(1000)
                        .HasColumnType("nvarchar(1000)");

                    b.Property<string>("Instructions")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("Name")
                        .IsRequired()
                        .HasMaxLength(100)
                        .HasColumnType("nvarchar(100)");

                    b.Property<string>("Personality")
                        .HasMaxLength(1000)
                        .HasColumnType("nvarchar(1000)");

                    b.HasKey("Id");

                    b.ToTable("Personas");
                });

            modelBuilder.Entity("Sophia.WebApp.Data.Personas.PersonaFactsEntity", b =>
                {
                    b.Property<int>("FactId")
                        .HasColumnType("int");

                    b.Property<int>("PersonaId")
                        .HasColumnType("int");

                    b.HasKey("FactId", "PersonaId");

                    b.HasIndex("PersonaId");

                    b.ToTable("PersonaFacts");
                });

            modelBuilder.Entity("Sophia.WebApp.Data.Personas.PersonaToolsEntity", b =>
                {
                    b.Property<int>("PersonaId")
                        .HasColumnType("int");

                    b.Property<int>("ToolId")
                        .HasColumnType("int");

                    b.HasKey("PersonaId", "ToolId");

                    b.HasIndex("ToolId");

                    b.ToTable("PersonaTools");
                });

            modelBuilder.Entity("Sophia.WebApp.Data.Tools.ArgumentEntity", b =>
                {
                    b.Property<int>("ToolId")
                        .HasColumnType("int");

                    b.Property<int>("Index")
                        .HasColumnType("int");

                    b.Property<string>("Choices")
                        .IsRequired()
                        .HasMaxLength(1024)
                        .HasColumnType("nvarchar(1024)");

                    b.Property<string>("Description")
                        .HasMaxLength(2000)
                        .HasColumnType("nvarchar(2000)");

                    b.Property<bool>("IsRequired")
                        .HasColumnType("bit");

                    b.Property<string>("Name")
                        .IsRequired()
                        .HasMaxLength(100)
                        .HasColumnType("nvarchar(100)");

                    b.Property<int>("Type")
                        .HasMaxLength(20)
                        .HasColumnType("int");

                    b.HasKey("ToolId", "Index");

                    b.ToTable("Arguments");
                });

            modelBuilder.Entity("Sophia.WebApp.Data.Tools.ToolEntity", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("int");

                    SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>("Id"));

                    b.Property<string>("Description")
                        .HasMaxLength(1000)
                        .HasColumnType("nvarchar(1000)");

                    b.Property<string>("Name")
                        .IsRequired()
                        .HasMaxLength(100)
                        .HasColumnType("nvarchar(100)");

                    b.HasKey("Id");

                    b.ToTable("Tools");
                });

            modelBuilder.Entity("Sophia.WebApp.Data.World.WorldEntity", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uniqueidentifier");

                    b.Property<string>("Location")
                        .HasMaxLength(1000)
                        .HasColumnType("nvarchar(1000)");

                    b.ComplexProperty<Dictionary<string, object>>("UserProfile", "Sophia.WebApp.Data.World.WorldEntity.UserProfile#UserProfileEntity", b1 =>
                        {
                            b1.IsRequired();

                            b1.Property<string>("Language")
                                .HasMaxLength(50)
                                .HasColumnType("nvarchar(50)");

                            b1.Property<string>("Name")
                                .HasMaxLength(250)
                                .HasColumnType("nvarchar(250)");
                        });

                    b.HasKey("Id");

                    b.ToTable("Worlds");
                });

            modelBuilder.Entity("Sophia.WebApp.Data.World.WorldFactsEntity", b =>
                {
                    b.Property<int>("FactId")
                        .HasColumnType("int");

                    b.Property<Guid>("WorldId")
                        .HasColumnType("uniqueidentifier");

                    b.HasKey("FactId", "WorldId");

                    b.HasIndex("WorldId");

                    b.ToTable("WorldFacts");
                });

            modelBuilder.Entity("Sophia.WebApp.Data.World.WorldToolsEntity", b =>
                {
                    b.Property<int>("ToolId")
                        .HasColumnType("int");

                    b.Property<Guid>("WorldId")
                        .HasColumnType("uniqueidentifier");

                    b.HasKey("ToolId", "WorldId");

                    b.HasIndex("WorldId");

                    b.ToTable("WorldTools");
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityRoleClaim<string>", b =>
                {
                    b.HasOne("Microsoft.AspNetCore.Identity.IdentityRole", null)
                        .WithMany()
                        .HasForeignKey("RoleId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserClaim<string>", b =>
                {
                    b.HasOne("Sophia.WebApp.Data.ApplicationUser", null)
                        .WithMany()
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserLogin<string>", b =>
                {
                    b.HasOne("Sophia.WebApp.Data.ApplicationUser", null)
                        .WithMany()
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserRole<string>", b =>
                {
                    b.HasOne("Microsoft.AspNetCore.Identity.IdentityRole", null)
                        .WithMany()
                        .HasForeignKey("RoleId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.HasOne("Sophia.WebApp.Data.ApplicationUser", null)
                        .WithMany()
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserToken<string>", b =>
                {
                    b.HasOne("Sophia.WebApp.Data.ApplicationUser", null)
                        .WithMany()
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Sophia.WebApp.Data.Personas.PersonaFactsEntity", b =>
                {
                    b.HasOne("Sophia.WebApp.Data.Common.FactEntity", null)
                        .WithMany()
                        .HasForeignKey("FactId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.HasOne("Sophia.WebApp.Data.Personas.PersonaEntity", null)
                        .WithMany()
                        .HasForeignKey("PersonaId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Sophia.WebApp.Data.Personas.PersonaToolsEntity", b =>
                {
                    b.HasOne("Sophia.WebApp.Data.Personas.PersonaEntity", null)
                        .WithMany()
                        .HasForeignKey("PersonaId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.HasOne("Sophia.WebApp.Data.Tools.ToolEntity", null)
                        .WithMany()
                        .HasForeignKey("ToolId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Sophia.WebApp.Data.Tools.ArgumentEntity", b =>
                {
                    b.HasOne("Sophia.WebApp.Data.Tools.ToolEntity", null)
                        .WithMany("Arguments")
                        .HasForeignKey("ToolId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Sophia.WebApp.Data.World.WorldFactsEntity", b =>
                {
                    b.HasOne("Sophia.WebApp.Data.Common.FactEntity", null)
                        .WithMany()
                        .HasForeignKey("FactId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.HasOne("Sophia.WebApp.Data.World.WorldEntity", null)
                        .WithMany()
                        .HasForeignKey("WorldId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Sophia.WebApp.Data.World.WorldToolsEntity", b =>
                {
                    b.HasOne("Sophia.WebApp.Data.Tools.ToolEntity", null)
                        .WithMany()
                        .HasForeignKey("ToolId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.HasOne("Sophia.WebApp.Data.World.WorldEntity", null)
                        .WithMany()
                        .HasForeignKey("WorldId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Sophia.WebApp.Data.Tools.ToolEntity", b =>
                {
                    b.Navigation("Arguments");
                });
#pragma warning restore 612, 618
        }
    }
}
 
---------------------------------------------------------------------------------------- 
WebApp\Data\Migrations\ApplicationDbContextModelSnapshot.cs 
// <auto-generated />
using System;
using System.Collections.Generic;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Infrastructure;
using Microsoft.EntityFrameworkCore.Metadata;
using Microsoft.EntityFrameworkCore.Storage.ValueConversion;
using Sophia.WebApp.Data;

#nullable disable

namespace Sophia.WebApp.Migrations
{
    [DbContext(typeof(ApplicationDbContext))]
    partial class ApplicationDbContextModelSnapshot : ModelSnapshot
    {
        protected override void BuildModel(ModelBuilder modelBuilder)
        {
#pragma warning disable 612, 618
            modelBuilder
                .HasAnnotation("ProductVersion", "8.0.3")
                .HasAnnotation("Relational:MaxIdentifierLength", 128);

            SqlServerModelBuilderExtensions.UseIdentityColumns(modelBuilder);

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityRole", b =>
                {
                    b.Property<string>("Id")
                        .HasColumnType("nvarchar(450)");

                    b.Property<string>("ConcurrencyStamp")
                        .IsConcurrencyToken()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("Name")
                        .HasMaxLength(256)
                        .HasColumnType("nvarchar(256)");

                    b.Property<string>("NormalizedName")
                        .HasMaxLength(256)
                        .HasColumnType("nvarchar(256)");

                    b.HasKey("Id");

                    b.HasIndex("NormalizedName")
                        .IsUnique()
                        .HasDatabaseName("RoleNameIndex")
                        .HasFilter("[NormalizedName] IS NOT NULL");

                    b.ToTable("AspNetRoles", (string)null);
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityRoleClaim<string>", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("int");

                    SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>("Id"));

                    b.Property<string>("ClaimType")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("ClaimValue")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("RoleId")
                        .IsRequired()
                        .HasColumnType("nvarchar(450)");

                    b.HasKey("Id");

                    b.HasIndex("RoleId");

                    b.ToTable("AspNetRoleClaims", (string)null);
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserClaim<string>", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("int");

                    SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>("Id"));

                    b.Property<string>("ClaimType")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("ClaimValue")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("UserId")
                        .IsRequired()
                        .HasColumnType("nvarchar(450)");

                    b.HasKey("Id");

                    b.HasIndex("UserId");

                    b.ToTable("AspNetUserClaims", (string)null);
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserLogin<string>", b =>
                {
                    b.Property<string>("LoginProvider")
                        .HasColumnType("nvarchar(450)");

                    b.Property<string>("ProviderKey")
                        .HasColumnType("nvarchar(450)");

                    b.Property<string>("ProviderDisplayName")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("UserId")
                        .IsRequired()
                        .HasColumnType("nvarchar(450)");

                    b.HasKey("LoginProvider", "ProviderKey");

                    b.HasIndex("UserId");

                    b.ToTable("AspNetUserLogins", (string)null);
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserRole<string>", b =>
                {
                    b.Property<string>("UserId")
                        .HasColumnType("nvarchar(450)");

                    b.Property<string>("RoleId")
                        .HasColumnType("nvarchar(450)");

                    b.HasKey("UserId", "RoleId");

                    b.HasIndex("RoleId");

                    b.ToTable("AspNetUserRoles", (string)null);
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserToken<string>", b =>
                {
                    b.Property<string>("UserId")
                        .HasColumnType("nvarchar(450)");

                    b.Property<string>("LoginProvider")
                        .HasColumnType("nvarchar(450)");

                    b.Property<string>("Name")
                        .HasColumnType("nvarchar(450)");

                    b.Property<string>("Value")
                        .HasColumnType("nvarchar(max)");

                    b.HasKey("UserId", "LoginProvider", "Name");

                    b.ToTable("AspNetUserTokens", (string)null);
                });

            modelBuilder.Entity("Sophia.WebApp.Data.ApplicationUser", b =>
                {
                    b.Property<string>("Id")
                        .HasColumnType("nvarchar(450)");

                    b.Property<int>("AccessFailedCount")
                        .HasColumnType("int");

                    b.Property<string>("ConcurrencyStamp")
                        .IsConcurrencyToken()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("Email")
                        .HasMaxLength(256)
                        .HasColumnType("nvarchar(256)");

                    b.Property<bool>("EmailConfirmed")
                        .HasColumnType("bit");

                    b.Property<bool>("LockoutEnabled")
                        .HasColumnType("bit");

                    b.Property<DateTimeOffset?>("LockoutEnd")
                        .HasColumnType("datetimeoffset");

                    b.Property<string>("NormalizedEmail")
                        .HasMaxLength(256)
                        .HasColumnType("nvarchar(256)");

                    b.Property<string>("NormalizedUserName")
                        .HasMaxLength(256)
                        .HasColumnType("nvarchar(256)");

                    b.Property<string>("PasswordHash")
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("PhoneNumber")
                        .HasColumnType("nvarchar(max)");

                    b.Property<bool>("PhoneNumberConfirmed")
                        .HasColumnType("bit");

                    b.Property<string>("SecurityStamp")
                        .HasColumnType("nvarchar(max)");

                    b.Property<bool>("TwoFactorEnabled")
                        .HasColumnType("bit");

                    b.Property<string>("UserName")
                        .HasMaxLength(256)
                        .HasColumnType("nvarchar(256)");

                    b.HasKey("Id");

                    b.HasIndex("NormalizedEmail")
                        .HasDatabaseName("EmailIndex");

                    b.HasIndex("NormalizedUserName")
                        .IsUnique()
                        .HasDatabaseName("UserNameIndex")
                        .HasFilter("[NormalizedUserName] IS NOT NULL");

                    b.ToTable("AspNetUsers", (string)null);
                });

            modelBuilder.Entity("Sophia.WebApp.Data.Common.FactEntity", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("int");

                    SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>("Id"));

                    b.Property<string>("DefaultText")
                        .HasMaxLength(1000)
                        .HasColumnType("nvarchar(1000)");

                    b.Property<string>("Value")
                        .HasMaxLength(100)
                        .HasColumnType("nvarchar(100)");

                    b.Property<string>("ValueTemplate")
                        .IsRequired()
                        .ValueGeneratedOnAdd()
                        .HasMaxLength(1000)
                        .HasColumnType("nvarchar(1000)")
                        .HasDefaultValue("{0}");

                    b.HasKey("Id");

                    b.ToTable("Facts");
                });

            modelBuilder.Entity("Sophia.WebApp.Data.Personas.PersonaEntity", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("int");

                    SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>("Id"));

                    b.Property<string>("Description")
                        .IsRequired()
                        .HasMaxLength(1000)
                        .HasColumnType("nvarchar(1000)");

                    b.Property<string>("Instructions")
                        .IsRequired()
                        .HasColumnType("nvarchar(max)");

                    b.Property<string>("Name")
                        .IsRequired()
                        .HasMaxLength(100)
                        .HasColumnType("nvarchar(100)");

                    b.Property<string>("Personality")
                        .HasMaxLength(1000)
                        .HasColumnType("nvarchar(1000)");

                    b.HasKey("Id");

                    b.ToTable("Personas");
                });

            modelBuilder.Entity("Sophia.WebApp.Data.Personas.PersonaFactsEntity", b =>
                {
                    b.Property<int>("FactId")
                        .HasColumnType("int");

                    b.Property<int>("PersonaId")
                        .HasColumnType("int");

                    b.HasKey("FactId", "PersonaId");

                    b.HasIndex("PersonaId");

                    b.ToTable("PersonaFacts");
                });

            modelBuilder.Entity("Sophia.WebApp.Data.Personas.PersonaToolsEntity", b =>
                {
                    b.Property<int>("PersonaId")
                        .HasColumnType("int");

                    b.Property<int>("ToolId")
                        .HasColumnType("int");

                    b.HasKey("PersonaId", "ToolId");

                    b.HasIndex("ToolId");

                    b.ToTable("PersonaTools");
                });

            modelBuilder.Entity("Sophia.WebApp.Data.Tools.ArgumentEntity", b =>
                {
                    b.Property<int>("ToolId")
                        .HasColumnType("int");

                    b.Property<int>("Index")
                        .HasColumnType("int");

                    b.Property<string>("Choices")
                        .IsRequired()
                        .HasMaxLength(1024)
                        .HasColumnType("nvarchar(1024)");

                    b.Property<string>("Description")
                        .HasMaxLength(2000)
                        .HasColumnType("nvarchar(2000)");

                    b.Property<bool>("IsRequired")
                        .HasColumnType("bit");

                    b.Property<string>("Name")
                        .IsRequired()
                        .HasMaxLength(100)
                        .HasColumnType("nvarchar(100)");

                    b.Property<int>("Type")
                        .HasMaxLength(20)
                        .HasColumnType("int");

                    b.HasKey("ToolId", "Index");

                    b.ToTable("Arguments");
                });

            modelBuilder.Entity("Sophia.WebApp.Data.Tools.ToolEntity", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("int");

                    SqlServerPropertyBuilderExtensions.UseIdentityColumn(b.Property<int>("Id"));

                    b.Property<string>("Description")
                        .HasMaxLength(1000)
                        .HasColumnType("nvarchar(1000)");

                    b.Property<string>("Name")
                        .IsRequired()
                        .HasMaxLength(100)
                        .HasColumnType("nvarchar(100)");

                    b.HasKey("Id");

                    b.ToTable("Tools");
                });

            modelBuilder.Entity("Sophia.WebApp.Data.World.WorldEntity", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uniqueidentifier");

                    b.Property<string>("Location")
                        .HasMaxLength(1000)
                        .HasColumnType("nvarchar(1000)");

                    b.ComplexProperty<Dictionary<string, object>>("UserProfile", "Sophia.WebApp.Data.World.WorldEntity.UserProfile#UserProfileEntity", b1 =>
                        {
                            b1.IsRequired();

                            b1.Property<string>("Language")
                                .HasMaxLength(50)
                                .HasColumnType("nvarchar(50)");

                            b1.Property<string>("Name")
                                .HasMaxLength(250)
                                .HasColumnType("nvarchar(250)");
                        });

                    b.HasKey("Id");

                    b.ToTable("Worlds");
                });

            modelBuilder.Entity("Sophia.WebApp.Data.World.WorldFactsEntity", b =>
                {
                    b.Property<int>("FactId")
                        .HasColumnType("int");

                    b.Property<Guid>("WorldId")
                        .HasColumnType("uniqueidentifier");

                    b.HasKey("FactId", "WorldId");

                    b.HasIndex("WorldId");

                    b.ToTable("WorldFacts");
                });

            modelBuilder.Entity("Sophia.WebApp.Data.World.WorldToolsEntity", b =>
                {
                    b.Property<int>("ToolId")
                        .HasColumnType("int");

                    b.Property<Guid>("WorldId")
                        .HasColumnType("uniqueidentifier");

                    b.HasKey("ToolId", "WorldId");

                    b.HasIndex("WorldId");

                    b.ToTable("WorldTools");
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityRoleClaim<string>", b =>
                {
                    b.HasOne("Microsoft.AspNetCore.Identity.IdentityRole", null)
                        .WithMany()
                        .HasForeignKey("RoleId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserClaim<string>", b =>
                {
                    b.HasOne("Sophia.WebApp.Data.ApplicationUser", null)
                        .WithMany()
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserLogin<string>", b =>
                {
                    b.HasOne("Sophia.WebApp.Data.ApplicationUser", null)
                        .WithMany()
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserRole<string>", b =>
                {
                    b.HasOne("Microsoft.AspNetCore.Identity.IdentityRole", null)
                        .WithMany()
                        .HasForeignKey("RoleId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.HasOne("Sophia.WebApp.Data.ApplicationUser", null)
                        .WithMany()
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserToken<string>", b =>
                {
                    b.HasOne("Sophia.WebApp.Data.ApplicationUser", null)
                        .WithMany()
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Sophia.WebApp.Data.Personas.PersonaFactsEntity", b =>
                {
                    b.HasOne("Sophia.WebApp.Data.Common.FactEntity", null)
                        .WithMany()
                        .HasForeignKey("FactId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.HasOne("Sophia.WebApp.Data.Personas.PersonaEntity", null)
                        .WithMany()
                        .HasForeignKey("PersonaId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Sophia.WebApp.Data.Personas.PersonaToolsEntity", b =>
                {
                    b.HasOne("Sophia.WebApp.Data.Personas.PersonaEntity", null)
                        .WithMany()
                        .HasForeignKey("PersonaId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.HasOne("Sophia.WebApp.Data.Tools.ToolEntity", null)
                        .WithMany()
                        .HasForeignKey("ToolId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Sophia.WebApp.Data.Tools.ArgumentEntity", b =>
                {
                    b.HasOne("Sophia.WebApp.Data.Tools.ToolEntity", null)
                        .WithMany("Arguments")
                        .HasForeignKey("ToolId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Sophia.WebApp.Data.World.WorldFactsEntity", b =>
                {
                    b.HasOne("Sophia.WebApp.Data.Common.FactEntity", null)
                        .WithMany()
                        .HasForeignKey("FactId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.HasOne("Sophia.WebApp.Data.World.WorldEntity", null)
                        .WithMany()
                        .HasForeignKey("WorldId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Sophia.WebApp.Data.World.WorldToolsEntity", b =>
                {
                    b.HasOne("Sophia.WebApp.Data.Tools.ToolEntity", null)
                        .WithMany()
                        .HasForeignKey("ToolId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.HasOne("Sophia.WebApp.Data.World.WorldEntity", null)
                        .WithMany()
                        .HasForeignKey("WorldId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Sophia.WebApp.Data.Tools.ToolEntity", b =>
                {
                    b.Navigation("Arguments");
                });
#pragma warning restore 612, 618
        }
    }
}
 
---------------------------------------------------------------------------------------- 
WebApp\Data\Personas\PersonaEntity.cs 
namespace Sophia.WebApp.Data.Personas;

[Table("PersonaFacts")]
public class PersonaFactsEntity {
    public int PersonaId { get; set; }
    public int FactId { get; set; }
}

[Table("PersonaTools")]
public class PersonaToolsEntity {
    public int PersonaId { get; set; }
    public int ToolId { get; set; }
}

[Table("Personas")]
[EntityTypeConfiguration(typeof(PersonaEntity))]
public class PersonaEntity
    : IEntityTypeConfiguration<PersonaEntity> {
    [Key]
    [DatabaseGenerated(DatabaseGeneratedOption.Identity)]
    public int Id { get; set; }
    [MaxLength(100)]
    public string Name { get; set; } = "Agent";
    [MaxLength(1000)]
    public string Description { get; set; } = "You are a helpful agent.";
    [MaxLength(1000)]
    public string? Personality { get; set; }
    public string[] Instructions { get; set; } = [];
    public List<FactEntity> Facts { get; set; } = [];
    public List<ToolEntity> KnownTools { get; set; } = [];

    public void Configure(EntityTypeBuilder<PersonaEntity> builder) {
        builder.HasKey(p => p.Id);
        builder.PrimitiveCollection(p => p.Instructions);
        builder.HasMany(w => w.Facts)
               .WithMany()
               .UsingEntity<PersonaFactsEntity>(l => l.HasOne<FactEntity>()
                                                      .WithMany()
                                                      .HasForeignKey(e => e.FactId),
                                                r => r.HasOne<PersonaEntity>()
                                                      .WithMany()
                                                      .HasForeignKey(e => e.PersonaId));
        builder.HasMany(p => p.KnownTools)
               .WithMany()
               .UsingEntity<PersonaToolsEntity>(l => l.HasOne<ToolEntity>()
                                                      .WithMany()
                                                      .HasForeignKey(e => e.ToolId),
                                                r => r.HasOne<PersonaEntity>()
                                                      .WithMany()
                                                      .HasForeignKey(e => e.PersonaId));
    }

    public PersonaData ToDto()
        => new() {
            Id = Id,
            Name = Name,
            Description = Description,
            Personality = Personality,
            Instructions = [.. Instructions],
            Facts = Facts.ToList(f => f.ToDto()),
            KnownTools = KnownTools.ToList(f => f.ToDto()),
        };
}
 
---------------------------------------------------------------------------------------- 
WebApp\Data\Tools\ArgumentEntity.cs 
namespace Sophia.WebApp.Data.Tools;

[Owned]
[Table("Arguments")]
[EntityTypeConfiguration(typeof(ArgumentEntity))]
public class ArgumentEntity
    : IEntityTypeConfiguration<ArgumentEntity> {
    [Required]
    public int ToolId { get; set; }
    [Required]
    [DatabaseGenerated(DatabaseGeneratedOption.None)]
    public int Index { get; set; }
    [Required]
    public bool IsRequired { get; set; }
    [Required]
    [MaxLength(100)]
    public string Name { get; set; } = string.Empty;
    [Required]
    [MaxLength(20)]
    public ArgumentType Type { get; set; }

    [MaxLength(1024)]
    public string[] Choices { get; set; } = [];
    [MaxLength(2000)]
    public string? Description { get; set; }

    public void Configure(EntityTypeBuilder<ArgumentEntity> builder) {
        builder.HasKey(a => new { a.ToolId, a.Index });
        builder.PrimitiveCollection(p => p.Choices);
    }

    public ArgumentData ToDto()
        => new() {
            Name = Name,
            Description = Description,
            Type = Type,
            Choices = Choices?.ToList() ?? [],
            IsRequired = IsRequired,
        };
}
 
---------------------------------------------------------------------------------------- 
WebApp\Data\Tools\ToolEntity.cs 
namespace Sophia.WebApp.Data.Tools;

[Table("Tools")]
[EntityTypeConfiguration(typeof(ToolEntity))]
public class ToolEntity
    : IEntityTypeConfiguration<ToolEntity> {
    [Key]
    [DatabaseGenerated(DatabaseGeneratedOption.Identity)]
    public int Id { get; set; }
    [MaxLength(100)]
    public string Name { get; set; } = string.Empty;
    [MaxLength(1000)]
    public string? Description { get; set; }
    public List<ArgumentEntity> Arguments { get; set; } = [];

    public void Configure(EntityTypeBuilder<ToolEntity> builder)
        => builder.HasMany(s => s.Arguments)
                  .WithOne()
                  .HasForeignKey(a => a.ToolId);

    public ToolData ToDto()
        => new() {
            Id = Id,
            Name = Name,
            Description = Description,
            Arguments = Arguments.ToList(a => a.ToDto()),
        };
}
 
---------------------------------------------------------------------------------------- 
WebApp\Data\World\UserProfileEntity.cs 
namespace Sophia.WebApp.Data.World;

public class UserProfileEntity {
    [MaxLength(250)]
    public string? Name { get; set; }
    [MaxLength(50)]
    public string? Language { get; set; }

    public UserProfileData ToDto() => new() {
        Name = Name,
        Language = Language,
    };
}
 
---------------------------------------------------------------------------------------- 
WebApp\Data\World\WorldEntity.cs 
namespace Sophia.WebApp.Data.World;

[Table("WorldFacts")]
public class WorldFactsEntity {
    public Guid WorldId { get; set; }
    public int FactId { get; set; }
}

[Table("WorldTools")]
public class WorldToolsEntity {
    public Guid WorldId { get; set; }
    public int ToolId { get; set; }
}

[Table("Worlds")]
[EntityTypeConfiguration(typeof(WorldEntity))]
public class WorldEntity
    : IEntityTypeConfiguration<WorldEntity> {
    [Key]
    [DatabaseGenerated(DatabaseGeneratedOption.Identity)]
    public Guid Id { get; set; } = Guid.Empty;
    [MaxLength(1000)]
    public string? Location { get; set; }
    [Required]
    public UserProfileEntity UserProfile { get; set; } = new();
    public List<FactEntity> Facts { get; set; } = [];
    public List<ToolEntity> Tools { get; set; } = [];

    public void Configure(EntityTypeBuilder<WorldEntity> builder) {
        builder.HasMany(w => w.Facts)
               .WithMany()
               .UsingEntity<WorldFactsEntity>(l => l.HasOne<FactEntity>()
                                                    .WithMany()
                                                    .HasForeignKey(e => e.FactId),
                                              r => r.HasOne<WorldEntity>()
                                                    .WithMany()
                                                    .HasForeignKey(e => e.WorldId));
        builder.ComplexProperty(w => w.UserProfile);
        builder.HasMany(p => p.Tools)
               .WithMany()
               .UsingEntity<WorldToolsEntity>(l => l.HasOne<ToolEntity>()
                                                    .WithMany()
                                                    .HasForeignKey(e => e.ToolId),
                                              r => r.HasOne<WorldEntity>()
                                                    .WithMany()
                                                    .HasForeignKey(e => e.WorldId));
    }

    public static async Task Seed(ApplicationDbContext dbContext) {
        if (await dbContext.Worlds.AnyAsync()) return;
        var world = new WorldEntity();
        dbContext.Worlds.Add(world);
    }

    public WorldData ToDto()
        => new() {
            Location = Location,
            UserProfile = UserProfile.ToDto(),
            Facts = Facts.ToList(a => a.ToDto()),
            Tools = Tools.ToList(s => s.ToDto()),
        };
}
 
---------------------------------------------------------------------------------------- 
WebApp\Endpoints\PersonasEndpoints.cs 
namespace Sophia.WebApp.Endpoints;

internal static class PersonasEndpoints {
    public static IEndpointConventionBuilder MapPersonasEndpoints(this IEndpointRouteBuilder endpoints) {
        ArgumentNullException.ThrowIfNull(endpoints);

        var group = endpoints.MapGroup("api/personas");
        group.MapGet("/", (IPersonasService service) => service.GetList());
        group.MapGet("/{id}", (IPersonasService service, [FromRoute] int id) => service.GetById(id));
        group.MapPost("/", (IPersonasService service, [FromBody] PersonaData newValue) => service.Add(newValue));
        group.MapPut("/", (IPersonasService service, [FromBody] PersonaData updatedValue) => service.Update(updatedValue));
        group.MapDelete("/{id}", (IPersonasService service, [FromRoute] int id) => service.Delete(id));
        return group;
    }
}
 
---------------------------------------------------------------------------------------- 
WebApp\Endpoints\ToolsEndpoints.cs 
namespace Sophia.WebApp.Endpoints;

internal static class ToolsEndpoints {
    public static IEndpointConventionBuilder MapToolsEndpoints(this IEndpointRouteBuilder endpoints) {
        ArgumentNullException.ThrowIfNull(endpoints);

        var group = endpoints.MapGroup("api/tools");
        group.MapGet("/", (IToolsService service) => service.GetList());
        group.MapGet("/{id}", (IToolsService service, [FromRoute]int id) => service.GetById(id));
        group.MapPost("/", (IToolsService service, [FromBody] ToolData newValue) => service.Add(newValue));
        group.MapPut("/", (IToolsService service, [FromBody] ToolData updatedValue) => service.Update(updatedValue));
        group.MapDelete("/{id}", (IToolsService service, [FromRoute] int id) => service.Delete(id));
        return group;
    }
}
 
---------------------------------------------------------------------------------------- 
WebApp\Endpoints\WorldEndpoints.cs 
namespace Sophia.WebApp.Endpoints;

internal static class WorldEndpoints {
    public static IEndpointConventionBuilder MapWorldEndpoints(this IEndpointRouteBuilder endpoints) {
        ArgumentNullException.ThrowIfNull(endpoints);

        var group = endpoints.MapGroup("api/world");
        group.MapGet("/", (IWorldService service) => service.GetWorld());
        group.MapPut("/", (IWorldService service, [FromBody] WorldData updatedValue) => service.UpdateWorld(updatedValue));
        return group;
    }
}
 
---------------------------------------------------------------------------------------- 
WebApp\Pages\ErrorPage.razor.cs 
using System.Diagnostics;

namespace Sophia.WebApp.Pages;

public partial class ErrorPage {
    [Inject]
    public required IWebHostEnvironment Environment { get; set; }

    [CascadingParameter]
    private HttpContext? HttpContext { get; set; }

    private string? RequestId { get; set; }
    private bool ShowRequestId => !string.IsNullOrEmpty(RequestId);

    protected override void OnInitialized() => RequestId = Activity.Current?.Id ?? HttpContext?.TraceIdentifier;
}
 
---------------------------------------------------------------------------------------- 
WebApp\Pages\AuthPage.razor 
@page "/auth"
@rendermode InteractiveWebAssembly

@attribute [Authorize]

<h1>You are authenticated</h1>

<AuthorizeView>
    Hello @context.User.Identity?.Name!
</AuthorizeView>
 
---------------------------------------------------------------------------------------- 
WebApp\Pages\ErrorPage.razor 
@page "/Error"

<div class="container">
  <div class="container-header row mb-3">
    <h3 class="text-danger">Error.</h3>
  </div>
  <div class="container-body">
    <p class="text-danger">An error occurred while processing your request.</p>

    @if (ShowRequestId) {
      <p>
        <strong>Request ID:</strong> <code>@RequestId</code>
      </p>
    }

    @if (!Environment.IsDevelopment()) {
      <div class="text-danger">
        <h3>Debugging mode is not enabled.</h3>
        <p>
          Swapping to <strong>Development</strong> environment will display more detailed information about the error that occurred.
        </p>
        <p>
          <strong>The debugging mode shouldn't be enabled for deployed applications.</strong>
          It can result in displaying sensitive information from exceptions to end users.
          For local debugging, enable the <strong>debugging mode</strong> by setting the <strong>ASPNETCORE_ENVIRONMENT</strong> environment variable to <strong>Development</strong>
          and restarting the app.
        </p>
      </div>
    }
  </div>
</div>
 
---------------------------------------------------------------------------------------- 
WebApp\Pages\HomePage.razor 
@page "/"

<div class="container">
  <div class="container-header row mb-3">
    <h3>Hello, world!</h3>
  </div>
  <div class="container-body">
    Welcome to your new app.
  </div>
</div>
 
---------------------------------------------------------------------------------------- 
WebApp\Pages\_Imports.razor 
@using System.Text
@using System.ComponentModel.DataAnnotations
@using System.Diagnostics
@using System.Globalization
@using System.Net.Http
@using System.Net.Http.Json
@using System.Security.Claims
@using System.Text.Encodings.Web

@using Microsoft.AspNetCore.Authentication
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Routing
@using Microsoft.AspNetCore.Components.Web
@using static Microsoft.AspNetCore.Components.Web.RenderMode
@using Microsoft.AspNetCore.Components.Web.Virtualization
@using Microsoft.AspNetCore.Http.Features
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.WebUtilities
@using Microsoft.JSInterop

@using Sophia.WebApp
@using Sophia.WebApp.Components
@using Sophia.WebApp.Components.Account.Shared
@using Sophia.WebApp.Data
 
---------------------------------------------------------------------------------------- 
WebApp\Properties\launchSettings.json 
{
  "$schema": "http://json.schemastore.org/launchsettings.json",
    "iisSettings": {
      "windowsAuthentication": false,
      "anonymousAuthentication": true,
      "iisExpress": {
        "applicationUrl": "http://localhost:14650",
        "sslPort": 44377
      }
    },
    "profiles": {
      "http": {
        "commandName": "Project",
        "dotnetRunMessages": true,
        "launchBrowser": true,
        "applicationUrl": "http://localhost:5069",
        "environmentVariables": {
          "ASPNETCORE_ENVIRONMENT": "Development"
        }
      },
      "https": {
        "commandName": "Project",
        "dotnetRunMessages": true,
        "launchBrowser": true,
        "applicationUrl": "https://localhost:7100;http://localhost:5069",
        "environmentVariables": {
          "ASPNETCORE_ENVIRONMENT": "Development"
        }
      },
      "IIS Express": {
        "commandName": "IISExpress",
        "launchBrowser": true,
        "environmentVariables": {
          "ASPNETCORE_ENVIRONMENT": "Development"
        }
      }
    }
  }
 
---------------------------------------------------------------------------------------- 
WebApp\Properties\serviceDependencies.json 
{
  "dependencies": {
    "mssql1": {
      "type": "mssql",
      "connectionId": "ConnectionStrings:DefaultConnection"
    }
  }
} 
---------------------------------------------------------------------------------------- 
WebApp\Properties\serviceDependencies.local.json 
{
  "dependencies": {
    "mssql1": {
      "type": "mssql.local",
      "connectionId": "ConnectionStrings:DefaultConnection"
    }
  }
} 
---------------------------------------------------------------------------------------- 
WebApp\Services\Mapper.cs 
namespace Sophia.WebApp.Services;

public static class Mapper {
    public static void UpdateFrom(this World target, WorldData input) {
        target.Location = input.Location;
        target.UserProfile = input.UserProfile.ToModel();
        target.Facts = input.Facts.ToList(i => i.ToModel());
        target.AvailableTools = input.Tools.ToList(i => i.ToModel());
    }

    public static WorldData ToDto(this World input)
        => new() {
            Location = input.Location,
            UserProfile = input.UserProfile.ToDto(),
            Facts = input.Facts.ToList(i => i.ToDto()),
            Tools = input.AvailableTools.ToList(i => i.ToDto()),
        };

    public static ToolData ToDto(this Tool input)
        => new() {
            Id = input.Id,
            Name = input.Name,
            Description = input.Description,
            Arguments = input.Arguments.ToList(i => i.ToDto()),
        };

    public static ArgumentData ToDto(this Argument input)
        => new() {
            Name = input.Name,
            Description = input.Description,
            Type = input.Type,
            Choices = input.Options?.ToList() ?? [],
            IsRequired = input.IsRequired,
        };

    public static FactData ToDto(this Fact input)
        => new() {
            DefaultText = input.DefaultText,
            Value = input.Value,
            ValueTemplate = input.ValueTemplate,
        };

    public static UserProfileData ToDto(this UserProfile input)
        => new() {
            Name = input.Name,
            Language = input.Language,
        };
}
 
---------------------------------------------------------------------------------------- 
WebApp\Services\PersonasService.cs 
namespace Sophia.WebApp.Services;

public class PersonasService(ApplicationDbContext dbContext)
    : IPersonasService {
    public async Task<IReadOnlyList<PersonaData>> GetList(string? filter = null) {
        try {
            return await dbContext.Personas
                                  .Include(p => p.Facts)
                                  .Include(p => p.KnownTools)
                                  .AsNoTracking()
                                  .Select(s => s.ToDto())
                                  .ToArrayAsync();
        } catch (Exception ex) {
            Console.WriteLine(ex);
            throw;
        }
    }

    public async Task<PersonaData?> GetById(int id) {
        var entity = await dbContext.Personas.AsNoTracking()
                                    .FirstOrDefaultAsync(s => s.Id == id);
        return entity?.ToDto();
    }

    public async Task Add(PersonaData selectedPersona) {
        var entity = selectedPersona.ToEntity();
        dbContext.Personas.Add(entity);
        await dbContext.SaveChangesAsync();
        selectedPersona.Id = entity.Id;
    }

    public async Task Update(PersonaData input) {
        var entity = await dbContext.Personas
                                    .FirstOrDefaultAsync(s => s.Id == input.Id);
        entity?.UpdateFrom(input);
        await dbContext.SaveChangesAsync();
    }

    public async Task Delete(int id) {
        var entity = await dbContext.Personas
                                    .FirstOrDefaultAsync(s => s.Id == id);
        if (entity is null) return;
        dbContext.Personas.Remove(entity);
        await dbContext.SaveChangesAsync();
    }
}
 
---------------------------------------------------------------------------------------- 
WebApp\Services\ToolsService.cs 

namespace Sophia.WebApp.Services;

public class ToolsService(ApplicationDbContext dbContext)
    : IToolsService {
    public async Task<IReadOnlyList<ToolData>> GetList(string? filter = null)
        => await dbContext.Tools
                          .AsNoTracking()
                          .Select(s => s.ToDto()).ToArrayAsync();

    public async Task<ToolData?> GetById(int id) {
        var entity = await dbContext.Tools.AsNoTracking()
                              .FirstOrDefaultAsync(s => s.Id == id);
        return entity?.ToDto();
    }

    public async Task Add(ToolData selectedTool) {
        var entity = selectedTool.ToEntity();
        dbContext.Tools.Add(entity);
        await dbContext.SaveChangesAsync();
        selectedTool.Id = entity.Id;
    }

    public async Task Update(ToolData input) {
        var entity = await dbContext.Tools
                                    .FirstOrDefaultAsync(s => s.Id == input.Id);
        entity?.UpdateFrom(input);
        await dbContext.SaveChangesAsync();
    }

    public async Task Delete(int id) {
        var entity = await dbContext.Tools
                                    .FirstOrDefaultAsync(s => s.Id == id);
        if (entity is null) return;
        dbContext.Tools.Remove(entity);
        await dbContext.SaveChangesAsync();
    }
}
 
---------------------------------------------------------------------------------------- 
WebApp\Services\WorldService.cs 
namespace Sophia.WebApp.Services;

public class WorldService(ApplicationDbContext dbContext)
    : IWorldService {
    public async Task<WorldData> GetWorld() {
        try {
            var world = await dbContext.Worlds
                                       .Include(w => w.Facts)
                                       .Include(w => w.Tools)
                                       .AsNoTracking()
                                       .FirstAsync();
            return world.ToDto();
        } catch (Exception ex) {
            Console.WriteLine(ex);
            throw;
        }
    }

    public async Task UpdateWorld(WorldData input) {
        var world = await dbContext.Worlds
                             .Include(w => w.Facts)
                             .Include(w => w.UserProfile)
                             .FirstAsync();
        world.UpdateFrom(input);
        await dbContext.SaveChangesAsync();
    }
}
 
---------------------------------------------------------------------------------------- 
WebApp\wwwroot\app.css 
html, body {
  font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
}

a, .btn-link {
  color: #006bb7;
}

.btn-primary {
  color: #fff;
  background-color: #1b6ec2;
  border-color: #1861ac;
}

.btn:focus, .btn:active:focus, .btn-link.nav-link:focus, .form-control:focus, .form-check-input:focus {
  box-shadow: 0 0 0 0.1rem white, 0 0 0 0.25rem #258cfb;
}

article {
  max-width: 1024px;
}

@media (min-width: 641px) {
  article {
    margin: 0 auto;
  }
}

.content {
  padding-top: 1.1rem;
}

h1:focus {
  outline: none;
}

.valid.modified:not([type=checkbox]) {
  outline: 1px solid #26b050;
}

.invalid {
  outline: 1px solid #e50000;
}

.validation-message {
  color: #e50000;
}

.blazor-error-boundary {
  background: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTYiIGhlaWdodD0iNDkiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIG92ZXJmbG93PSJoaWRkZW4iPjxkZWZzPjxjbGlwUGF0aCBpZD0iY2xpcDAiPjxyZWN0IHg9IjIzNSIgeT0iNTEiIHdpZHRoPSI1NiIgaGVpZ2h0PSI0OSIvPjwvY2xpcFBhdGg+PC9kZWZzPjxnIGNsaXAtcGF0aD0idXJsKCNjbGlwMCkiIHRyYW5zZm9ybT0idHJhbnNsYXRlKC0yMzUgLTUxKSI+PHBhdGggZD0iTTI2My41MDYgNTFDMjY0LjcxNyA1MSAyNjUuODEzIDUxLjQ4MzcgMjY2LjYwNiA1Mi4yNjU4TDI2Ny4wNTIgNTIuNzk4NyAyNjcuNTM5IDUzLjYyODMgMjkwLjE4NSA5Mi4xODMxIDI5MC41NDUgOTIuNzk1IDI5MC42NTYgOTIuOTk2QzI5MC44NzcgOTMuNTEzIDI5MSA5NC4wODE1IDI5MSA5NC42NzgyIDI5MSA5Ny4wNjUxIDI4OS4wMzggOTkgMjg2LjYxNyA5OUwyNDAuMzgzIDk5QzIzNy45NjMgOTkgMjM2IDk3LjA2NTEgMjM2IDk0LjY3ODIgMjM2IDk0LjM3OTkgMjM2LjAzMSA5NC4wODg2IDIzNi4wODkgOTMuODA3MkwyMzYuMzM4IDkzLjAxNjIgMjM2Ljg1OCA5Mi4xMzE0IDI1OS40NzMgNTMuNjI5NCAyNTkuOTYxIDUyLjc5ODUgMjYwLjQwNyA1Mi4yNjU4QzI2MS4yIDUxLjQ4MzcgMjYyLjI5NiA1MSAyNjMuNTA2IDUxWk0yNjMuNTg2IDY2LjAxODNDMjYwLjczNyA2Ni4wMTgzIDI1OS4zMTMgNjcuMTI0NSAyNTkuMzEzIDY5LjMzNyAyNTkuMzEzIDY5LjYxMDIgMjU5LjMzMiA2OS44NjA4IDI1OS4zNzEgNzAuMDg4N0wyNjEuNzk1IDg0LjAxNjEgMjY1LjM4IDg0LjAxNjEgMjY3LjgyMSA2OS43NDc1QzI2Ny44NiA2OS43MzA5IDI2Ny44NzkgNjkuNTg3NyAyNjcuODc5IDY5LjMxNzkgMjY3Ljg3OSA2Ny4xMTgyIDI2Ni40NDggNjYuMDE4MyAyNjMuNTg2IDY2LjAxODNaTTI2My41NzYgODYuMDU0N0MyNjEuMDQ5IDg2LjA1NDcgMjU5Ljc4NiA4Ny4zMDA1IDI1OS43ODYgODkuNzkyMSAyNTkuNzg2IDkyLjI4MzcgMjYxLjA0OSA5My41Mjk1IDI2My41NzYgOTMuNTI5NSAyNjYuMTE2IDkzLjUyOTUgMjY3LjM4NyA5Mi4yODM3IDI2Ny4zODcgODkuNzkyMSAyNjcuMzg3IDg3LjMwMDUgMjY2LjExNiA4Ni4wNTQ3IDI2My41NzYgODYuMDU0N1oiIGZpbGw9IiNGRkU1MDAiIGZpbGwtcnVsZT0iZXZlbm9kZCIvPjwvZz48L3N2Zz4=) no-repeat 1rem/1.8rem, #b32121;
  padding: 1rem 1rem 1rem 3.7rem;
  color: white;
}

  .blazor-error-boundary::after {
    content: "An error has occurred."
  }

.darker-border-checkbox.form-check-input {
  border-color: #929292;
}

.container {
  border-radius: 0.25rem;
}

.container-header {
  margin-bottom: 2rem;
}

.container-body {
  margin-bottom: 2rem;
}

.grid {
  background-color: white;
}

.form-label {
  font-weight: 500;
}

.form-control {
  background-color: white;
}

  .form-control:disabled {
    background-color: #e9ecef;
  }

.btn-group > .btn {
  flex: 1;
}

.table td.fit,
.table th.fit {
  white-space: nowrap;
  width: 1%;
}
 
---------------------------------------------------------------------------------------- 
WebClient\GlobalUsings.cs 
global using System.Diagnostics.CodeAnalysis;
global using System.Net.Http.Json;
global using System.Security.Claims;

global using Microsoft.AspNetCore.Components;
global using Microsoft.AspNetCore.Components.Authorization;
global using Microsoft.AspNetCore.Components.Forms;
global using Microsoft.AspNetCore.Components.WebAssembly.Hosting;
global using Microsoft.Extensions.DependencyInjection;

global using Sophia.Models.Common;
global using Sophia.Models.Personas;
global using Sophia.Models.Tools;
global using Sophia.Models.Worlds;
global using Sophia.Services;
global using Sophia.WebClient.Account;
global using Sophia.WebClient.Pages;
global using Sophia.WebClient.Services;
 
---------------------------------------------------------------------------------------- 
WebClient\Program.cs 
var builder = WebAssemblyHostBuilder.CreateDefault(args);

builder.Services.AddAuthorizationCore();
builder.Services.AddCascadingAuthenticationState();
builder.Services.AddSingleton<AuthenticationStateProvider, PersistentAuthenticationStateProvider>();

builder.Services.AddScoped<IWorldRemoteService, WorldRemoteService>();
builder.Services.AddScoped<IToolsRemoteService, ToolsRemoteService>();
builder.Services.AddScoped<IPersonasRemoteService, PersonasRemoteService>();
builder.Services.AddScoped(sp => new HttpClient {
    BaseAddress = new(builder.Configuration["FrontendUrl"] ?? "https://localhost:7100"),
});

await builder.Build().RunAsync();
 
---------------------------------------------------------------------------------------- 
WebClient\_Imports.razor 
@using System.ComponentModel.DataAnnotations
@using System.Diagnostics
@using System.Globalization
@using System.Net.Http
@using System.Net.Http.Json
@using System.Security.Claims
@using System.Text
@using System.Text.Encodings.Web

@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Routing
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components.Web.Virtualization
@using Microsoft.JSInterop
@using static Microsoft.AspNetCore.Components.Web.RenderMode

@using DotNetToolbox.AI.Common
@using DotNetToolbox.Collections.Generic

@using Sophia.WebClient.Components.Dialogs;

 
---------------------------------------------------------------------------------------- 
WebClient\Account\PersistentAuthenticationStateProvider.cs 
namespace Sophia.WebClient.Account;
internal class PersistentAuthenticationStateProvider : AuthenticationStateProvider {
    private static readonly AuthenticationState _unauthenticated =
        new(new(new ClaimsIdentity()));

    private readonly AuthenticationState _authenticationState = _unauthenticated;

    public PersistentAuthenticationStateProvider(PersistentComponentState state) {
        if (!state.TryTakeFromJson<UserInfo>(nameof(UserInfo), out var userInfo) || userInfo is null)
            return;

        var claims = new Claim[] {
            new(ClaimTypes.NameIdentifier, userInfo.UserId),
            new(ClaimTypes.GivenName, userInfo.Name),
            new(ClaimTypes.Name, userInfo.Email),
            new(ClaimTypes.Email, userInfo.Email),
        };

        var identity = new ClaimsIdentity(claims, authenticationType: nameof(PersistentAuthenticationStateProvider));
        _authenticationState = new(new(identity));
    }

    public override Task<AuthenticationState> GetAuthenticationStateAsync()
        => Task.FromResult(_authenticationState);
}
 
---------------------------------------------------------------------------------------- 
WebClient\Account\UserInfo.cs 
namespace Sophia.WebClient.Account;

public class UserInfo {
    public const string DefaultName = "User";
    public string Name { get; set; } = DefaultName;
    public required string UserId { get; set; }
    public required string Email { get; set; }
}
 
---------------------------------------------------------------------------------------- 
WebClient\Account\RedirectToLogin.razor 
@inject NavigationManager NavigationManager

@code {
    protected override void OnInitialized()
    {
        NavigationManager.NavigateTo($"Account/Login?returnUrl={Uri.EscapeDataString(NavigationManager.Uri)}", forceLoad: true);
    }
}
 
---------------------------------------------------------------------------------------- 
WebClient\Components\Dialogs\ArgumentDialog.razor.cs 
namespace Sophia.WebClient.Components.Dialogs;

public partial class ArgumentDialog {
    [Parameter]
    public PageAction Action { get; set; }

    [Parameter]
    public ArgumentData Argument { get; set; } = new();

    [Parameter]
    public EventCallback OnSave { get; set; }

    [Parameter]
    public EventCallback OnCancel { get; set; }

    private ArgumentData _argument = new();
    private EditContext _editContext;
    private ValidationMessageStore _validationMessageStore;

    public ArgumentDialog() {
        _editContext = new(_argument);
        _validationMessageStore = new(_editContext);
    }

    protected override void OnInitialized()
        => _argument = Argument;

    protected override void OnParametersSet() {
        _editContext = new(_argument);
        _validationMessageStore = new(_editContext);
        _editContext.OnValidationRequested += OnValidationRequested;
        base.OnParametersSet();
    }

    private void OnValidationRequested(object? sender, ValidationRequestedEventArgs e) {
        _validationMessageStore.Clear(() => _argument.Choices);
        var result = _argument.ValidateChoices();
        if (result != null) _validationMessageStore!.Add(() => _argument.Choices, result);
    }

    private void Save() => OnSave.InvokeAsync();

    private void Cancel()
        => OnCancel.InvokeAsync();

    private void InsertOption(int index = -1) {
        if (index == _argument.Choices.Count - 1) _argument.Choices.Add(string.Empty);
        else _argument.Choices.Insert(index + 1, string.Empty);
    }

    private void RemoveOption(int index)
        => _argument.Choices.RemoveAt(index);
}
 
---------------------------------------------------------------------------------------- 
WebClient\Components\Dialogs\ConfirmationDialog.razor.cs 
namespace Sophia.WebClient.Components.Dialogs;

public partial class ConfirmationDialog {
    [Parameter]
    public string Message { get; set; } = "";

    [Parameter]
    public EventCallback OnConfirm { get; set; }

    [Parameter]
    public EventCallback OnCancel { get; set; }

    private void Confirm() => OnConfirm.InvokeAsync();

    private void Cancel() => OnCancel.InvokeAsync();
}
 
---------------------------------------------------------------------------------------- 
WebClient\Components\Dialogs\FactDialog.razor.cs 
namespace Sophia.WebClient.Components.Dialogs;

public partial class FactDialog {
    [Parameter]
    public FactData Fact { get; set; } = default!;

    [Parameter]
    public EventCallback OnSave { get; set; }

    [Parameter]
    public EventCallback OnCancel { get; set; }

    [Parameter]
    public string Action { get; set; } = default!;

    private void Save() {
        if (Fact.Validate() is null) {
            OnSave.InvokeAsync();
        }
    }

    private void Cancel() => OnCancel.InvokeAsync();
}
 
---------------------------------------------------------------------------------------- 
WebClient\Components\Dialogs\ToolSelectionDialog.razor.cs 
namespace Sophia.WebClient.Components.Dialogs;

public partial class ToolSelectionDialog {
    [Parameter]
    public IReadOnlyCollection<ToolData> AvailableTools { get; set; } = [];

    [Parameter]
    public List<ToolData> SelectedTools { get; set; } = [];

    [Parameter]
    public EventCallback<List<ToolData>> OnToolsSelected { get; set; }

    [Parameter]
    public EventCallback OnCancel { get; set; }

    public bool HasTools => AvailableTools.Count != 0;
    private string _searchText = string.Empty;

    private List<ToolData> FilteredTools
        => AvailableTools
          .Where(s => s.Name.Contains(_searchText, StringComparison.OrdinalIgnoreCase)
                   || (s.Description?.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ?? false))
          .ToList();

    private bool IsSelected(ToolData tool)
        => SelectedTools.Contains(tool);

    private void ToggleSelection(ToolData tool) {
        if (IsSelected(tool)) SelectedTools.Remove(tool);
        else SelectedTools.Add(tool);
    }

    private void Confirm()
        => OnToolsSelected.InvokeAsync(SelectedTools);

    private void Cancel()
        => OnCancel.InvokeAsync();
}
 
---------------------------------------------------------------------------------------- 
WebClient\Components\Dialogs\ArgumentDialog.razor 
<div class="modal modal-lg fade show" tabindex="-1" role="dialog" style="display: block;">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">@Action Argument</h5>
        <button type="button" class="btn-close" @onclick="Cancel"></button>
      </div>
      <div class="modal-body">
        <EditForm EditContext="_editContext" id="argument-form" OnValidSubmit="Save">
          <DataAnnotationsValidator />
          <div class="row mb-3">
            <div class="col-8">
              <label for="argumentName" class="form-label me-2">Name</label>
            </div>
            <div class="col-4">
              <div class="form-check-reverse">
                <label class="form-check-label" for="argumentRequired">Required</label>
                <InputCheckbox id="argumentRequired" class="form-check-input" @bind-Value="_argument.IsRequired" />
              </div>
            </div>
            <InputText id="argumentName" class="form-control me-2" @bind-Value="_argument.Name" />
            <ValidationMessage For="@(() => _argument.Name)" />
          </div>
          <div class="row mb-3">
            <div class="col-3">
              <label for="argumentType" class="form-label me-2">Type</label>
              <InputSelect id="argumentType" class="form-control me-2" @bind-Value="_argument.Type">
                @foreach (var type in Enum.GetValues<ArgumentType>()) {
                  <option value="@type">@type</option>
                }
              </InputSelect>
            </div>
            <div class="col-9 grid">
              @if (_argument.Type == ArgumentType.Enum) {
                <table class="table w-100">
                  <thead>
                    <tr>
                      <th class="fit">
                        <button class="btn btn-primary btn-sm" @onclick="() => InsertOption()" @onclick:preventDefault>
                          <i class="bi bi-plus-circle"></i>
                        </button>
                      </th>
                      <th>Choices</th>
                    </tr>
                  </thead>
                  <tbody>
                    @for (var i = 0; i < _argument.Choices.Count; i++)
                    {
                      var index = i;
                      <tr>
                        <td>
                          <button class="btn btn-primary btn-sm" @onclick="() => InsertOption(index)" @onclick:preventDefault>
                            <i class="bi bi-plus-circle"></i>
                          </button>
                          <button class="btn btn-danger btn-sm" @onclick="() => RemoveOption(index)" @onclick:preventDefault>
                            <i class="bi bi-trash"></i>
                          </button>
                        </td>
                        <td>
                          <InputText class="form-control" @bind-Value="_argument.Choices[index]" />
                        </td>
                      </tr>
                    }
                  </tbody>
                </table>
                <ValidationMessage For="@(() => _argument.Choices)" />
              }
            </div>
          </div>
          <div class="row mb-3">
            <label for="argumentDescription" class="form-label">Description</label>
            <InputTextArea id="argumentDescription" class="form-control" @bind-Value="_argument.Description" />
            <ValidationMessage For="@(() => _argument.Description)" />
          </div>
        </EditForm>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" @onclick="Cancel">Cancel</button>
        <button type="submit" class="btn btn-primary" form="argument-form">Save</button>
      </div>
    </div>
  </div>
</div>
 
---------------------------------------------------------------------------------------- 
WebClient\Components\Dialogs\ConfirmationDialog.razor 
<div class="modal fade show" tabindex="-1" role="dialog" style="display: block;">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirmation</h5>
        <button type="button" class="btn-close" @onclick="Cancel"></button>
      </div>
      <div class="modal-body">
        <p>@Message</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" @onclick="Cancel">Cancel</button>
        <button type="button" class="btn btn-danger" @onclick="Confirm">Delete</button>
      </div>
    </div>
  </div>
</div>
 
---------------------------------------------------------------------------------------- 
WebClient\Components\Dialogs\FactDialog.razor 
<div class="modal modal-lg fade show" tabindex="-1" role="dialog" style="display: block;">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">@Action Fact</h5>
        <button type="button" class="btn-close" @onclick="Cancel"></button>
      </div>
      <div class="modal-body">
        <EditForm Model="@Fact" OnValidSubmit="Save">
          <DataAnnotationsValidator />
          <div class="row mb-3">
            <div class="col-8">
              <label for="factValue" class="form-label">Value</label>
              <InputText id="factValue" class="form-control" @bind-Value="Fact.Value" />
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-8">
              <label for="factValueTemplate" class="form-label">Value Template</label>
              <InputText id="factValueTemplate" class="form-control" @bind-Value="Fact.ValueTemplate" />
              <ValidationMessage For="@(() => Fact.ValueTemplate)" />
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-8">
              <label for="factDefaultText" class="form-label">Default Text</label>
              <InputText id="factDefaultText" class="form-control" @bind-Value="Fact.DefaultText" />
              <ValidationMessage For="@(() => Fact.DefaultText)" />
            </div>
          </div>
        </EditForm>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" @onclick="Cancel">Cancel</button>
        <button type="button" class="btn btn-primary" @onclick="Save">Save</button>
      </div>
    </div>
  </div>
</div>
 
---------------------------------------------------------------------------------------- 
WebClient\Components\Dialogs\ToolSelectionDialog.razor 
<div class="modal modal-lg fade show" tabindex="-1" role="dialog" style="display: block;">
  <div class="modal-dialog modal-dialog-scrollable" role="document">
    <div class="modal-content">
      @if (HasTools) {
        <div class="modal-header">
          <h5 class="modal-title">Select Tools</h5>
          <button type="button" class="btn-close" @onclick="Cancel"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <input type="text" class="form-control" placeholder="Search Tools..." @bind="_searchText" />
          </div>
          @if (FilteredTools.Count != 0) {
            <ul class="list-group">
              @foreach (var tool in FilteredTools) {
                <li class="list-group-item">
                  <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="Tool-@tool.Id"
                           checked="@IsSelected(tool)" @onchange="() => ToggleSelection(tool)" />
                    <label class="form-check-label" for="Tool-@tool.Id">@tool.Name</label>
                  </div>
                </li>
              }
            </ul>
          }
          else {
            <h5>No tools were found for the selected filter.</h5>
          }
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" @onclick="Cancel">Cancel</button>
          <button type="button" class="btn btn-primary" @onclick="Confirm">Confirm</button>
        </div>
      }
      else
      {
        <div class="modal-header">
          <h5 class="modal-title">There are no Tools available</h5>
          <button type="button" class="btn-close" @onclick="Cancel"></button>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" @onclick="Cancel">OK</button>
        </div>
      }
    </div>
  </div>
</div>
 
---------------------------------------------------------------------------------------- 
WebClient\Pages\PageAction.cs 
namespace Sophia.WebClient.Pages;

public enum PageAction {
    View,
    Edit,
    Add,
}
 
---------------------------------------------------------------------------------------- 
WebClient\Pages\PersonasPage.razor.cs 
namespace Sophia.WebClient.Pages;

public partial class PersonasPage {
    [Inject]
    public required IPersonasService PersonasService { get; set; }

    [Inject]
    public required NavigationManager NavigationManager { get; set; }

    private IReadOnlyList<PersonaData> _personas = [];

    protected override async Task OnInitializedAsync()
        => _personas = await PersonasService.GetList();

    private void Add()
        => NavigationManager.NavigateTo("/Personas/Add");

    private void View(PersonaData persona)
        => NavigationManager.NavigateTo($"/Personas/View/{persona.Id}");

    private void Edit(PersonaData persona)
        => NavigationManager.NavigateTo($"/Personas/Edit/{persona.Id}");

    private async Task Delete(PersonaData persona) {
        // TODO: Implement delete confirmation dialog
        await PersonasService.Delete(persona.Id);
        _personas = await PersonasService.GetList();
    }
}
 
---------------------------------------------------------------------------------------- 
WebClient\Pages\PersonasPage.razor 
@page "/Personas"
@rendermode InteractiveServer

<div class="container">
  <div class="container-header row mb-3">
    <div class="col-md-6">
      <h3>Personas</h3>
    </div>
  </div>

  <div class="container-body">
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
      <div class="col">
        <div class="card clickable" @onclick="Add">
          <div class="card-body  d-flex flex-column justify-content-center align-items-center">
            <i class="bi bi-plus-circle" style="font-size: 3rem;"></i>
            <h5 class="card-title mt-2">Add Persona</h5>
          </div>
        </div>
      </div>
      @foreach (var persona in _personas) {
        <div class="col">
          <div class="card clickable" @onclick="() => View(persona)">
            <div class="card-body  d-flex flex-column justify-content-center align-items-center">
              <i class="bi bi-person-circle" style="font-size: 3rem;"></i>
              <h5 class="card-title mt-2">@persona.Name</h5>
            </div>
          </div>
        </div>
      }
    </div>
  </div>
</div>
 
---------------------------------------------------------------------------------------- 
WebClient\Pages\SettingsPage.razor 
@page "/Settings"
@rendermode InteractiveServer

<div class="container">
  <div class="container-header row mb-3">
    <div class="col-md-6">
      <h3>Settings</h3>
    </div>
  </div>

  <div class="container-body">
    <div class="row justify-content-center">
      <div class="col-md-4 mb-4">
        <div class="card">
          <a href="/Settings/World" class="btn btn-outline-primary stretched-link">
            <div class="card-body text-center">
              <i class="fas fa-globe fa-3x mb-3"></i>
              <h5 class="card-title">World Settings</h5>
            </div>
          </a>
        </div>
      </div>
      <div class="col-md-4 mb-4">
        <div class="card">
          <a href="/Settings/Tools" class="btn btn-outline-primary stretched-link">
            <div class="card-body text-center">
              <i class="fas fa-toolbox fa-3x mb-3"></i>
              <h5 class="card-title">Tools Management</h5>
            </div>
          </a>
        </div>
      </div>
    </div>
  </div>
</div>
 
---------------------------------------------------------------------------------------- 
WebClient\Pages\PersonasPage.razor.css 
.clickable {
  cursor: pointer;
  transition: all 0.2s ease-in-out;
}

.clickable:hover {
  transform: translateY(-5px);
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.persona-card {
  border-radius: 10px;
  background-color: #f8f9fa;
  border: 2px solid #dee2e6;
}

.persona-card:hover {
  background-color: #e9ecef;
  border-color: #c1c9d0;
}

.persona-card .card-title {
  font-size: 1.1rem;
  font-weight: 500;
  color: #212529;
} 
---------------------------------------------------------------------------------------- 
WebClient\Pages\Personas\PersonaPage.razor.cs 
namespace Sophia.WebClient.Pages.Personas;

public partial class PersonaPage {
    [Inject]
    public required IPersonasRemoteService PersonasService { get; set; }
    [Inject]
    public required IToolsRemoteService ToolsService { get; set; }

    [Inject]
    public required NavigationManager NavigationManager { get; set; }

    private PersonaData _persona = new();
    private PageAction _action;
    private IReadOnlyCollection<ToolData> _availableTools = [];
    private List<ToolData> _toolSelectionBuffer = [];
    private bool _showToolSelectionDialog;

    private FactData? _selectedFact;
    private bool _showFactDialog;

    private bool _showDeleteConfirmationDialog;

    [Parameter]
    [SuppressMessage("Usage", "BL0007:Component parameters should be auto properties", Justification = "<Pending>")]
    public string Action {
        get => _action.ToString();
        set => _action = Enum.Parse<PageAction>(value);
    }
    public bool IsReadOnly => _action == PageAction.View;

    [Parameter]
    public int? PersonaId { get; set; }

    protected override async Task OnInitializedAsync()
        => _persona = await GetPersonaById(PersonaId);

    private async Task<PersonaData> GetPersonaById(int? personaId)
        => personaId is null
               ? new()
               : await PersonasService.GetById(personaId.Value)
              ?? throw new InvalidOperationException();

    private void EnableEdit() => _action = PageAction.Edit;

    private void GoBack() => NavigationManager.NavigateTo("/Personas");

    private async Task Save() {
        if (_persona.Id == 0) await PersonasService.Add(_persona);
        else await PersonasService.Update(_persona);
        _action = PageAction.View;
    }

    private Task Cancel() {
        if (_action == PageAction.Edit) return CancelEdit();
        GoBack();
        return Task.CompletedTask;
    }

    private async Task CancelEdit() {
        _action = PageAction.View;
        _persona = await GetPersonaById(PersonaId);
    }

    private void AddInstruction()
        => _persona.Instructions.Add(string.Empty);
    private void RemoveInstruction(int index)
        => _persona.Instructions.RemoveAt(index);

    private void AddFact() {
        _selectedFact = new();
        _showFactDialog = true;
    }

    private void EditFact(FactData fact) {
        _selectedFact = fact;
        _showFactDialog = true;
    }

    private void SaveFact() {
        if (_selectedFact!.Id == 0)
            _persona.Facts.Add(_selectedFact);
        CloseFactDialog();
    }
    private void CloseFactDialog() {
        _showFactDialog = false;
        _selectedFact = null;
    }

    private void RemoveFact(FactData fact) {
        _persona.Facts.Remove(fact);
        _selectedFact = null;
    }

    private async Task OpenToolSelectionDialog() {
        _availableTools = await ToolsService.GetList();
        _toolSelectionBuffer = [.. _persona.KnownTools];
        _showToolSelectionDialog = true;
    }

    private void CloseToolSelectionDialog() {
        _toolSelectionBuffer = [];
        _showToolSelectionDialog = false;
    }

    private void FinishToolSelection(List<ToolData> tools) {
        _persona.KnownTools = tools;
        CloseToolSelectionDialog();
    }

    private void RemoveTool(ToolData tool)
        => _persona.KnownTools.Remove(tool);

    private void Delete()
        => _showDeleteConfirmationDialog = true;

    private void CancelDelete()
        => _showDeleteConfirmationDialog = false;

    private async Task ExecuteDelete() {
        _showDeleteConfirmationDialog = false;
        await PersonasService.Delete(_persona.Id);
        NavigationManager.NavigateTo("/Personas");
    }
}
 
---------------------------------------------------------------------------------------- 
WebClient\Pages\Personas\PersonaPage.razor 
@page "/Personas/{Action}/{PersonaId:int?}"
@rendermode InteractiveWebAssembly

<div class="container">
  <div class="container-header row mb-3">
    <div class="col-md-6">
      <h3>@_action Persona</h3>
    </div>
    <div class="col-md-6 text-md-end">
      @if (IsReadOnly) {
        <button type="button" class="btn btn-danger me-4" @onclick="Delete">
          <i class="bi bi-trash me-2"></i>Delete
        </button>
        <button type="button" class="btn btn-primary me-4" @onclick="EnableEdit">
          <i class="bi bi-pencil-square me-2"></i>Edit
        </button>
        <button type="button" class="btn btn-secondary" @onclick="GoBack" @onclick:preventDefault>
          <i class="bi bi-back me-2"></i>Back
        </button>
      }
      else {
        <button type="submit" class="btn btn-success me-4" form="persona-form">
          <i class="bi bi-save me-2"></i>Save
        </button>
        <button type="button" class="btn btn-secondary" @onclick="Cancel">
          <i class="bi bi-x-circle me-2"></i>Cancel
        </button>
      }
    </div>
  </div>

  <div class="container-body">
    <EditForm Model="@_persona" OnValidSubmit="Save" id="persona-form">
      <DataAnnotationsValidator />
      <ValidationSummary />

      <div class="mb-3">
        <label for="personaName" class="form-label">Name</label>
        <InputText id="personaName" class="form-control" @bind-Value="_persona.Name" disabled="@IsReadOnly" />
        <ValidationMessage For="@(() => _persona.Name)" />
      </div>
      <div class="mb-3">
        <label for="personaDescription" class="form-label">Description</label>
        <InputTextArea id="personaDescription" class="form-control" @bind-Value="_persona.Description" disabled="@IsReadOnly" />
        <ValidationMessage For="@(() => _persona.Description)" />
      </div>
      <div class="mb-3">
        <label for="personaPersonality" class="form-label">Personality</label>
        <InputTextArea id="personaPersonality" class="form-control" @bind-Value="_persona.Personality" disabled="@IsReadOnly" />
        <ValidationMessage For="@(() => _persona.Personality)" />
      </div>

      <!-- Instructions -->
      <div class="mb-3">
        <div class="row mb-2">
          <div class="col">
            @if (!IsReadOnly) {
              <button class="btn btn-sm btn-primary me-2" @onclick="AddInstruction" @onclick:preventDefault>
                <i class="bi bi-plus-circle"></i>
              </button>
            }
            <label class="form-label">Instructions</label>
          </div>
        </div>
        <ValidationMessage For="@(() => _persona.Instructions)" />
        @for (var i = 0; i < _persona.Instructions.Count; i++) {
          var index = i;
          <div class="row mb-2">
            <div class="col-md-1">
              @if (!IsReadOnly) {
                <button class="btn btn-sm btn-danger" @onclick="() => RemoveInstruction(index)" @onclick:preventDefault>
                  <i class="bi bi-trash"></i>
                </button>
              }
            </div>
            <div class="col-md-11">
              <InputText class="form-control" @bind-Value="_persona.Instructions[index]" disabled="@IsReadOnly" />
            </div>
          </div>
        }
      </div>

      <!-- Facts -->
      <div class="mb-3">
        <div class="row mb-2">
          <div class="col">
            @if (!IsReadOnly) {
              <button class="btn btn-sm btn-primary me-2" @onclick="AddFact" @onclick:preventDefault>
                <i class="bi bi-plus-circle"></i>
              </button>
            }
            <label class="form-label">Facts</label>
          </div>
        </div>
        <ValidationMessage For="@(() => _persona.Facts)" />
        @foreach (var fact in _persona.Facts) {
          <div class="row mb-2">
            <div class="col-md-1">
              @if (!IsReadOnly) {
                <button class="btn btn-sm btn-danger" @onclick="() => RemoveFact(fact)" @onclick:preventDefault>
                  <i class="bi bi-trash"></i>
                </button>
                <button class="btn btn-sm btn-primary" @onclick="() => EditFact(fact)" @onclick:preventDefault>
                  <i class="bi bi-pencil"></i>
                </button>
              }
            </div>
            <div class="col">
              <InputText class="form-control" @bind-Value="fact.Value" readonly />
            </div>
          </div>
        }
      </div>

      <!-- Known Tools -->
      <div class="mb-3">
        <div class="row mb-2">
          <div class="col">
            @if (!IsReadOnly) {
              <button class="btn btn-sm btn-primary me-2" @onclick="OpenToolSelectionDialog" @onclick:preventDefault>
                <i class="bi bi-plus-circle"></i>
              </button>
            }
            <label class="form-label">Known Tools</label>
          </div>
        </div>
        <ValidationMessage For="@(() => _persona.Instructions)" />
        <ul class="list-group">
          @foreach (var tool in _persona.KnownTools) {
            <li class="list-group-item d-flex justify-content-between align-items-center">
              @tool.Name
              @if (!IsReadOnly) {
                <button class="btn btn-sm btn-danger" @onclick="() => RemoveTool(tool)">
                  <i class="bi bi-trash"></i>
                </button>
              }
            </li>
          }
        </ul>
      </div>

    </EditForm>
  </div>
</div>

@if (_showFactDialog) {
  <FactDialog Fact="_selectedFact" Action="@(_selectedFact!.Id == 0 ? "Add" : "Edit")"
              OnSave="SaveFact" OnCancel="CloseFactDialog" />
}

@if (_showToolSelectionDialog) {
  <ToolSelectionDialog AvailableTools="_availableTools"
                       SelectedTools="_toolSelectionBuffer"
                       OnToolsSelected="FinishToolSelection"
                       OnCancel="CloseToolSelectionDialog" />
}

@if (_showDeleteConfirmationDialog) {
  <ConfirmationDialog Message="Are you sure you want to delete this tool?"
                      OnConfirm="ExecuteDelete"
                      OnCancel="CancelDelete" />
}
 
---------------------------------------------------------------------------------------- 
WebClient\Pages\Personas\PersonaPage.razor.css 
 
---------------------------------------------------------------------------------------- 
WebClient\Pages\Settings\ToolPage.razor.cs 
namespace Sophia.WebClient.Pages.Settings;

public partial class ToolPage {

    private PageAction _argumentAction = PageAction.View;
    private IReadOnlyList<ToolData> _existingTools = [];
    private ToolData _tool = new();
    private EditContext _editContext;
    private ValidationMessageStore _validationMessageStore;
    private ArgumentData? _selectedArgument;
    private bool _showArgumentDialog;
    private bool _showDeleteConfirmationDialog;

    [Inject]
    public required IToolsRemoteService ToolsService { get; set; }

    [Inject]
    public required NavigationManager NavigationManager { get; set; }

    private PageAction _action;
    [Parameter]
    [SuppressMessage("Usage", "BL0007:Component parameters should be auto properties", Justification = "<Pending>")]
    public string Action {
        get => _action.ToString();
        set => _action = Enum.Parse<PageAction>(value); }
    public bool IsReadOnly => _action == PageAction.View;

    [Parameter]
    public int? ToolId { get; set; }

    public ToolPage() {
        _editContext = new(_tool);
        _validationMessageStore = new(_editContext);
    }

    protected override async Task OnInitializedAsync() {
        _existingTools = await ToolsService.GetList();
        _tool = await GetToolById(ToolId);
    }

    private async Task<ToolData> GetToolById(int? toolId)
        => toolId is null
               ? new()
               : await ToolsService.GetById(toolId.Value)
              ?? throw new InvalidOperationException();

    protected override void OnParametersSet() {
        _editContext = new(_tool);
        _validationMessageStore = new(_editContext);
        _editContext.OnValidationRequested += OnValidationRequested;
        base.OnParametersSet();
    }

    private void OnValidationRequested(object? sender, ValidationRequestedEventArgs e) {
        _validationMessageStore.Clear(() => _tool);
        var result = _tool.ValidateSignature(_existingTools);
        if (result != null) _validationMessageStore.Add(() => _tool, result);
    }

    private void EnableEdit() => _action = PageAction.Edit;

    private async Task Save(EditContext editContext) {
        if (_tool.Id == 0) await ToolsService.Add(_tool);
        else await ToolsService.Update(_tool);
        _action = PageAction.View;
    }

    private Task Cancel() {
        if (_action == PageAction.Edit) return CancelEdit();
        GoBack();
        return Task.CompletedTask;
    }

    private async Task CancelEdit() {
        _action = PageAction.View;
        _tool = await GetToolById(ToolId);
    }

    private void GoBack() => NavigationManager.NavigateTo("/Settings/Tools");

    private void Add() {
        _selectedArgument = new();
        _argumentAction = PageAction.Add;
        _showArgumentDialog = true;
    }

    private void View(ArgumentData argument) {
        _selectedArgument = argument;
        _argumentAction = PageAction.View;
        _showArgumentDialog = true;
    }

    private void Edit(ArgumentData argument) {
        _selectedArgument = argument;
        _argumentAction = PageAction.Edit;
        _showArgumentDialog = true;
    }

    private void CloseArgumentModal() {
        _showArgumentDialog = false;
        _selectedArgument = null;
    }

    private void SaveArgument() {
        _showArgumentDialog = false;
        if (_argumentAction == PageAction.Add)
            _tool.Arguments.Add(_selectedArgument!);
    }

    private void Delete(ArgumentData argument) {
        _selectedArgument = argument;
        _showDeleteConfirmationDialog = true;
    }

    private void CancelDelete() {
        _showDeleteConfirmationDialog = false;
        _selectedArgument = null;
    }

    private void ExecuteDelete() {
        _showDeleteConfirmationDialog = false;
        _tool.Arguments.Remove(_selectedArgument!);
    }

    private void MoveUp(ArgumentData argument) {
        var minimum = argument.IsRequired
                          ? 0
                          : _tool.Arguments.Count(a => a.IsRequired);
        var index = _tool.Arguments.IndexOf(argument);
        if (index <= minimum) return;
        _tool.Arguments.Remove(argument);
        _tool.Arguments.Insert(index - 1, argument);
    }

    private void MoveDown(ArgumentData argument) {
        var maximum = argument.IsRequired
                          ? _tool.Arguments.Count(a => a.IsRequired)
                          : _tool.Arguments.Count;
        var index = _tool.Arguments.IndexOf(argument);
        if (index >= maximum - 1) return;
        _tool.Arguments.Remove(argument);
        _tool.Arguments.Insert(index + 1, argument);
    }
}
 
---------------------------------------------------------------------------------------- 
WebClient\Pages\Settings\ToolsPage.razor.cs 
namespace Sophia.WebClient.Pages.Settings;

public partial class ToolsPage {
    private IReadOnlyList<ToolData> _tools = [];
    private ToolData? _selectedTool;
    private bool _showDeleteConfirmationDialog;

    [Inject]
    public required IToolsService ToolsService { get; set; }

    [Inject]
    public required NavigationManager NavigationManager { get; set; }

    protected override async Task OnInitializedAsync()
        => _tools = await ToolsService.GetList();

    private void View(ToolData tool)
        => NavigationManager.NavigateTo($"/Settings/Tool/{PageAction.View}/{tool.Id}");

    private void Add()
        => NavigationManager.NavigateTo($"/Settings/Tool/{PageAction.Add}/0");

    private void Edit(ToolData tool)
        => NavigationManager.NavigateTo($"/Settings/Tool/{PageAction.Edit}/{tool.Id}");

    private void Delete(ToolData tool) {
        _selectedTool = tool;
        _showDeleteConfirmationDialog = true;
    }

    private void CancelDelete() {
        _selectedTool = null;
        _showDeleteConfirmationDialog = false;
    }

    private async Task ExecuteDelete() {
        await ToolsService.Delete(_selectedTool!.Id);
        _tools = await ToolsService.GetList();
        _selectedTool = null;
        _showDeleteConfirmationDialog = false;
    }
}
 
---------------------------------------------------------------------------------------- 
WebClient\Pages\Settings\WorldPage.razor.cs 
using Timer = System.Timers.Timer;

namespace Sophia.WebClient.Pages.Settings;

public partial class WorldPage
    : IDisposable {
    private WorldData _world = new();
    private bool _isReadOnly = true;
    private string _dateTime = string.Empty;
    private Timer? _timer;

    private IReadOnlyCollection<ToolData> _availableTools = [];
    private List<ToolData> _toolSelectionBuffer = [];
    private bool _showToolSelectionDialog;

    private FactData? _selectedFact;
    private bool _showFactDialog;

    [Inject]
    public required IWorldRemoteService WorldService { get; set; }

    [Inject]
    public required IToolsRemoteService ToolsService { get; set; }

    [Inject]
    public required ILogger<WorldPage> Logger { get; set; }

    protected override async Task OnInitializedAsync() {
        await base.OnInitializedAsync();
        _world = await WorldService.GetWorld();
        _dateTime = _world.DateTime.ToString("yyyy-MM-dd HH:mm:ss");
        _timer = new(1000) { AutoReset = true, Enabled = true };
        _timer.Elapsed += (_, _) => UpdateDateTime();
        _timer.Start();
    }

    public void Dispose() {
        _timer?.Stop();
        _timer?.Dispose();
        _timer = null;
    }

    private void UpdateDateTime() {
        _dateTime = DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss");
        Logger.LogInformation("{DateTime}", _dateTime);
        InvokeAsync(StateHasChanged);
    }

    private void EnableEdit()
        => _isReadOnly = false;

    private async Task Cancel() {
        _world = await WorldService.GetWorld();
        _isReadOnly = true;
    }

    private async Task Save() {
        await WorldService.UpdateWorld(_world);
        _isReadOnly = true;
    }

    private void AddFact() {
        _selectedFact = new();
        _showFactDialog = true;
    }

    private void EditFact(FactData fact) {
        _selectedFact = fact;
        _showFactDialog = true;
    }

    private void SaveFact() {
        if (_selectedFact!.Id == 0) {
            _world.Facts.Add(_selectedFact);
        }
        CloseFactDialog();
    }
    private void CloseFactDialog() {
        _showFactDialog = false;
        _selectedFact = null;
    }

    private void RemoveFact(FactData fact) {
        _world.Facts.Remove(fact);
        _selectedFact = null;
    }

    private async Task OpenToolSelectionDialog() {
        _availableTools = await ToolsService.GetList();
        _toolSelectionBuffer = [.. _world.Tools];
        _showToolSelectionDialog = true;
    }

    private void CloseToolSelectionDialog() {
        _toolSelectionBuffer = [];
        _showToolSelectionDialog = false;
    }

    private void FinishToolSelection(List<ToolData> tools) {
        _world.Tools = tools;
        CloseToolSelectionDialog();
    }

    private void RemoveTool(ToolData tool)
        => _world.Tools.Remove(tool);
}
 
---------------------------------------------------------------------------------------- 
WebClient\Pages\Settings\ToolPage.razor 
@page "/Settings/Tool/{Action}/{ToolId:int?}"
@rendermode InteractiveWebAssembly

<div class="container">
  <div class="container-header d-flex flex-row justify-content-start align-content-center mb-3">
    <h3 class="mb-1 mt-1 me-4">@_action Tool</h3>
    @if (IsReadOnly) {
      <button type="button" class="btn btn-primary me-4" @onclick="EnableEdit">
        <i class="bi bi-pencil-square me-2"></i>Edit
      </button>
      <button type="button" class="btn btn-secondary" @onclick="GoBack" @onclick:preventDefault>
        <i class="bi bi-back me-2"></i>Back
      </button>
    }
    else {
      <button type="submit" class="btn btn-success me-4" form="tool-form">
        <i class="bi bi-save me-2"></i>Save
      </button>
      <button type="button" class="btn btn-secondary" @onclick="Cancel" @onclick:preventDefault>
        <i class="bi bi-x-circle me-2"></i>Cancel
      </button>
    }
  </div>

  <div class="container-body">
    <EditForm EditContext="_editContext" id="tool-form" OnValidSubmit="Save">
      <DataAnnotationsValidator />
      <ValidationMessage For="@(() => _tool)" />

      <div class="mb-3">
        <label for="toolName" class="form-label">Name</label>
        <InputText id="toolName" class="form-control" @bind-Value="_tool.Name" disabled="@(IsReadOnly)" />
        <ValidationMessage For="@(() => _tool.Name)" />
      </div>
      <div class="mb-3">
        <label for="toolDescription" class="form-label">Description</label>
        <InputTextArea id="toolDescription" class="form-control" @bind-Value="_tool.Description" disabled="@(IsReadOnly)" />
        <ValidationMessage For="@(() => _tool.Description)" />
      </div>

      <h4>Arguments</h4>
      <ValidationMessage For="@(() => _tool.Arguments)" />
      <div class="grid">
        <table class="table">
          <thead>
            <tr>
              <th>
                <button class="btn btn-primary" @onclick="Add" @onclick:preventDefault>
                  <i class="bi bi-plus-circle"></i>
                </button>
              </th>
              <th>Name</th>
              <th>Type</th>
              <th>Description</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            @foreach (var argument in _tool.Arguments) {
              <tr>
                <td>
                  <button class="btn btn-sm btn-primary" @onclick="() => Edit(argument)" @onclick:preventDefault>Edit</button>
                  <button class="btn btn-sm btn-danger" @onclick="() => Delete(argument)" @onclick:preventDefault>Delete</button>
                </td>
                <td>
                  <button class="btn btn-link" @onclick="() => View(argument)" @onclick:preventDefault>@argument.Name</button>
                </td>
                <td>@argument.Type</td>
                <td>@argument.Description</td>
                <td>
                  <button class="btn btn-sm btn-secondary" @onclick="() => MoveUp(argument)" @onclick:preventDefault>Up</button>
                  <button class="btn btn-sm btn-secondary" @onclick="() => MoveDown(argument)" @onclick:preventDefault>Down</button>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    </EditForm>
  </div>
</div>

@if (_showArgumentDialog) {
  <ArgumentDialog Argument="_selectedArgument"
                  Action="_argumentAction"
                  OnSave="SaveArgument"
                  OnCancel="CloseArgumentModal" />
}

@if (_showDeleteConfirmationDialog) {
  <ConfirmationDialog Message="Are you sure you want to delete this argument?"
                      OnConfirm="ExecuteDelete"
                      OnCancel="CancelDelete" />
}
 
---------------------------------------------------------------------------------------- 
WebClient\Pages\Settings\ToolsPage.razor 
@page "/Settings/Tools"
@rendermode InteractiveWebAssembly

<div class="container">
  <div class="container-header d-flex flex-row justify-content-start align-content-center mb-3">
    <h3 class="mb-1 mt-1 me-4">Tools Management</h3>
    <button class="btn btn-primary" @onclick="Add">
      <i class="bi bi-plus-lg me-2"></i>Add Tool
    </button>
  </div>

  <div class="container-body">
    @if (_tools.Count == 0) {
      <p>No tools found.</p>
    }
    else {
      <table class="table">
        <thead>
          <tr class="row">
            <th class="col-2"></th>
            <th class="col-3">Name</th>
            <th class="col">Description</th>
          </tr>
        </thead>
        <tbody>
          @foreach (var tool in _tools) {
            <tr class="row">
              <td class="col-2">
                <button class="btn btn-primary btn-sm" @onclick="() => Edit(tool)">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-danger btn-sm" @onclick="() => Delete(tool)">
                  <i class="bi bi-trash"></i>
                </button>
              </td>
              <td class="col-3">
                <a class="btn btn-link px-0" @onclick="() => View(tool)">
                  @tool.Name
                </a>
              </td>
              <td class="col">@tool.Description</td>
            </tr>
          }
        </tbody>
      </table>
    }
  </div>
</div>

@if (_showDeleteConfirmationDialog) {
  <ConfirmationDialog Message="Are you sure you want to delete this tool?"
                      OnConfirm="ExecuteDelete"
                      OnCancel="CancelDelete" />
}
 
---------------------------------------------------------------------------------------- 
WebClient\Pages\Settings\WorldPage.razor 
@page "/Settings/World"
@rendermode InteractiveWebAssembly

<div class="container">
  <div class="container-header d-flex flex-row justify-content-start align-content-center mb-3">
    <h3 class="mb-1 mt-1 me-4">World Settings</h3>
    @if (_isReadOnly) {
      <button type="button" class="btn btn-primary" @onclick="EnableEdit">
        <i class="bi bi-pencil-square me-2"></i>Edit
      </button>
    }
    else {
      <button type="submit" class="btn btn-success me-4" form="world-form">
        <i class="bi bi-save me-2"></i>Save
      </button>
      <button type="button" class="btn btn-secondary" @onclick="Cancel">
        <i class="bi bi-x-circle me-2"></i>Cancel
      </button>
    }
  </div>

  <div class="container-body">
    <EditForm Model="@_world" OnValidSubmit="Save">
      <DataAnnotationsValidator />
      <ValidationSummary />

      <div class="row mb-3">
        <div class="col">
          <label for="dateTime" class="form-label">Current Date & Time</label>
          <InputText id="dateTime" class="form-control" @bind-Value="_dateTime" readonly />
        </div>
      </div>

      <div class="row mb-3">
        <div class="col">
          <label for="location" class="form-label">Location</label>
          <InputText id="location" class="form-control" @bind-Value="_world.Location" disabled="@_isReadOnly" />
        </div>
      </div>

      <!-- User Profile -->
      <div class="row mb-3">
        <div class="col-12">
          <label class="form-label">User</label>
        </div>
        <div class="col-md-8">
          <label for="userName" class="form-label">Name</label>
          <InputText id="userName" class="form-control" @bind-Value="_world.UserProfile.Name" disabled="@_isReadOnly" />
        </div>
        <div class="col-md-4">
          <label for="userLanguage" class="form-label">Language</label>
          <InputText id="userLanguage" class="form-control" @bind-Value="_world.UserProfile.Language" disabled="@_isReadOnly" />
        </div>
      </div>

      <!-- Facts -->
      <div class="mb-3">
        <div class="row mb-2">
          <div class="col">
            @if (!_isReadOnly) {
              <button class="btn btn-sm btn-primary me-2" @onclick="AddFact" @onclick:preventDefault>
                <i class="bi bi-plus-circle"></i>
              </button>
            }
            <label class="form-label">Facts</label>
          </div>
        </div>
        <ValidationMessage For="@(() => _world.Facts)" />
        @foreach (var fact in _world.Facts) {
          <div class="row mb-2">
            <div class="col-md-1">
              @if (!_isReadOnly) {
                <button class="btn btn-sm btn-danger" @onclick="() => RemoveFact(fact)" @onclick:preventDefault>
                  <i class="bi bi-trash"></i>
                </button>
                <button class="btn btn-sm btn-primary" @onclick="() => EditFact(fact)" @onclick:preventDefault>
                  <i class="bi bi-pencil"></i>
                </button>
              }
            </div>
            <div class="col">
              <InputText class="form-control" @bind-Value="fact.Value" readonly />
            </div>
          </div>
        }
      </div>

      <!-- Available Tools -->
      <div class="row mb-3">
        <div class="col-12">
          <label class="form-label">Tools</label>
        </div>
        <div class="col-12">
          <div class="row">
            <div class="col-md-1">
              @if (!_isReadOnly) {
                <button class="btn btn-sm btn-primary" @onclick="OpenToolSelectionDialog" @onclick:preventDefault>
                  <i class="bi bi-plus-circle"></i>
                </button>
              }
              else {
                <button class="btn btn-sm btn-secondary" @onclick:preventDefault disabled>
                  <i class="bi bi-plus-circle"></i>
                </button>
              }
            </div>
            <div class="col-md-4">
              <label class="form-label">Name</label>
            </div>
            <div class="col-md-7">
              <label class="form-label">Description</label>
            </div>
          </div>
          @foreach (var tool in _world.Tools) {
            <div class="row mb-2">
              <div class="col-md-1">
                @if (!_isReadOnly) {
                  <button class="btn btn-sm btn-danger" @onclick="() => RemoveTool(tool)" @onclick:preventDefault>
                    <i class="bi bi-trash"></i>
                  </button>
                }
              </div>
              <div class="col-md-4">
                <InputText class="form-control" @bind-Value="tool.Name" disabled="@_isReadOnly" />
              </div>
              <div class="col-md-7">
                <InputText class="form-control" @bind-Value="tool.Description" disabled="@_isReadOnly" />
              </div>
            </div>
          }
        </div>
      </div>
    </EditForm>
  </div>
</div>

@if (_showFactDialog) {
  <FactDialog Fact="_selectedFact" Action="@(_selectedFact!.Id == 0 ? "Add" : "Edit")"
              OnSave="SaveFact" OnCancel="CloseFactDialog" />
}

@if (_showToolSelectionDialog) {
  <ToolSelectionDialog AvailableTools="_availableTools"
                       SelectedTools="_toolSelectionBuffer"
                       OnToolsSelected="FinishToolSelection"
                       OnCancel="CloseToolSelectionDialog" />
}
 
---------------------------------------------------------------------------------------- 
WebClient\Pages\Settings\ToolPage.razor.css 
 
---------------------------------------------------------------------------------------- 
WebClient\Pages\Settings\ToolsPage.razor.css 
 
---------------------------------------------------------------------------------------- 
WebClient\Pages\Settings\WorldPage.razor.css 
 
---------------------------------------------------------------------------------------- 
WebClient\Services\PersonasRemoteService.cs 
namespace Sophia.WebClient.Services;

public class PersonasRemoteService : IPersonasRemoteService {
    private readonly HttpClient _httpClient;

    public PersonasRemoteService(HttpClient httpClient) {
        _httpClient = httpClient;
    }

    public async Task<IReadOnlyList<PersonaData>> GetList(string? filter = null) {
        var list = await _httpClient.GetFromJsonAsync<PersonaData[]>("api/personas");
        return list!;
    }

    public async Task<PersonaData?> GetById(int id) {
        var persona = await _httpClient.GetFromJsonAsync<PersonaData>($"api/personas/{id}");
        return persona;
    }

    public async Task Add(PersonaData persona) {
        var response = await _httpClient.PostAsJsonAsync("api/personas", persona);
        response.EnsureSuccessStatusCode();
    }

    public async Task Update(PersonaData persona) {
        var response = await _httpClient.PutAsJsonAsync("api/personas", persona);
        response.EnsureSuccessStatusCode();
    }

    public async Task Delete(int id) {
        var response = await _httpClient.DeleteAsync($"api/personas/{id}");
        response.EnsureSuccessStatusCode();
    }
}
 
---------------------------------------------------------------------------------------- 
WebClient\Services\RemoteWorldService.cs 
namespace Sophia.WebClient.Services;

public class WorldRemoteService(HttpClient httpClient)
    : IWorldRemoteService {
    public Task<WorldData> GetWorld()
        => httpClient.GetFromJsonAsync<WorldData>("api/world")!;

    public async Task UpdateWorld(WorldData input) {
        var response = await httpClient.PutAsJsonAsync("api/world", input)!;
        response.EnsureSuccessStatusCode();
    }
}
 
---------------------------------------------------------------------------------------- 
WebClient\Services\ToolsRemoteService.cs 
namespace Sophia.WebClient.Services;

public class ToolsRemoteService(HttpClient httpClient)
    : IToolsRemoteService {
    public async Task<IReadOnlyList<ToolData>> GetList(string? filter = null) {
        var list = await httpClient.GetFromJsonAsync<ToolData[]>("api/tools");
        return list!;
    }

    public async Task<ToolData?> GetById(int id) {
        var tool = await httpClient.GetFromJsonAsync<ToolData>($"api/tools/{id}");
        return tool;
    }

    public async Task Add(ToolData input) {
        var response = await httpClient.PostAsJsonAsync("api/tools", input)!;
        response.EnsureSuccessStatusCode();
    }

    public async Task Update(ToolData input) {
        var response = await httpClient.PutAsJsonAsync("api/tools", input)!;
        response.EnsureSuccessStatusCode();
    }

    public async Task Delete(int id) {
        var response = await httpClient.DeleteAsync($"api/tools/{id}")!;
        response.EnsureSuccessStatusCode();
    }
}
 
